<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Group Evaluator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <!-- Firebase Authentication -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#10b981',
            accent: '#f59e0b',
            darkBg: '#0f172a',
            darkCard: '#1e293b',
            gold: '#FFD700',
            silver: '#C0C0C0',
            bronze: '#CD7F32'
          },
          animation: {
            'pulse-slow': 'pulse 3s linear infinite',
            'bounce-slow': 'bounce 2s infinite',
            'spin-slow': 'spin 3s linear infinite',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }
    
    .app-container {
      display: flex;
      height: 100vh;
    }
    
    .sidebar {
      width: 250px;
      flex-shrink: 0;
      height: 100%;
      overflow-y: auto;
    }
    
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }
    
    .page-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .card-hover {
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background-color: #e5e7eb;
    }
    
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease-in-out;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .rank-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: bold;
      color: white;
    }
    
    .rank-1 {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      box-shadow: 0 4px 6px rgba(255, 165, 0, 0.3);
    }
    
    .rank-2 {
      background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
      box-shadow: 0 4px 6px rgba(160, 160, 160, 0.3);
    }
    
    .rank-3 {
      background: linear-gradient(135deg, #CD7F32, #A56A3A);
      box-shadow: 0 4px 6px rgba(165, 106, 58, 0.3);
    }
    
    .rank-other {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
    }
    
    .group-bar {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .group-bar:hover {
      transform: translateX(5px);
      background-color: rgba(59, 130, 246, 0.05);
    }
    
    .group-bar.active {
      background-color: rgba(59, 130, 246, 0.1);
      border-left: 4px solid #3b82f6;
    }
    
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .dark .modal-content {
      background-color: #1e293b;
      color: white;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .task-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease;
    }
    
    .task-details.open {
      max-height: 1000px;
    }
    
    .expand-icon {
      transition: transform 0.3s ease;
    }
    
    .expand-icon.rotated {
      transform: rotate(180deg);
    }
    
    .crown-icon {
      font-size: 24px;
      margin-bottom: 10px;
    }
    
    .rank-card {
      position: relative;
      overflow: hidden;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .rank-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }
    
    .rank-1-card::before {
      background: linear-gradient(90deg, #FFD700, #FFA500);
    }
    
    .rank-2-card::before {
      background: linear-gradient(90deg, #C0C0C0, #A0A0A0);
    }
    
    .rank-3-card::before {
      background: linear-gradient(90deg, #CD7F32, #A56A3A);
    }
    
    .rank-card-glow {
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .rank-1-card {
      background: linear-gradient(135deg, #fff9e6, #fff0cc);
      border: 2px solid #FFD700;
    }
    
    .rank-2-card {
      background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
      border: 2px solid #C0C0C0;
    }
    
    .rank-3-card {
      background: linear-gradient(135deg, #f8f0e6, #f0e0cc);
      border: 2px solid #CD7F32;
    }
    
    .dark .rank-1-card {
      background: linear-gradient(135deg, #332900, #4d3d00);
      border: 2px solid #FFD700;
    }
    
    .dark .rank-2-card {
      background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
      border: 2px solid #C0C0C0;
    }
    
    .dark .rank-3-card {
      background: linear-gradient(135deg, #332200, #4d3300);
      border: 2px solid #CD7F32;
    }
    
    .rank-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .rank-1-title {
      color: #D4AF37;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .rank-2-title {
      color: #C0C0C0;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .rank-3-title {
      color: #CD7F32;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .member-role-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 5px;
    }
    
    .team-leader {
      background-color: #3b82f6;
      color: white;
    }
    
    .time-keeper {
      background-color: #10b981;
      color: white;
    }
    
    .reporter {
      background-color: #f59e0b;
      color: white;
    }
    
    .resource-manager {
      background-color: #8b5cf6;
      color: white;
    }
    
    .peace-maker {
      background-color: #ec4899;
      color: white;
    }
    
    .score-calculation-info {
      background: #f0f9ff;
      border-left: 4px solid #3b82f6;
      padding: 10px 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    
    .dark .score-calculation-info {
      background: #1e3a5f;
      border-left: 4px solid #60a5fa;
    }
    
    /* Advanced Loading Spinner */
    .advanced-loader {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 80px;
    }
    
    .advanced-loader div {
      position: absolute;
      border: 4px solid #3b82f6;
      opacity: 1;
      border-radius: 50%;
      animation: advanced-loader 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;
    }
    
    .advanced-loader div:nth-child(2) {
      animation-delay: -0.5s;
    }
    
    @keyframes advanced-loader {
      0% {
        top: 36px;
        left: 36px;
        width: 0;
        height: 0;
        opacity: 1;
      }
      100% {
        top: 0px;
        left: 0px;
        width: 72px;
        height: 72px;
        opacity: 0;
      }
    }
    
    /* Group Card Colors */
    .group-card-1 { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
    .group-card-2 { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
    .group-card-3 { background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); }
    .group-card-4 { background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%); }
    .group-card-5 { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
    .group-card-6 { background: linear-gradient(135deg, #a3bded 0%, #6991c7 100%); }
    .group-card-7 { background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%); }
    .group-card-8 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
    
    .dark .group-card-1 { background: linear-gradient(135deg, #4a2c00 0%, #7a3c1f 100%); }
    .dark .group-card-2 { background: linear-gradient(135deg, #1a3c7d 0%, #1c5d7a 100%); }
    .dark .group-card-3 { background: linear-gradient(135deg, #3a5a00 0%, #2a6a35 100%); }
    .dark .group-card-4 { background: linear-gradient(135deg, #7a2c6b 0%, #3a4a8a 100%); }
    .dark .group-card-5 { background: linear-gradient(135deg, #1a7a45 0%, #1a5a7a 100%); }
    .dark .group-card-6 { background: linear-gradient(135deg, #2a3c7a 0%, #1a3560 100%); }
    .dark .group-card-7 { background: linear-gradient(135deg, #7a3c2a 0%, #7a3a7a 100%); }
    .dark .group-card-8 { background: linear-gradient(135deg, #7a2a2a 0%, #7a3a6a 100%); }
    
    /* Typography for Group Serial */
    .group-serial {
      font-size: 4rem;
      font-weight: 900;
      opacity: 0.2;
      position: absolute;
      top: 10px;
      right: 20px;
      line-height: 1;
    }
    
    /* Search Bar */
    .search-container {
      position: relative;
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #6b7280;
    }
    
    .search-input {
      padding-left: 40px;
    }
    
    /* Tab Styles */
    .tab-container {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 1rem;
    }
    
    .tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }
    
    .tab.active {
      border-bottom-color: #3b82f6;
      color: #3b82f6;
      font-weight: 600;
    }
    
    /* Comment Section */
    .comment-section {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px dashed #d1d5db;
    }
    
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        max-height: 200px;
      }
      
      .main-content {
        height: calc(100vh - 200px);
      }
      
      .mobile-menu-btn {
        display: block;
      }
      
      .sidebar.hidden-mobile {
        display: none;
      }
      
      .sidebar.active-mobile {
        display: block;
      }
      
      .group-serial {
        font-size: 3rem;
        top: 5px;
        right: 15px;
      }
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-darkBg text-gray-800 dark:text-gray-200 transition-colors duration-300">

  <!-- Authentication Modal -->
  <div id="authModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-4 text-center">লগইন করুন</h3>
      <div id="loginForm">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">ইমেইল</label>
          <input id="loginEmail" type="email" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="আপনার ইমেইল লিখুন">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">পাসওয়ার্ড</label>
          <input id="loginPassword" type="password" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="আপনার পাসওয়ার্ড লিখুন">
        </div>
        <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">লগইন</button>
        <p class="text-center mt-4 text-sm text-gray-600 dark:text-gray-400">
          অ্যাডমিন অ্যাকাউন্ট নেই? <button id="showRegister" class="text-blue-600 hover:underline">রেজিস্টার করুন</button>
        </p>
      </div>
      
      <div id="registerForm" class="hidden">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">ইমেইল</label>
          <input id="registerEmail" type="email" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="আপনার ইমেইল লিখুন">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">পাসওয়ার্ড</label>
          <input id="registerPassword" type="password" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="পাসওয়ার্ড লিখুন (ন্যূনতম ৬ অক্ষর)">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">অ্যাডমিন টাইপ</label>
          <select id="adminType" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="admin">সাধারণ অ্যাডমিন</option>
            <option value="super-admin">সুপার অ্যাডমিন</option>
          </select>
        </div>
        <button id="registerBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition-colors">রেজিস্টার</button>
        <p class="text-center mt-4 text-sm text-gray-600 dark:text-gray-400">
          ইতিমধ্যে অ্যাকাউন্ট আছে? <button id="showLogin" class="text-blue-600 hover:underline">লগইন করুন</button>
        </p>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-4">ডিলিট নিশ্চিতকরণ</h3>
      <p id="deleteModalText">আপনি কি নিশ্চিত যে আপনি এই আইটেমটি ডিলিট করতে চান?</p>
      <div class="modal-buttons">
        <button id="cancelDelete" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded-lg">বাতিল</button>
        <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg">ডিলিট</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3 id="editModalTitle" class="text-lg font-semibold mb-4">সম্পাদনা করুন</h3>
      <div id="editModalContent">
        <!-- Content will be dynamically added here -->
      </div>
      <div class="modal-buttons">
        <button id="cancelEdit" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded-lg">বাতিল</button>
        <button id="saveEdit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">সংরক্ষণ করুন</button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="modal" style="display: none;">
    <div class="modal-content flex flex-col items-center justify-center">
      <div class="advanced-loader">
        <div></div>
        <div></div>
      </div>
      <p class="mt-4">লোড হচ্ছে...</p>
    </div>
  </div>

  <!-- Main App (hidden until authenticated) -->
  <div id="appContainer" class="app-container hidden">
    <!-- Sidebar -->
    <aside class="sidebar bg-white dark:bg-darkCard border-r border-gray-200 dark:border-gray-700">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <h1 class="text-xl font-bold text-primary dark:text-blue-400 flex items-center">
          <i class="fas fa-users mr-2"></i> Smart Evaluator
        </h1>
        <div id="userInfo" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></div>
      </div>
      
      <nav class="p-4 space-y-2">
        <button data-page="dashboard" class="nav-btn w-full text-left px-3 py-3 rounded-lg flex items-center transition-colors bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">
          <i class="fas fa-tachometer-alt mr-3"></i> ড্যাশবোর্ড
        </button>
        <button data-page="groups" class="nav-btn w-full text-left px-3 py-3 rounded-lg flex items-center transition-colors hover:bg-gray-100 dark:hover:bg-gray-700">
          <i class="fas fa-users mr-3"></i> গ্রুপ ব্যবস্থাপনা
        </button>
        <button data-page="members" class="nav-btn w-full text-left px-3 py-3 rounded-lg flex items-center transition-colors hover:bg-gray-100 dark:hover:bg-gray-700">
          <i class="fas fa-user-graduate mr-3"></i> শিক্ষার্থী ব্যবস্থাপনা
        </button>
        <button data-page="group-members" class="nav-btn w-full text-left px-3 py-3 rounded-lg flex items-center transition-colors hover:bg-gray-100 dark:hover:bg-gray-700">
          <i class="fas fa-user-friends mr-3"></i> গ্রুপ সদস্য ব্যবস্থাপনা
        </button>
        <button data-page="tasks" class="nav-btn w-full text-left px-3 py-3 rounded-lg flex items-center transition-colors hover:bg-gray-100 dark:hover:bg-gray-700">
          <i class="fas fa-tasks mr-3"></i> টাস্ক ব্যবস্থাপনা
        </button>
        <button data-page="evaluation" class="nav-btn w-full text-left px-3 py-3 rounded-lg flex items-center transition-colors hover:bg-gray-100 dark:hover:bg-gray-700">
          <i class="fas fa-clipboard-check mr-3"></i> মূল্যায়ন
        </button>
        <button data-page="export" class="nav-btn w-full text-left px-3 py-3 rounded-lg flex items-center transition-colors hover:bg-gray-100 dark:hover:bg-gray-700">
          <i class="fas fa-file-export mr-3"></i> এক্সপোর্ট
        </button>
        
        <!-- Admin Management (Only for Super Admin) -->
        <div id="adminManagementSection" class="hidden">
          <button data-page="admin-management" class="nav-btn w-full text-left px-3 py-3 rounded-lg flex items-center transition-colors hover:bg-gray-100 dark:hover:bg-gray-700">
            <i class="fas fa-user-shield mr-3"></i> অ্যাডমিন ব্যবস্থাপনা
          </button>
        </div>
      </nav>
      
      <div class="absolute bottom-0 w-full p-4 border-t border-gray-200 dark:border-gray-700">
        <div class="flex justify-between items-center">
          <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700">
            <i class="fas fa-moon"></i>
          </button>
          <button id="logoutBtn" class="text-sm text-red-600 hover:text-red-800">লগআউট</button>
          <span class="text-sm text-gray-500">v2.3</span>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <header class="bg-white dark:bg-darkCard border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center">
        <h2 id="pageTitle" class="text-xl font-bold">ড্যাশবোর্ড</h2>
        <button id="mobileMenuBtn" class="mobile-menu-btn p-2 rounded-lg bg-gray-100 dark:bg-gray-800 lg:hidden">
          <i class="fas fa-bars"></i>
        </button>
      </header>
      
      <!-- Page Content -->
      <div class="page-content">
        <!-- Dashboard Page -->
        <section id="page-dashboard" class="page fade-in">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-2">ড্যাশবোর্ড</h2>
            <p class="text-gray-600 dark:text-gray-400">গ্রুপ মূল্যায়ন সিস্টেমের সংক্ষিপ্ত তথ্য</p>
            
            <!-- স্কোর ক্যালকুলেশন তথ্য -->
            <div class="score-calculation-info mt-4">
              <p class="text-sm flex items-center">
                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                <strong>স্কোর ক্যালকুলেশন পদ্ধতি:</strong> একাধিক টাস্কের ক্ষেত্রে মোট স্কোর = (মোট টাস্ক স্কোর/মোট সম্ভাব্য টাস্ক স্কোর + মোট টিম স্কোর/মোট সম্ভাব্য টিম স্কোর) ÷ 2 × 50
              </p>
            </div>
          </div>
          
          <!-- Top 3 Groups in Circular Progress -->
          <div class="mb-8">
            <h3 class="text-lg font-semibold mb-4">শীর্ষ গ্রুপসমূহ</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="topGroupsContainer">
              <!-- Top groups will be dynamically added here -->
            </div>
          </div>
          
          <!-- All Groups Ranking List -->
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
            <h3 class="text-lg font-semibold mb-4">গ্রুপ র‌্যাঙ্কিং</h3>
            <div id="groupsRankingList" class="space-y-3">
              <!-- Groups ranking will be dynamically added here -->
            </div>
          </div>

          <!-- Group Details Section -->
          <div id="groupDetails" class="mt-8 hidden">
            <!-- Group details will be dynamically added here -->
          </div>
        </section>
        
        <!-- Groups Page -->
        <section id="page-groups" class="page hidden">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-2">গ্রুপ ব্যবস্থাপনা</h2>
            <p class="text-gray-600 dark:text-gray-400">গ্রুপ যোগ, সম্পাদনা এবং ব্যবস্থাপনা করুন</p>
          </div>
          
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5 mb-6">
            <h3 class="text-lg font-semibold mb-4">নতুন গ্রুপ যোগ করুন</h3>
            <div class="flex gap-3">
              <input id="groupNameInput" type="text" placeholder="গ্রুপের নাম লিখুন" class="flex-1 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <button id="addGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                <i class="fas fa-plus mr-2"></i> যোগ করুন
              </button>
            </div>
          </div>
          
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
            <h3 class="text-lg font-semibold mb-4">গ্রুপ তালিকা</h3>
            <div class="search-container mb-4">
              <i class="fas fa-search search-icon"></i>
              <input id="groupSearch" type="text" placeholder="গ্রুপ খুঁজুন..." class="search-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div id="groupsList" class="space-y-3">
              <!-- Groups will be dynamically added here -->
            </div>
          </div>
        </section>
        
        <!-- Members Page -->
        <section id="page-members" class="page hidden">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-2">শিক্ষার্থী ব্যবস্থাপনা</h2>
            <p class="text-gray-600 dark:text-gray-400">শিক্ষার্থীদের তথ্য যোগ, সম্পাদনা এবং ব্যবস্থাপনা করুন</p>
          </div>
          
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5 mb-6">
            <h3 class="text-lg font-semibold mb-4">নতুন শিক্ষার্থী যোগ করুন</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium mb-2">নাম</label>
                <input id="memberNameInput" type="text" placeholder="শিক্ষার্থীর নাম" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">রোল নম্বর</label>
                <input id="memberRollInput" type="text" placeholder="রোল নম্বর" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">বিভাগ</label>
                <input id="memberDeptInput" type="text" placeholder="বিভাগ" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">ইমেইল</label>
                <input id="memberEmailInput" type="email" placeholder="ইমেইল" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
            </div>
            <button id="addMemberBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
              <i class="fas fa-plus mr-2"></i> শিক্ষার্থী যোগ করুন
            </button>
          </div>
          
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
            <h3 class="text-lg font-semibold mb-4">শিক্ষার্থী তালিকা</h3>
            <div class="search-container mb-4">
              <i class="fas fa-search search-icon"></i>
              <input id="memberSearch" type="text" placeholder="শিক্ষার্থী খুঁজুন..." class="search-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="flex space-x-2 mb-4">
              <button id="filterAll" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm">সকল</button>
              <button id="filterDept" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md text-sm">বিভাগ অনুযায়ী</button>
            </div>
            <div id="membersList" class="space-y-3">
              <!-- Members will be dynamically added here -->
            </div>
          </div>
        </section>
        
        <!-- Group Members Page -->
        <section id="page-group-members" class="page hidden">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-2">গ্রুপ সদস্য ব্যবস্থাপনা</h2>
            <p class="text-gray-600 dark:text-gray-400">গ্রুপে সদস্য যোগ, সম্পাদনা এবং ব্যবস্থাপনা করুন</p>
          </div>
          
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5 mb-6">
            <h3 class="text-lg font-semibold mb-4">গ্রুপ নির্বাচন করুন</h3>
            <select id="groupMemberSelect" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4">
              <option value="">একটি গ্রুপ নির্বাচন করুন</option>
            </select>
            
            <div id="groupMemberForm" class="hidden">
              <h4 class="font-medium mb-3">সদস্য নির্বাচন করুন</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="block text-sm font-medium mb-2">টিম লিডার</label>
                  <select class="member-select w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" data-role="team-leader">
                    <option value="">টিম লিডার নির্বাচন করুন</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">টাইম কিপার</label>
                  <select class="member-select w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" data-role="time-keeper">
                    <option value="">টাইম কিপার নির্বাচন করুন</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">রিপোর্টার</label>
                  <select class="member-select w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" data-role="reporter">
                    <option value="">রিপোর্টার নির্বাচন করুন</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">রিসোর্স ম্যানেজার</label>
                  <select class="member-select w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" data-role="resource-manager">
                    <option value="">রিসোর্স ম্যানেজার নির্বাচন করুন</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">পিস মেকার</label>
                  <select class="member-select w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" data-role="peace-maker">
                    <option value="">পিস মেকার নির্বাচন করুন</option>
                  </select>
                </div>
              </div>
              <button id="saveGroupMembersBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                <i class="fas fa-save mr-2"></i> সদস্য সংরক্ষণ করুন
              </button>
            </div>
          </div>
          
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
            <h3 class="text-lg font-semibold mb-4">গ্রুপ সদস্য তালিকা</h3>
            <div class="search-container mb-4">
              <i class="fas fa-search search-icon"></i>
              <input id="groupMemberSearch" type="text" placeholder="গ্রুপ খুঁজুন..." class="search-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div id="groupMembersList" class="space-y-4">
              <!-- Group members will be dynamically added here -->
            </div>
          </div>
        </section>
        
        <!-- Tasks Page -->
        <section id="page-tasks" class="page hidden">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-2">টাস্ক ব্যবস্থাপনা</h2>
            <p class="text-gray-600 dark:text-gray-400">টাস্ক যোগ, সম্পাদনা এবং ব্যবস্থাপনা করুন</p>
          </div>
          
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5 mb-6">
            <h3 class="text-lg font-semibold mb-4">নতুন টাস্ক যোগ করুন</h3>
            <div class="flex gap-3">
              <input id="taskNameInput" type="text" placeholder="টাস্কের নাম লিখুন" class="flex-1 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <button id="addTaskBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                <i class="fas fa-plus mr-2"></i> যোগ করুন
              </button>
            </div>
          </div>
          
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
            <h3 class="text-lg font-semibold mb-4">টাস্ক তালিকা</h3>
            <div id="tasksList" class="space-y-3">
              <!-- Tasks will be dynamically added here -->
            </div>
          </div>
        </section>
        
        <!-- Evaluation Page -->
        <section id="page-evaluation" class="page hidden">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-2">মূল্যায়ন</h2>
            <p class="text-gray-600 dark:text-gray-400">গ্রুপ এবং টাস্ক নির্বাচন করে মূল্যায়ন করুন</p>
          </div>
          
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium mb-2">গ্রুপ নির্বাচন করুন</label>
                <select id="evalGroupSelect" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="">একটি গ্রুপ নির্বাচন করুন</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">টাস্ক নির্বাচন করুন</label>
                <select id="evalTaskSelect" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="">একটি টাস্ক নির্বাচন করুন</option>
                </select>
              </div>
            </div>
          </div>
          
          <div id="evaluationForm" class="hidden">
            <!-- Evaluation form will be dynamically generated here -->
          </div>
        </section>
        
        <!-- All Groups Page -->
        <section id="page-all-groups" class="page hidden">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-2">সকল গ্রুপ তালিকা</h2>
            <p class="text-gray-600 dark:text-gray-400">সমস্ত গ্রুপের বিস্তারিত তথ্য</p>
          </div>
          
          <div class="tab-container">
            <div class="tab active" data-tab="all">সকল গ্রুপ</div>
            <div class="tab" data-tab="active">সক্রিয় গ্রুপ</div>
            <div class="tab" data-tab="inactive">নিষ্ক্রিয় গ্রুপ</div>
          </div>
          
          <div class="search-container mb-4">
            <i class="fas fa-search search-icon"></i>
            <input id="allGroupsSearch" type="text" placeholder="গ্রুপ খুঁজুন..." class="search-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          
          <div id="allGroupsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- All groups will be dynamically added here -->
          </div>
        </section>
        
        <!-- Admin Management Page -->
        <section id="page-admin-management" class="page hidden">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-2">অ্যাডমিন ব্যবস্থাপনা</h2>
            <p class="text-gray-600 dark:text-gray-400">অ্যাডমিন অ্যাকাউন্ট ব্যবস্থাপনা করুন</p>
          </div>
          
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5 mb-6">
            <h3 class="text-lg font-semibold mb-4">নতুন অ্যাডমিন যোগ করুন</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium mb-2">ইমেইল</label>
                <input id="newAdminEmail" type="email" placeholder="অ্যাডমিন ইমেইল" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">অ্যাডমিন টাইপ</label>
                <select id="newAdminType" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="admin">সাধারণ অ্যাডমিন</option>
                  <option value="super-admin">সুপার অ্যাডমিন</option>
                </select>
              </div>
            </div>
            <button id="addAdminBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
              <i class="fas fa-plus mr-2"></i> অ্যাডমিন যোগ করুন
            </button>
          </div>
          
          <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
            <h3 class="text-lg font-semibold mb-4">অ্যাডমিন তালিকা</h3>
            <div id="adminList" class="space-y-3">
              <!-- Admins will be dynamically added here -->
            </div>
          </div>
        </section>
        
        <!-- Export Page -->
        <section id="page-export" class="page hidden">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-2">এক্সপোর্ট ও রিসেট</h2>
            <p class="text-gray-600 dark:text-gray-400">ডেটা এক্সপোর্ট করুন অথবা সিস্টেম রিসেট করুন</p>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
              <h3 class="text-lg font-semibold mb-4">ডেটা এক্সপোর্ট</h3>
              <p class="text-gray-600 dark:text-gray-400 mb-4">সম্পূর্ণ মূল্যায়ন ডেটা CSV ফরম্যাটে ডাউনলোড করুন</p>
              <button id="exportDataBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors flex items-center justify-center">
                <i class="fas fa-file-export mr-2"></i> CSV এক্সপোর্ট করুন
              </button>
            </div>
            
            <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
              <h3 class="text-lg font-semibold mb-4">সিস্টেম রিসেট</h3>
              <p class="text-gray-600 dark:text-gray-400 mb-4">সকল ডেটা মুছে ফেলুন এবং সিস্টেম পুনরায় শুরু করুন</p>
              <button id="resetDataBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition-colors flex items-center justify-center">
                <i class="fas fa-trash-alt mr-2"></i> সমস্ত ডেটা রিসেট করুন
              </button>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

 <script>
// Firebase Configuration and Initialization
const firebaseConfig = {
    apiKey: "AIzaSyAkw1kL7AU73Y9FWrPZ-ERv5xFvXGGILBA",
    authDomain: "claritybudget-6lnmd.firebaseapp.com",
    projectId: "claritybudget-6lnmd",
    storageBucket: "claritybudget-6lnmd.firebasestorage.app",
    messagingSenderId: "40318182466",
    appId: "1:40318182466:web:c2ce0637f8f23afa95b9db"
  };
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// App State
const state = {
  currentUser: null,
  userRole: null,
  groups: [],
  tasks: [],
  members: [],
  groupMembers: {},
  scores: {},
  currentPage: 'dashboard',
  selectedGroup: null,
  deletePending: { type: null, index: null, name: null },
  editPending: { type: null, index: null, data: null },
  admins: []
};

// DOM Elements
const elements = {
  // Authentication
  authModal: document.getElementById('authModal'),
  loginForm: document.getElementById('loginForm'),
  registerForm: document.getElementById('registerForm'),
  loginEmail: document.getElementById('loginEmail'),
  loginPassword: document.getElementById('loginPassword'),
  loginBtn: document.getElementById('loginBtn'),
  registerEmail: document.getElementById('registerEmail'),
  registerPassword: document.getElementById('registerPassword'),
  adminType: document.getElementById('adminType'),
  registerBtn: document.getElementById('registerBtn'),
  showRegister: document.getElementById('showRegister'),
  showLogin: document.getElementById('showLogin'),
  logoutBtn: document.getElementById('logoutBtn'),
  userInfo: document.getElementById('userInfo'),
  appContainer: document.getElementById('appContainer'),
  adminManagementSection: document.getElementById('adminManagementSection'),
  
  // Pages
  pages: document.querySelectorAll('.page'),
  pageTitle: document.getElementById('pageTitle'),
  
  // Dashboard
  topGroupsContainer: document.getElementById('topGroupsContainer'),
  groupsRankingList: document.getElementById('groupsRankingList'),
  groupDetails: document.getElementById('groupDetails'),
  
  // Groups
  groupNameInput: document.getElementById('groupNameInput'),
  addGroupBtn: document.getElementById('addGroupBtn'),
  groupsList: document.getElementById('groupsList'),
  groupSearch: document.getElementById('groupSearch'),
  
  // Members
  memberNameInput: document.getElementById('memberNameInput'),
  memberRollInput: document.getElementById('memberRollInput'),
  memberDeptInput: document.getElementById('memberDeptInput'),
  memberEmailInput: document.getElementById('memberEmailInput'),
  addMemberBtn: document.getElementById('addMemberBtn'),
  membersList: document.getElementById('membersList'),
  memberSearch: document.getElementById('memberSearch'),
  filterAll: document.getElementById('filterAll'),
  filterDept: document.getElementById('filterDept'),
  
  // Group Members
  groupMemberSelect: document.getElementById('groupMemberSelect'),
  groupMemberForm: document.getElementById('groupMemberForm'),
  saveGroupMembersBtn: document.getElementById('saveGroupMembersBtn'),
  groupMembersList: document.getElementById('groupMembersList'),
  groupMemberSearch: document.getElementById('groupMemberSearch'),
  
  // Tasks
  taskNameInput: document.getElementById('taskNameInput'),
  addTaskBtn: document.getElementById('addTaskBtn'),
  tasksList: document.getElementById('tasksList'),
  
  // Evaluation
  evalGroupSelect: document.getElementById('evalGroupSelect'),
  evalTaskSelect: document.getElementById('evalTaskSelect'),
  evaluationForm: document.getElementById('evaluationForm'),
  
  // All Groups
  allGroupsContainer: document.getElementById('allGroupsContainer'),
  allGroupsSearch: document.getElementById('allGroupsSearch'),
  
  // Admin Management
  newAdminEmail: document.getElementById('newAdminEmail'),
  newAdminType: document.getElementById('newAdminType'),
  addAdminBtn: document.getElementById('addAdminBtn'),
  adminList: document.getElementById('adminList'),
  
  // Export
  exportDataBtn: document.getElementById('exportDataBtn'),
  resetDataBtn: document.getElementById('resetDataBtn'),
  
  // Theme
  themeToggle: document.getElementById('themeToggle'),
  
  // Mobile Menu
  mobileMenuBtn: document.getElementById('mobileMenuBtn'),
  sidebar: document.querySelector('.sidebar'),
  
  // Modals
  deleteModal: document.getElementById('deleteModal'),
  deleteModalText: document.getElementById('deleteModalText'),
  cancelDelete: document.getElementById('cancelDelete'),
  confirmDelete: document.getElementById('confirmDelete'),
  editModal: document.getElementById('editModal'),
  editModalTitle: document.getElementById('editModalTitle'),
  editModalContent: document.getElementById('editModalContent'),
  cancelEdit: document.getElementById('cancelEdit'),
  saveEdit: document.getElementById('saveEdit'),
  loadingOverlay: document.getElementById('loadingOverlay')
};

// Utility Functions
const utils = {
  // Show loading indicator
  showLoading: () => {
    elements.loadingOverlay.style.display = 'flex';
  },
  
  // Hide loading indicator
  hideLoading: () => {
    setTimeout(() => {
      elements.loadingOverlay.style.display = 'none';
    }, 500);
  },
  
  // Show modal with message
  showModal: (modal) => {
    modal.style.display = 'flex';
  },
  
  // Hide modal
  hideModal: (modal) => {
    modal.style.display = 'none';
  },
  
  // Generate unique key for group-task combination
  generateKey: (group, task) => `${group}::${task}`,
  
  // Calculate average of array
  average: (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0,
  
  // Update circular progress indicator
  updateCircleProgress: (circle, percentage, color) => {
    if (!circle) return;
    
    const circumference = 2 * Math.PI * 15.9155;
    const offset = circumference - (percentage / 100) * circumference;
    circle.setAttribute('stroke-dasharray', `${circumference} ${circumference}`);
    circle.setAttribute('stroke-dashoffset', offset);
    circle.setAttribute('stroke', color);
    
    // Update text
    const text = circle.parentElement.querySelector('text');
    if (text) {
      text.textContent = `${percentage.toFixed(1)}%`;
      text.setAttribute('fill', color);
    }
  },
  
  // Calculate group performance based on CORRECT method for multiple tasks
  calculateGroupPerformance: (groupName) => {
    let totalTaskScore = 0;
    let totalTeamScore = 0;
    let maxPossibleTask = 0;
    let maxPossibleTeam = 0;
    let taskDetails = [];
    let evaluatedTasksCount = 0;
    
    state.tasks.forEach(task => {
      const key = utils.generateKey(groupName, task);
      if (state.scores[key]) {
        const taskScore = Object.values(state.scores[key].task || {}).reduce((a, b) => a + b, 0);
        const teamScore = Object.values(state.scores[key].team || {}).reduce((a, b) => a + b, 0);
        
        totalTaskScore += taskScore;
        totalTeamScore += teamScore;
        maxPossibleTask += 30;  // প্রতিটি টাস্কের জন্য ম্যাক্স 30
        maxPossibleTeam += 20;  // প্রতিটি টাস্কের জন্য ম্যাক্স 20
        evaluatedTasksCount++;
        
        // ডিটেইলস স্টোর করার জন্য
        taskDetails.push({
          taskName: task,
          taskScore: taskScore,
          teamScore: teamScore,
          totalScore: taskScore + teamScore,
          taskDetails: state.scores[key].task || {},
          teamDetails: state.scores[key].team || {},
          comment: state.scores[key].comment || ''
        });
      }
    });
    
    // পার্সেন্টেজ ক্যালকুলেশন - সঠিক পদ্ধতি
    const taskPercentage = maxPossibleTask > 0 ? (totalTaskScore / maxPossibleTask) * 100 : 0;
    const teamPercentage = maxPossibleTeam > 0 ? (totalTeamScore / maxPossibleTeam) * 100 : 0;
    const finalPercentage = evaluatedTasksCount > 0 ? (taskPercentage + teamPercentage) / 2 : 0;
    
    // 50-এ কনভার্ট করার জন্য
    const totalScoreOutOf50 = (finalPercentage / 100) * 50;
    
    return {
      taskPerformance: taskPercentage,
      teamPerformance: teamPercentage,
      finalPerformance: finalPercentage,
      totalScore: totalScoreOutOf50,  // ০-৫০ স্কেলে
      totalTaskScore: totalTaskScore,
      totalTeamScore: totalTeamScore,
      maxPossibleTask: maxPossibleTask,
      maxPossibleTeam: maxPossibleTeam,
      evaluatedTasksCount: evaluatedTasksCount,
      taskDetails: taskDetails
    };
  },
  
  // Get all groups with their performance data
  getAllGroupsPerformance: () => {
    const groupsPerformance = [];
    
    state.groups.forEach(group => {
      const performance = utils.calculateGroupPerformance(group);
      groupsPerformance.push({
        name: group,
        ...performance
      });
    });
    
    // Sort by total score (descending)
    return groupsPerformance.sort((a, b) => b.totalScore - a.totalScore);
  },
  
  // Get member by ID
  getMemberById: (id) => {
    return state.members.find(member => member.id === id);
  },
  
  // Get role name in Bengali
  getRoleName: (role) => {
    const roleNames = {
      'team-leader': 'টিম লিডার',
      'time-keeper': 'টাইম কিপার',
      'reporter': 'রিপোর্টার',
      'resource-manager': 'রিসোর্স ম্যানেজার',
      'peace-maker': 'পিস মেকার'
    };
    return roleNames[role] || role;
  },
  
  // Check if member already exists in any group
  isMemberAlreadyAssigned: (memberId) => {
    for (const groupName in state.groupMembers) {
      const group = state.groupMembers[groupName];
      for (const role in group) {
        if (group[role] === memberId) {
          return true;
        }
      }
    }
    return false;
  },
  
  // Get group color class based on index
  getGroupColorClass: (index) => {
    const colors = [
      'group-card-1', 'group-card-2', 'group-card-3', 'group-card-4',
      'group-card-5', 'group-card-6', 'group-card-7', 'group-card-8'
    ];
    return colors[index % colors.length];
  },
  
  // Filter data based on search term
  filterData: (data, searchTerm, fields) => {
    if (!searchTerm) return data;
    
    return data.filter(item => {
      return fields.some(field => {
        const value = item[field] ? item[field].toString().toLowerCase() : '';
        return value.includes(searchTerm.toLowerCase());
      });
    });
  },
  
  // Check if member with same roll and department already exists
  isDuplicateMember: (roll, dept) => {
    return state.members.some(member => 
      member.roll === roll && member.dept === dept
    );
  },
  
  // Get available members for group assignment
  getAvailableMembers: () => {
    return state.members.filter(member => !utils.isMemberAlreadyAssigned(member.id));
  }
};

// Firebase Database Functions
const dbFunctions = {
  // Load all data from Firestore
  loadAllData: async () => {
    try {
      utils.showLoading();
      
      // Load groups
      const groupsSnapshot = await db.collection('groups').get();
      state.groups = groupsSnapshot.docs.map(doc => doc.data().name);
      
      // Load tasks
      const tasksSnapshot = await db.collection('tasks').get();
      state.tasks = tasksSnapshot.docs.map(doc => doc.data().name);
      
      // Load members
      const membersSnapshot = await db.collection('members').get();
      state.members = membersSnapshot.docs.map(doc => doc.data());
      
      // Load group members
      const groupMembersSnapshot = await db.collection('groupMembers').get();
      state.groupMembers = {};
      groupMembersSnapshot.forEach(doc => {
        state.groupMembers[doc.id] = doc.data();
      });
      
      // Load scores
      const scoresSnapshot = await db.collection('scores').get();
      state.scores = {};
      scoresSnapshot.forEach(doc => {
        state.scores[doc.id] = doc.data();
      });
      
      // Load admins (only for super admin)
      if (state.userRole === 'super-admin') {
        const adminsSnapshot = await db.collection('admins').get();
        state.admins = adminsSnapshot.docs.map(doc => {
          const data = doc.data();
          return { id: doc.id, ...data };
        });
      }
      
      utils.hideLoading();
    } catch (error) {
      console.error('Error loading data:', error);
      utils.hideLoading();
    }
  },
  
  // Save groups to Firestore
  saveGroups: async () => {
    try {
      // Clear existing groups
      const groupsSnapshot = await db.collection('groups').get();
      const batch = db.batch();
      groupsSnapshot.docs.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();
      
      // Add new groups
      state.groups.forEach(async (group) => {
        await db.collection('groups').add({ name: group });
      });
    } catch (error) {
      console.error('Error saving groups:', error);
    }
  },
  
  // Save tasks to Firestore
  saveTasks: async () => {
    try {
      // Clear existing tasks
      const tasksSnapshot = await db.collection('tasks').get();
      const batch = db.batch();
      tasksSnapshot.docs.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();
      
      // Add new tasks
      state.tasks.forEach(async (task) => {
        await db.collection('tasks').add({ name: task });
      });
    } catch (error) {
      console.error('Error saving tasks:', error);
    }
  },
  
  // Save members to Firestore
  saveMembers: async () => {
    try {
      // Clear existing members
      const membersSnapshot = await db.collection('members').get();
      const batch = db.batch();
      membersSnapshot.docs.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();
      
      // Add new members
      state.members.forEach(async (member) => {
        await db.collection('members').add(member);
      });
    } catch (error) {
      console.error('Error saving members:', error);
    }
  },
  
  // Save group members to Firestore
  saveGroupMembers: async () => {
    try {
      // Clear existing group members
      const groupMembersSnapshot = await db.collection('groupMembers').get();
      const batch = db.batch();
      groupMembersSnapshot.docs.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();
      
      // Add new group members
      for (const groupName in state.groupMembers) {
        await db.collection('groupMembers').doc(groupName).set(state.groupMembers[groupName]);
      }
    } catch (error) {
      console.error('Error saving group members:', error);
    }
  },
  
  // Save scores to Firestore
  saveScores: async () => {
    try {
      // Clear existing scores
      const scoresSnapshot = await db.collection('scores').get();
      const batch = db.batch();
      scoresSnapshot.docs.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();
      
      // Add new scores
      for (const key in state.scores) {
        await db.collection('scores').doc(key).set(state.scores[key]);
      }
    } catch (error) {
      console.error('Error saving scores:', error);
    }
  },
  
  // Save admins to Firestore
  saveAdmins: async () => {
    try {
      // Clear existing admins
      const adminsSnapshot = await db.collection('admins').get();
      const batch = db.batch();
      adminsSnapshot.docs.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();
      
      // Add new admins
      state.admins.forEach(async (admin) => {
        await db.collection('admins').doc(admin.id).set({
          email: admin.email,
          role: admin.role
        });
      });
    } catch (error) {
      console.error('Error saving admins:', error);
    }
  }
};

// Render Functions
const render = {
  // Show specific page
  showPage: (pageId) => {
    // Show loading
    utils.showLoading();
    
    // Hide all pages
    elements.pages.forEach(page => page.classList.add('hidden'));
    
    // Show selected page
    const targetPage = document.getElementById(`page-${pageId}`);
    if (targetPage) {
      targetPage.classList.remove('hidden');
      targetPage.classList.add('fade-in');
      
      // Update page title
      const pageTitles = {
        'dashboard': 'ড্যাশবোর্ড',
        'groups': 'গ্রুপ ব্যবস্থাপনা',
        'members': 'শিক্ষার্থী ব্যবস্থাপনা',
        'group-members': 'গ্রুপ সদস্য ব্যবস্থাপনা',
        'tasks': 'টাস্ক ব্যবস্থাপনা',
        'evaluation': 'মূল্যায়ন',
        'all-groups': 'সকল গ্রুপ তালিকা',
        'admin-management': 'অ্যাডমিন ব্যবস্থাপনা',
        'export': 'এক্সপোর্ট ও রিসেট'
      };
      elements.pageTitle.textContent = pageTitles[pageId] || 'ড্যাশবোর্ড';
      
      // Update active nav button
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-600', 'dark:text-blue-400');
        btn.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
      });
      
      const activeBtn = document.querySelector(`[data-page="${pageId}"]`);
      if (activeBtn) {
        activeBtn.classList.add('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-600', 'dark:text-blue-400');
        activeBtn.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
      }
      
      // Update current page
      state.currentPage = pageId;
      
      // Render specific content for the page
      if (pageId === 'dashboard') {
        render.renderDashboard();
      } else if (pageId === 'groups') {
        render.renderGroups();
      } else if (pageId === 'members') {
        render.renderMembers();
      } else if (pageId === 'group-members') {
        render.renderGroupMembersPage();
      } else if (pageId === 'tasks') {
        render.renderTasks();
      } else if (pageId === 'evaluation') {
        render.updateGroupSelect();
        render.updateTaskSelect();
        render.renderEvaluationForm();
      } else if (pageId === 'all-groups') {
        render.renderAllGroups();
      } else if (pageId === 'admin-management') {
        render.renderAdminManagement();
      }
    }
    
    // Close mobile menu if open
    if (window.innerWidth < 768) {
      elements.sidebar.classList.add('hidden-mobile');
    }
    
    // Scroll to top of page content
    document.querySelector('.page-content').scrollTop = 0;
    
    // Hide loading after a short delay
    utils.hideLoading();
  },
  
  // Render dashboard with top groups and ranking
  renderDashboard: () => {
    const groupsPerformance = utils.getAllGroupsPerformance();
    
    // Render top 3 groups
    render.renderTopGroups(groupsPerformance);
    
    // Render all groups ranking
    render.renderGroupsRanking(groupsPerformance);
    
    // Render group details if a group is selected
    if (state.selectedGroup) {
      render.renderGroupDetails(state.selectedGroup);
    } else {
      elements.groupDetails.classList.add('hidden');
    }
  },
  
  // Render top 3 groups with circular progress indicators
  renderTopGroups: (groupsPerformance) => {
    elements.topGroupsContainer.innerHTML = '';
    
    if (groupsPerformance.length === 0) {
      elements.topGroupsContainer.innerHTML = `
        <div class="col-span-3 text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="fas fa-users text-4xl mb-3"></i>
          <p>কোন গ্রুপ বা মূল্যায়ন ডেটা পাওয়া যায়নি</p>
        </div>
      `;
      return;
    }
    
    // Show top 3 groups or all if less than 3
    const topGroups = groupsPerformance.slice(0, 3);
    
    topGroups.forEach((group, index) => {
      const rank = index + 1;
      let rankClass, rankTitle, rankColor, rankIcon;
      
      if (rank === 1) {
        rankClass = 'rank-1-card';
        rankTitle = 'প্রথম স্থান';
        rankColor = '#10b981'; // Green
        rankIcon = 'crown';
      } else if (rank === 2) {
        rankClass = 'rank-2-card';
        rankTitle = 'দ্বিতীয় স্থান';
        rankColor = '#3b82f6'; // Blue
        rankIcon = 'award';
      } else {
        rankClass = 'rank-3-card';
        rankTitle = 'তৃতীয় স্থান';
        rankColor = '#f59e0b'; // Yellow
        rankIcon = 'medal';
      }
      
      const groupElement = document.createElement('div');
      groupElement.className = `rank-card ${rankClass} rank-card-glow card-hover`;
      groupElement.innerHTML = `
        <div class="crown-icon text-${rank === 1 ? 'gold' : rank === 2 ? 'silver' : 'bronze'}">
          <i class="fas fa-${rankIcon}"></i>
        </div>
        <div class="rank-title ${rank === 1 ? 'rank-1-title' : rank === 2 ? 'rank-2-title' : 'rank-3-title'}">
          ${rankTitle}
        </div>
        <h4 class="font-bold text-lg mb-2">${group.name}</h4>
        <div class="text-center mb-4">
          <div class="inline-block relative">
            <svg class="w-32 h-32" viewBox="0 0 36 36">
              <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#eee" stroke-width="3"/>
              <path class="progress-circle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="${rankColor}" stroke-width="3" stroke-dasharray="0, 100"/>
              <text x="18" y="20.5" text-anchor="middle" fill="${rankColor}" font-size="8" font-weight="bold">0%</text>
            </svg>
          </div>
        </div>
        <p class="text-gray-600 dark:text-gray-400 font-semibold">মোট স্কোর: ${group.totalScore.toFixed(1)}/50</p>
        <p class="text-sm text-gray-500 dark:text-gray-400">${group.evaluatedTasksCount} টি টাস্ক মূল্যায়নকৃত</p>
        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">টাস্ক: ${group.totalTaskScore}/${group.maxPossibleTask} | টিম: ${group.totalTeamScore}/${group.maxPossibleTeam}</p>
      `;
      
      elements.topGroupsContainer.appendChild(groupElement);
      
      // Animate the progress circle after a short delay
      setTimeout(() => {
        const circle = groupElement.querySelector('.progress-circle');
        utils.updateCircleProgress(circle, group.finalPerformance, rankColor);
      }, 100 * index);
      
      // Add click event to show this group's details
      groupElement.addEventListener('click', () => {
        state.selectedGroup = group.name;
        render.renderDashboard();
      });
    });
    
    // If less than 3 groups, fill remaining space
    if (topGroups.length < 3) {
      for (let i = topGroups.length; i < 3; i++) {
        const emptyCard = document.createElement('div');
        emptyCard.className = 'bg-gray-100 dark:bg-gray-800 rounded-xl p-5 flex items-center justify-center';
        emptyCard.innerHTML = `
          <div class="text-center text-gray-400">
            <i class="fas fa-users text-3xl mb-2"></i>
            <p>খালি</p>
          </div>
        `;
        elements.topGroupsContainer.appendChild(emptyCard);
      }
    }
  },
  
  // Render all groups ranking list
  renderGroupsRanking: (groupsPerformance) => {
    elements.groupsRankingList.innerHTML = '';
    
    if (groupsPerformance.length === 0) {
      elements.groupsRankingList.innerHTML = `
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="fas fa-users text-4xl mb-3"></i>
          <p>কোন গ্রুপ বা মূল্যায়ন ডেটা পাওয়া যায়নি</p>
        </div>
      `;
      return;
    }
    
    groupsPerformance.forEach((group, index) => {
      const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
      const isActive = state.selectedGroup === group.name;
      
      const groupElement = document.createElement('div');
      groupElement.className = `group-bar p-4 border border-gray-200 dark:border-gray-700 rounded-lg flex items-center justify-between ${isActive ? 'active' : ''}`;
      groupElement.innerHTML = `
        <div class="flex items-center">
          <div class="rank-badge ${rankClass} mr-3">${index + 1}</div>
          <div>
            <h4 class="font-medium">${group.name}</h4>
            <div class="flex items-center text-sm text-gray-500 dark:text-gray-400 mt-1">
              <span class="mr-3">টাস্ক: ${group.taskPerformance.toFixed(1)}%</span>
              <span>টিম: ${group.teamPerformance.toFixed(1)}%</span>
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="font-bold text-lg">${group.totalScore.toFixed(1)}/50</div>
          <div class="text-sm text-gray-500 dark:text-gray-400">${group.finalPerformance.toFixed(1)}%</div>
          <div class="text-xs text-gray-400 dark:text-gray-500">${group.evaluatedTasksCount} টাস্ক</div>
        </div>
      `;
      
      elements.groupsRankingList.appendChild(groupElement);
      
      // Add click event to show this group's details
      groupElement.addEventListener('click', () => {
        state.selectedGroup = group.name;
        render.renderDashboard();
      });
    });
  },
  
  // Render detailed group information
  renderGroupDetails: (groupName) => {
    elements.groupDetails.classList.remove('hidden');
    
    const groupPerformance = utils.calculateGroupPerformance(groupName);
    const groupMembers = state.groupMembers[groupName] || {};
    
    let detailsHTML = `
      <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">${groupName} - বিস্তারিত ফলাফল</h3>
          <button id="closeDetails" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <!-- স্কোর ক্যালকুলেশন ডিটেইলস -->
        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg mb-6">
          <h4 class="font-semibold mb-2 text-blue-700 dark:text-blue-300">স্কোর ক্যালকুলেশন বিশদ:</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <p><strong>টাস্ক পারফরম্যান্স:</strong> ${groupPerformance.totalTaskScore}/${groupPerformance.maxPossibleTask} = ${groupPerformance.taskPerformance.toFixed(1)}%</p>
              <p><strong>টিম পারফরম্যান্স:</strong> ${groupPerformance.totalTeamScore}/${groupPerformance.maxPossibleTeam} = ${groupPerformance.teamPerformance.toFixed(1)}%</p>
            </div>
            <div>
              <p><strong>চূড়ান্ত স্কোর:</strong> (${groupPerformance.taskPerformance.toFixed(1)}% + ${groupPerformance.teamPerformance.toFixed(1)}%) ÷ 2 = ${groupPerformance.finalPerformance.toFixed(1)}%</p>
              <p><strong>৫০-এ কনভার্ট:</strong> ${groupPerformance.finalPerformance.toFixed(1)}% of 50 = ${groupPerformance.totalScore.toFixed(1)}/50</p>
            </div>
          </div>
        </div>
        
        <!-- Group Members Section -->
        <div class="mb-6">
          <h4 class="text-lg font-semibold mb-3">গ্রুপ সদস্য</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
    `;
    
    // Add group members
    const roles = ['team-leader', 'time-keeper', 'reporter', 'resource-manager', 'peace-maker'];
    roles.forEach(role => {
      const memberId = groupMembers[role];
      const member = memberId ? utils.getMemberById(memberId) : null;
      
      detailsHTML += `
        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-center">
          <div class="font-medium text-sm mb-1">${utils.getRoleName(role)}</div>
          <div class="text-xs text-gray-600 dark:text-gray-300">
            ${member ? member.name : 'নির্বাচিত হয়নি'}
          </div>
        </div>
      `;
    });
    
    detailsHTML += `
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${groupPerformance.taskPerformance.toFixed(1)}%</div>
            <div class="text-sm text-gray-600 dark:text-gray-300">টাস্ক পারফরম্যান্স</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">${groupPerformance.totalTaskScore}/${groupPerformance.maxPossibleTask}</div>
          </div>
          <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
            <div class="text-2xl font-bold text-green-600 dark:text-green-400">${groupPerformance.teamPerformance.toFixed(1)}%</div>
            <div class="text-sm text-gray-600 dark:text-gray-300">টিম পারফরম্যান্স</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">${groupPerformance.totalTeamScore}/${groupPerformance.maxPossibleTeam}</div>
          </div>
          <div class="text-center p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
            <div class="text-2xl font-bold text-amber-600 dark:text-amber-400">${groupPerformance.finalPerformance.toFixed(1)}%</div>
            <div class="text-sm text-gray-600 dark:text-gray-300">চূড়ান্ত ফলাফল</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">${groupPerformance.totalScore.toFixed(1)}/50</div>
          </div>
        </div>
    `;
    
    // Add task details
    if (groupPerformance.taskDetails.length > 0) {
      detailsHTML += `<h4 class="text-lg font-semibold mb-4">টাস্ক ভিত্তিক ফলাফল</h4>`;
      
      groupPerformance.taskDetails.forEach((task, taskIndex) => {
        detailsHTML += `
          <div class="mb-4 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
            <div class="bg-gray-50 dark:bg-gray-800 p-3 flex justify-between items-center cursor-pointer task-header">
              <h5 class="font-medium">${task.taskName} - মোট স্কোর: ${task.totalScore}/50</h5>
              <i class="fas fa-chevron-down expand-icon"></i>
            </div>
            <div class="task-details">
              <div class="p-4">
                <h6 class="font-medium text-blue-600 dark:text-blue-400 mb-2">টাস্ক ভিত্তিক মূল্যায়ন</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
        `;
        
        // Task evaluation details
        Object.entries(task.taskDetails).forEach(([criteria, score]) => {
          const maxScore = criteria === 'মূল কাজের মান' ? 10 : 5;
          detailsHTML += `
            <div class="flex justify-between">
              <span>${criteria}</span>
              <span>${score}/${maxScore}</span>
            </div>
          `;
        });
        
        detailsHTML += `
                </div>
                <h6 class="font-medium text-green-600 dark:text-green-400 mb-2">দল ভিত্তিক মূল্যায়ন</h6>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        `;
        
        // Team evaluation details
        Object.entries(task.teamDetails).forEach(([criteria, score]) => {
          detailsHTML += `
            <div class="flex justify-between">
              <span>${criteria}</span>
              <span>${score}/5</span>
            </div>
          `;
        });
        
        // Add comment section
        if (task.comment) {
          detailsHTML += `
                </div>
                <div class="comment-section mt-4">
                  <h6 class="font-medium text-purple-600 dark:text-purple-400 mb-2">শিক্ষকের মন্তব্য</h6>
                  <p class="text-sm bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg">${task.comment}</p>
                </div>
          `;
        }
        
        detailsHTML += `
              </div>
            </div>
          </div>
        `;
      });
    } else {
      detailsHTML += `<p class="text-gray-500 dark:text-gray-400 text-center py-4">এই গ্রুপের জন্য কোন মূল্যায়ন ডেটা পাওয়া যায়নি</p>`;
    }
    
    detailsHTML += `</div>`;
    
    elements.groupDetails.innerHTML = detailsHTML;
    
    // Add event listeners for expandable task details
    document.querySelectorAll('.task-header').forEach(header => {
      header.addEventListener('click', () => {
        const details = header.nextElementSibling;
        const icon = header.querySelector('.expand-icon');
        
        details.classList.toggle('open');
        icon.classList.toggle('rotated');
      });
    });
    
    // Add event listener for close button
    document.getElementById('closeDetails').addEventListener('click', () => {
      state.selectedGroup = null;
      render.renderDashboard();
    });
  },
  
  // Render groups list in groups page
  renderGroups: () => {
    elements.groupsList.innerHTML = '';
    
    if (state.groups.length === 0) {
      elements.groupsList.innerHTML = `
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="fas fa-users text-4xl mb-3"></i>
          <p>কোন গ্রুপ যোগ করা হয়নি</p>
        </div>
      `;
      return;
    }
    
    state.groups.forEach((group, index) => {
      const groupElement = document.createElement('div');
      groupElement.className = 'flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
      groupElement.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-users text-blue-500 mr-3"></i>
          <span>${group}</span>
        </div>
        <div class="flex space-x-2">
          <button class="edit-group text-blue-500 hover:text-blue-700 p-1 rounded" data-index="${index}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="delete-group text-red-500 hover:text-red-700 p-1 rounded" data-index="${index}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      
      elements.groupsList.appendChild(groupElement);
    });
    
    // Update group selects in other pages
    render.updateGroupSelect();
    render.updateGroupMemberSelect();
  },
  
  // Render members list in members page
  renderMembers: () => {
    elements.membersList.innerHTML = '';
    
    if (state.members.length === 0) {
      elements.membersList.innerHTML = `
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="fas fa-user-graduate text-4xl mb-3"></i>
          <p>কোন শিক্ষার্থী যোগ করা হয়নি</p>
        </div>
      `;
      return;
    }
    
    state.members.forEach((member, index) => {
      const memberElement = document.createElement('div');
      memberElement.className = 'flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
      memberElement.innerHTML = `
        <div>
          <div class="font-medium">${member.name}</div>
          <div class="text-sm text-gray-500 dark:text-gray-400">
            রোল: ${member.roll} | বিভাগ: ${member.dept} | ইমেইল: ${member.email}
          </div>
        </div>
        <div class="flex space-x-2">
          <button class="edit-member text-blue-500 hover:text-blue-700 p-1 rounded" data-index="${index}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="delete-member text-red-500 hover:text-red-700 p-1 rounded" data-index="${index}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      
      elements.membersList.appendChild(memberElement);
    });
    
    // Update member selects in group members page
    render.updateMemberSelects();
  },
  
  // Render group members page
  renderGroupMembersPage: () => {
    // Update group select
    render.updateGroupMemberSelect();
    
    // Update member selects
    render.updateMemberSelects();
    
    // Render group members list
    render.renderGroupMembersList();
  },
  
  // Update group select in evaluation page
  updateGroupSelect: () => {
    if (!elements.evalGroupSelect) return;
    
    elements.evalGroupSelect.innerHTML = '<option value="">একটি গ্রুপ নির্বাচন করুন</option>';
    
    state.groups.forEach(group => {
      const option = document.createElement('option');
      option.value = group;
      option.textContent = group;
      elements.evalGroupSelect.appendChild(option);
    });
  },
  
  // Update group select in group members page
  updateGroupMemberSelect: () => {
    if (!elements.groupMemberSelect) return;
    
    elements.groupMemberSelect.innerHTML = '<option value="">একটি গ্রুপ নির্বাচন করুন</option>';
    
    state.groups.forEach(group => {
      const option = document.createElement('option');
      option.value = group;
      option.textContent = group;
      elements.groupMemberSelect.appendChild(option);
    });
  },
  
  // Update member selects in group members page
  updateMemberSelects: () => {
    const memberSelects = document.querySelectorAll('.member-select');
    
    memberSelects.forEach(select => {
      // Store the current value
      const currentValue = select.value;
      
      // Clear options except the first one
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      // Get available members (not already assigned to any group)
      const availableMembers = utils.getAvailableMembers();
      
      // Add member options
      availableMembers.forEach(member => {
        const option = document.createElement('option');
        option.value = member.id;
        option.textContent = `${member.name} (${member.roll}) - ${member.dept}`;
        select.appendChild(option);
      });
      
      // Restore the previous value if it still exists
      if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
        select.value = currentValue;
      }
    });
  },
  
  // Render group members list
  renderGroupMembersList: () => {
    elements.groupMembersList.innerHTML = '';
    
    if (Object.keys(state.groupMembers).length === 0) {
      elements.groupMembersList.innerHTML = `
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="fas fa-user-friends text-4xl mb-3"></i>
          <p>কোন গ্রুপে সদস্য যোগ করা হয়নি</p>
        </div>
      `;
      return;
    }
    
    state.groups.forEach((group, index) => {
      const groupMembers = state.groupMembers[group] || {};
      
      if (Object.keys(groupMembers).length > 0) {
        const groupElement = document.createElement('div');
        const colorClass = utils.getGroupColorClass(index);
        groupElement.className = `border border-gray-200 dark:border-gray-700 rounded-lg p-4 ${colorClass} card-hover`;
        groupElement.innerHTML = `
          <h4 class="font-semibold mb-3">${group}</h4>
          <div class="space-y-2">
        `;
        
        const roles = ['team-leader', 'time-keeper', 'reporter', 'resource-manager', 'peace-maker'];
        roles.forEach(role => {
          const memberId = groupMembers[role];
          const member = memberId ? utils.getMemberById(memberId) : null;
          const roleClass = role.replace('-', '-');
          
          groupElement.innerHTML += `
            <div class="flex justify-between items-center">
              <span class="font-medium">${utils.getRoleName(role)}</span>
              <span class="${member ? 'text-gray-700 dark:text-gray-300' : 'text-gray-400'}">
                ${member ? `${member.name} (${member.roll}) - ${member.dept}` : 'নির্বাচিত হয়নি'}
              </span>
            </div>
          `;
        });
        
        groupElement.innerHTML += `</div>`;
        elements.groupMembersList.appendChild(groupElement);
      }
    });
  },
  
  // Render tasks list in tasks page
  renderTasks: () => {
    elements.tasksList.innerHTML = '';
    
    if (state.tasks.length === 0) {
      elements.tasksList.innerHTML = `
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="fas fa-tasks text-4xl mb-3"></i>
          <p>কোন টাস্ক যোগ করা হয়নি</p>
        </div>
      `;
      return;
    }
    
    state.tasks.forEach((task, index) => {
      const taskElement = document.createElement('div');
      taskElement.className = 'flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
      taskElement.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-tasks text-green-500 mr-3"></i>
          <span>${task}</span>
        </div>
        <div class="flex space-x-2">
          <button class="edit-task text-blue-500 hover:text-blue-700 p-1 rounded" data-index="${index}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="delete-task text-red-500 hover:text-red-700 p-1 rounded" data-index="${index}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      
      elements.tasksList.appendChild(taskElement);
    });
    
    // Update task select in evaluation page
    render.updateTaskSelect();
  },
  
  // Update task select in evaluation page
  updateTaskSelect: () => {
    if (!elements.evalTaskSelect) return;
    
    elements.evalTaskSelect.innerHTML = '<option value="">একটি টাস্ক নির্বাচন করুন</option>';
    
    state.tasks.forEach(task => {
      const option = document.createElement('option');
      option.value = task;
      option.textContent = task;
      elements.evalTaskSelect.appendChild(option);
    });
  },
  
  // Render evaluation form
  renderEvaluationForm: () => {
    const group = elements.evalGroupSelect.value;
    const task = elements.evalTaskSelect.value;
    
    if (!group || !task) {
      elements.evaluationForm.classList.add('hidden');
      return;
    }
    
    elements.evaluationForm.classList.remove('hidden');
    
    const key = utils.generateKey(group, task);
    
    // Initialize scores if not exists
    if (!state.scores[key]) {
      state.scores[key] = {
        task: {},
        team: {},
        comment: ''
      };
    }
    
    // Task evaluation criteria
    const taskCriteria = [
      ['মূল কাজের মান', 10],
      ['দলীয় সহযোগিতা', 5],
      ['সময়মত জমা', 5],
      ['উপস্থাপনা দক্ষতা', 5],
      ['নেতৃত্ব ও আচরণ', 5]
    ];
    
    // Team evaluation criteria
    const teamCriteria = [
      ['আমি কী শিখলাম', 5],
      ['আমার টিম কেমন কাজ করেছে', 5],
      ['আমরা কী উন্নতি করতে পারি', 5],
      ['আমার সবচেয়ে ভালো লাগা মুহূর্ত / ঘাটতি', 5]
    ];
    
    let formHTML = `
      <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5 mb-6">
        <h3 class="text-lg font-semibold mb-4">${group} - ${task}</h3>
        <h4 class="font-medium mb-3 text-blue-600 dark:text-blue-400">টাস্ক মূল্যায়ন</h4>
    `;
    
    // Task criteria inputs
    taskCriteria.forEach(([label, maxScore]) => {
      const currentValue = state.scores[key].task[label] || '';
      formHTML += `
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">${label} (${maxScore})</label>
          <input type="number" min="0" max="${maxScore}" step="0.5" 
                 value="${currentValue}" 
                 data-type="task" data-criteria="${label}"
                 class="score-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      `;
    });
    
    formHTML += `
        <h4 class="font-medium mb-3 mt-6 text-green-600 dark:text-green-400">দল ভিত্তিক মূল্যায়ন</h4>
    `;
    
    // Team criteria inputs
    teamCriteria.forEach(([label, maxScore]) => {
      const currentValue = state.scores[key].team[label] || '';
      formHTML += `
        <div class="mb-4">
          <label class="block text-sm font-medium mb-1">${label} (${maxScore})</label>
          <input type="number" min="0" max="${maxScore}" step="0.5" 
                 value="${currentValue}" 
                 data-type="team" data-criteria="${label}"
                 class="score-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      `;
    });
    
    // Comment section
    formHTML += `
        <h4 class="font-medium mb-3 mt-6 text-purple-600 dark:text-purple-400">শিক্ষকের মন্তব্য</h4>
        <div class="mb-4">
          <textarea id="teacherComment" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3" placeholder="টাস্ক সম্পর্কে আপনার মন্তব্য লিখুন...">${state.scores[key].comment || ''}</textarea>
        </div>
        
        <div class="mt-6">
          <button id="saveEvaluationBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
            <i class="fas fa-save mr-2"></i> মূল্যায়ন সংরক্ষণ করুন
          </button>
        </div>
      </div>
    `;
    
    elements.evaluationForm.innerHTML = formHTML;
    
    // Add event listener to save button
    const saveBtn = document.getElementById('saveEvaluationBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        // Collect all scores
        document.querySelectorAll('.score-input').forEach(input => {
          const type = input.getAttribute('data-type');
          const criteria = input.getAttribute('data-criteria');
          const value = parseFloat(input.value) || 0;
          
          if (!state.scores[key][type]) {
            state.scores[key][type] = {};
          }
          
          state.scores[key][type][criteria] = value;
        });
        
        // Save comment
        const comment = document.getElementById('teacherComment').value;
        state.scores[key].comment = comment;
        
        // Save to Firestore
        dbFunctions.saveScores();
        render.renderDashboard();
        
        // Show success message
        alert('মূল্যায়ন সফলভাবে সংরক্ষণ করা হয়েছে!');
      });
    }
    
    // Add input validation
    document.querySelectorAll('.score-input').forEach(input => {
      input.addEventListener('input', (e) => {
        const max = parseFloat(e.target.getAttribute('max'));
        const value = parseFloat(e.target.value) || 0;
        
        if (value > max) {
          e.target.value = max;
        }
      });
    });
  },
  
  // Render all groups in card layout
  renderAllGroups: () => {
    elements.allGroupsContainer.innerHTML = '';
    
    if (state.groups.length === 0) {
      elements.allGroupsContainer.innerHTML = `
        <div class="col-span-3 text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="fas fa-users text-4xl mb-3"></i>
          <p>কোন গ্রুপ যোগ করা হয়নি</p>
        </div>
      `;
      return;
    }
    
    state.groups.forEach((group, index) => {
      const groupMembers = state.groupMembers[group] || {};
      const colorClass = utils.getGroupColorClass(index);
      
      const groupCard = document.createElement('div');
      groupCard.className = `rounded-xl shadow-md p-5 ${colorClass} card-hover relative overflow-hidden`;
      groupCard.innerHTML = `
        <div class="group-serial">${index + 1}</div>
        <h3 class="text-xl font-bold mb-3 text-gray-800 dark:text-gray-200">${group}</h3>
        <div class="space-y-2">
      `;
      
      const roles = ['team-leader', 'time-keeper', 'reporter', 'resource-manager', 'peace-maker'];
      roles.forEach(role => {
        const memberId = groupMembers[role];
        const member = memberId ? utils.getMemberById(memberId) : null;
        
        groupCard.innerHTML += `
          <div class="flex justify-between items-center text-sm">
            <span class="font-medium">${utils.getRoleName(role)}:</span>
            <span class="${member ? 'text-gray-700 dark:text-gray-300' : 'text-gray-400'}">
              ${member ? `${member.name} (${member.roll})` : 'নির্বাচিত হয়নি'}
            </span>
          </div>
        `;
      });
      
      groupCard.innerHTML += `</div>`;
      elements.allGroupsContainer.appendChild(groupCard);
    });
  },
  
  // Render admin management page
  renderAdminManagement: () => {
    elements.adminList.innerHTML = '';
    
    if (state.admins.length === 0) {
      elements.adminList.innerHTML = `
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="fas fa-user-shield text-4xl mb-3"></i>
          <p>কোন অ্যাডমিন অ্যাকাউন্ট নেই</p>
        </div>
      `;
      return;
    }
    
    state.admins.forEach((admin, index) => {
      const adminElement = document.createElement('div');
      adminElement.className = 'flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
      adminElement.innerHTML = `
        <div>
          <div class="font-medium">${admin.email}</div>
          <div class="text-sm text-gray-500 dark:text-gray-400">
            ভূমিকা: ${admin.role === 'super-admin' ? 'সুপার অ্যাডমিন' : 'সাধারণ অ্যাডমিন'}
          </div>
        </div>
        <div class="flex space-x-2">
          <button class="edit-admin text-blue-500 hover:text-blue-700 p-1 rounded" data-index="${index}">
            <i class="fas fa-edit"></i>
          </button>
          <button class="delete-admin text-red-500 hover:text-red-700 p-1 rounded" data-index="${index}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      
      elements.adminList.appendChild(adminElement);
    });
  }
};

// Event Handlers
const handlers = {
  // Initialize the application
  init: () => {
    // Check authentication state
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // User is signed in
        state.currentUser = user;
        
        // Get user role from Firestore
        try {
          const userDoc = await db.collection('admins').doc(user.uid).get();
          if (userDoc.exists) {
            state.userRole = userDoc.data().role;
            
            // Show admin management section for super admin
            if (state.userRole === 'super-admin') {
              elements.adminManagementSection.classList.remove('hidden');
            }
          } else {
            state.userRole = 'admin'; // Default role
          }
        } catch (error) {
          console.error('Error getting user role:', error);
          state.userRole = 'admin'; // Default role
        }
        
        // Update UI
        elements.userInfo.textContent = `${user.email} (${state.userRole === 'super-admin' ? 'সুপার অ্যাডমিন' : 'অ্যাডমিন'})`;
        elements.appContainer.classList.remove('hidden');
        utils.hideModal(elements.authModal);
        
        // Load data from Firestore
        await dbFunctions.loadAllData();
        
        // Render initial data
        render.renderGroups();
        render.renderMembers();
        render.renderTasks();
        render.renderDashboard();
        
        // Show current page
        render.showPage(state.currentPage);
      } else {
        // User is signed out
        state.currentUser = null;
        state.userRole = null;
        elements.appContainer.classList.add('hidden');
        utils.showModal(elements.authModal);
      }
    });
    
    // Set up event listeners
    handlers.setupEventListeners();
  },
  
  // Set up all event listeners
  setupEventListeners: () => {
    // Authentication
    elements.showRegister.addEventListener('click', () => {
      elements.loginForm.classList.add('hidden');
      elements.registerForm.classList.remove('hidden');
    });
    
    elements.showLogin.addEventListener('click', () => {
      elements.registerForm.classList.add('hidden');
      elements.loginForm.classList.remove('hidden');
    });
    
    elements.loginBtn.addEventListener('click', async () => {
      const email = elements.loginEmail.value;
      const password = elements.loginPassword.value;
      
      if (!email || !password) {
        alert('ইমেইল এবং পাসওয়ার্ড প্রয়োজন');
        return;
      }
      
      try {
        utils.showLoading();
        await auth.signInWithEmailAndPassword(email, password);
        // onAuthStateChanged will handle the rest
      } catch (error) {
        console.error('Login error:', error);
        alert('লগইন ব্যর্থ: ' + error.message);
        utils.hideLoading();
      }
    });
    
    elements.registerBtn.addEventListener('click', async () => {
      const email = elements.registerEmail.value;
      const password = elements.registerPassword.value;
      const adminType = elements.adminType.value;
      
      if (!email || !password) {
        alert('ইমেইল এবং পাসওয়ার্ড প্রয়োজন');
        return;
      }
      
      if (password.length < 6) {
        alert('পাসওয়ার্ড কমপক্ষে ৬ অক্ষরের হতে হবে');
        return;
      }
      
      try {
        utils.showLoading();
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Save admin info to Firestore
        await db.collection('admins').doc(user.uid).set({
          email: email,
          role: adminType
        });
        
        // onAuthStateChanged will handle the rest
      } catch (error) {
        console.error('Registration error:', error);
        alert('রেজিস্ট্রেশন ব্যর্থ: ' + error.message);
        utils.hideLoading();
      }
    });
    
    elements.logoutBtn.addEventListener('click', async () => {
      try {
        await auth.signOut();
      } catch (error) {
        console.error('Logout error:', error);
      }
    });
    
    // Navigation buttons
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const page = btn.getAttribute('data-page');
        render.showPage(page);
      });
    });
    
    // Add group
    elements.addGroupBtn.addEventListener('click', () => {
      const groupName = elements.groupNameInput.value.trim();
      if (groupName && !state.groups.includes(groupName)) {
        state.groups.push(groupName);
        elements.groupNameInput.value = '';
        render.renderGroups();
        render.renderDashboard();
        dbFunctions.saveGroups();
      } else if (state.groups.includes(groupName)) {
        alert('এই নামে একটি গ্রুপ ইতিমধ্যে বিদ্যমান!');
      }
    });
    
    // Add member
    elements.addMemberBtn.addEventListener('click', () => {
      const name = elements.memberNameInput.value.trim();
      const roll = elements.memberRollInput.value.trim();
      const dept = elements.memberDeptInput.value.trim();
      const email = elements.memberEmailInput.value.trim();
      
      if (name && roll && dept) {
        // Check if member with same roll and department already exists
        if (utils.isDuplicateMember(roll, dept)) {
          alert('এই রোল নম্বর এবং বিভাগের শিক্ষার্থী ইতিমধ্যে বিদ্যমান!');
          return;
        }
        
        const newMember = {
          id: state.members.length > 0 ? Math.max(...state.members.map(m => m.id)) + 1 : 1,
          name: name,
          roll: roll,
          dept: dept,
          email: email
        };
        
        state.members.push(newMember);
        
        // Clear inputs
        elements.memberNameInput.value = '';
        elements.memberRollInput.value = '';
        elements.memberDeptInput.value = '';
        elements.memberEmailInput.value = '';
        
        render.renderMembers();
        render.updateMemberSelects();
        dbFunctions.saveMembers();
      } else {
        alert('নাম, রোল নম্বর এবং বিভাগ অবশ্যই পূরণ করতে হবে!');
      }
    });
    
    // Group member selection
    elements.groupMemberSelect.addEventListener('change', () => {
      const group = elements.groupMemberSelect.value;
      if (group) {
        elements.groupMemberForm.classList.remove('hidden');
        
        // Set current values for the selected group
        const groupMembers = state.groupMembers[group] || {};
        document.querySelectorAll('.member-select').forEach(select => {
          const role = select.getAttribute('data-role');
          select.value = groupMembers[role] || '';
        });
      } else {
        elements.groupMemberForm.classList.add('hidden');
      }
    });
    
    // Save group members
    elements.saveGroupMembersBtn.addEventListener('click', () => {
      const group = elements.groupMemberSelect.value;
      if (!group) return;
      
      const groupMembers = {};
      let hasDuplicate = false;
      const assignedMembers = new Set();
      
      document.querySelectorAll('.member-select').forEach(select => {
        const role = select.getAttribute('data-role');
        const memberId = parseInt(select.value);
        
        if (memberId) {
          // Check if member is already assigned in this group
          if (assignedMembers.has(memberId)) {
            hasDuplicate = true;
            alert('একই সদস্য একাধিক ভূমিকায় নির্বাচন করা যাবে না!');
            return;
          }
          
          assignedMembers.add(memberId);
          groupMembers[role] = memberId;
        }
      });
      
      if (hasDuplicate) return;
      
      state.groupMembers[group] = groupMembers;
      render.renderGroupMembersList();
      dbFunctions.saveGroupMembers();
      
      alert('গ্রুপ সদস্য সফলভাবে সংরক্ষণ করা হয়েছে!');
    });
    
    // Add task
    elements.addTaskBtn.addEventListener('click', () => {
      const taskName = elements.taskNameInput.value.trim();
      if (taskName && !state.tasks.includes(taskName)) {
        state.tasks.push(taskName);
        elements.taskNameInput.value = '';
        render.renderTasks();
        dbFunctions.saveTasks();
      } else if (state.tasks.includes(taskName)) {
        alert('এই নামে একটি টাস্ক ইতিমধ্যে বিদ্যমান!');
      }
    });
    
    // Search functionality
    elements.groupSearch.addEventListener('input', () => {
      const searchTerm = elements.groupSearch.value;
      const filteredGroups = utils.filterData(state.groups.map((name, index) => ({ name, index })), searchTerm, ['name']);
      
      elements.groupsList.innerHTML = '';
      
      if (filteredGroups.length === 0) {
        elements.groupsList.innerHTML = `
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <p>কোন গ্রুপ পাওয়া যায়নি</p>
          </div>
        `;
        return;
      }
      
      filteredGroups.forEach(({ name, index }) => {
        const groupElement = document.createElement('div');
        groupElement.className = 'flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
        groupElement.innerHTML = `
          <div class="flex items-center">
            <i class="fas fa-users text-blue-500 mr-3"></i>
            <span>${name}</span>
          </div>
          <div class="flex space-x-2">
            <button class="edit-group text-blue-500 hover:text-blue-700 p-1 rounded" data-index="${index}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-group text-red-500 hover:text-red-700 p-1 rounded" data-index="${index}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        elements.groupsList.appendChild(groupElement);
      });
    });
    
    elements.memberSearch.addEventListener('input', () => {
      const searchTerm = elements.memberSearch.value;
      const filteredMembers = utils.filterData(state.members, searchTerm, ['name', 'roll', 'dept', 'email']);
      
      elements.membersList.innerHTML = '';
      
      if (filteredMembers.length === 0) {
        elements.membersList.innerHTML = `
          <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <p>কোন শিক্ষার্থী পাওয়া যায়নি</p>
          </div>
        `;
        return;
      }
      
      filteredMembers.forEach((member, index) => {
        const originalIndex = state.members.findIndex(m => m.id === member.id);
        const memberElement = document.createElement('div');
        memberElement.className = 'flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
        memberElement.innerHTML = `
          <div>
            <div class="font-medium">${member.name}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">
              রোল: ${member.roll} | বিভাগ: ${member.dept} | ইমেইল: ${member.email}
            </div>
          </div>
          <div class="flex space-x-2">
            <button class="edit-member text-blue-500 hover:text-blue-700 p-1 rounded" data-index="${originalIndex}">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-member text-red-500 hover:text-red-700 p-1 rounded" data-index="${originalIndex}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        elements.membersList.appendChild(memberElement);
      });
    });
    
    // Delete group
    elements.groupsList.addEventListener('click', (e) => {
      if (e.target.closest('.delete-group')) {
        const index = e.target.closest('.delete-group').getAttribute('data-index');
        const groupName = state.groups[index];
        
        state.deletePending = { type: 'group', index: parseInt(index), name: groupName };
        elements.deleteModalText.textContent = `আপনি কি নিশ্চিত যে আপনি "${groupName}" গ্রুপটি ডিলিট করতে চান?`;
        utils.showModal(elements.deleteModal);
      }
      
      // Edit group
      if (e.target.closest('.edit-group')) {
        const index = e.target.closest('.edit-group').getAttribute('data-index');
        const currentName = state.groups[index];
        
        elements.editModalTitle.textContent = 'গ্রুপ সম্পাদনা করুন';
        elements.editModalContent.innerHTML = `
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">গ্রুপের নাম</label>
            <input id="editGroupName" type="text" value="${currentName}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        `;
        
        state.editPending = { type: 'group', index: parseInt(index), data: currentName };
        utils.showModal(elements.editModal);
      }
    });
    
    // Delete member
    elements.membersList.addEventListener('click', (e) => {
      if (e.target.closest('.delete-member')) {
        const index = e.target.closest('.delete-member').getAttribute('data-index');
        const memberName = state.members[index].name;
        
        state.deletePending = { type: 'member', index: parseInt(index), name: memberName };
        elements.deleteModalText.textContent = `আপনি কি নিশ্চিত যে আপনি "${memberName}" শিক্ষার্থীটি ডিলিট করতে চান?`;
        utils.showModal(elements.deleteModal);
      }
      
      // Edit member
      if (e.target.closest('.edit-member')) {
        const index = e.target.closest('.edit-member').getAttribute('data-index');
        const member = state.members[index];
        
        elements.editModalTitle.textContent = 'শিক্ষার্থী সম্পাদনা করুন';
        elements.editModalContent.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">নাম</label>
              <input id="editMemberName" type="text" value="${member.name}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">রোল নম্বর</label>
              <input id="editMemberRoll" type="text" value="${member.roll}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">বিভাগ</label>
              <input id="editMemberDept" type="text" value="${member.dept}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">ইমেইল</label>
              <input id="editMemberEmail" type="email" value="${member.email}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
          </div>
        `;
        
        state.editPending = { type: 'member', index: parseInt(index), data: member };
        utils.showModal(elements.editModal);
      }
    });
    
    // Delete task
    elements.tasksList.addEventListener('click', (e) => {
      if (e.target.closest('.delete-task')) {
        const index = e.target.closest('.delete-task').getAttribute('data-index');
        const taskName = state.tasks[index];
        
        state.deletePending = { type: 'task', index: parseInt(index), name: taskName };
        elements.deleteModalText.textContent = `আপনি কি নিশ্চিত যে আপনি "${taskName}" টাস্কটি ডিলিট করতে চান?`;
        utils.showModal(elements.deleteModal);
      }
      
      // Edit task
      if (e.target.closest('.edit-task')) {
        const index = e.target.closest('.edit-task').getAttribute('data-index');
        const currentName = state.tasks[index];
        
        elements.editModalTitle.textContent = 'টাস্ক সম্পাদনা করুন';
        elements.editModalContent.innerHTML = `
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">টাস্কের নাম</label>
            <input id="editTaskName" type="text" value="${currentName}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
        `;
        
        state.editPending = { type: 'task', index: parseInt(index), data: currentName };
        utils.showModal(elements.editModal);
      }
    });
    
    // Evaluation form changes
    elements.evalGroupSelect.addEventListener('change', render.renderEvaluationForm);
    elements.evalTaskSelect.addEventListener('change', render.renderEvaluationForm);
    
    // Export data
    elements.exportDataBtn.addEventListener('click', () => {
      // Create CSV content
      let csvContent = "Group,Task,Task Performance,Team Performance,Total Score,Percentage,Comment\n";
      
      Object.keys(state.scores).forEach(key => {
        const [group, task] = key.split('::');
        const taskScore = Object.values(state.scores[key].task || {}).reduce((a, b) => a + b, 0);
        const teamScore = Object.values(state.scores[key].team || {}).reduce((a, b) => a + b, 0);
        const totalScore = taskScore + teamScore;
        const percentage = (totalScore / 50) * 100;
        const comment = state.scores[key].comment || '';
        
        csvContent += `"${group}","${task}",${taskScore},${teamScore},${totalScore},${percentage.toFixed(2)},"${comment}"\n`;
      });
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'smart_evaluator_data.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    
    // Reset data
    elements.resetDataBtn.addEventListener('click', () => {
      if (confirm('আপনি কি নিশ্চিত যে আপনি সমস্ত ডেটা রিসেট করতে চান? এটি পূর্বের সমস্ত ডেটা মুছে ফেলবে।')) {
        // Reset state
        state.groups = [];
        state.tasks = [];
        state.members = [];
        state.groupMembers = {};
        state.scores = {};
        state.selectedGroup = null;
        
        // Save to Firestore
        dbFunctions.saveGroups();
        dbFunctions.saveTasks();
        dbFunctions.saveMembers();
        dbFunctions.saveGroupMembers();
        dbFunctions.saveScores();
        
        // Update UI
        render.renderGroups();
        render.renderMembers();
        render.renderTasks();
        render.renderDashboard();
        render.renderEvaluationForm();
        
        alert('সিস্টেম সফলভাবে রিসেট করা হয়েছে!');
      }
    });
    
    // Theme toggle
    elements.themeToggle.addEventListener('click', () => {
      if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        elements.themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        localStorage.setItem('theme', 'light');
      } else {
        document.documentElement.classList.add('dark');
        elements.themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        localStorage.setItem('theme', 'dark');
      }
    });
    
    // Mobile menu toggle
    elements.mobileMenuBtn.addEventListener('click', () => {
      elements.sidebar.classList.toggle('hidden-mobile');
    });
    
    // Delete modal handlers
    elements.cancelDelete.addEventListener('click', () => {
      utils.hideModal(elements.deleteModal);
      state.deletePending = { type: null, index: null, name: null };
    });
    
    elements.confirmDelete.addEventListener('click', () => {
      if (state.deletePending.type === 'group') {
        const groupName = state.groups[state.deletePending.index];
        
        // Remove from groups
        state.groups.splice(state.deletePending.index, 1);
        
        // Remove from group members
        delete state.groupMembers[groupName];
        
        // Remove from scores
        Object.keys(state.scores).forEach(key => {
          if (key.startsWith(`${groupName}::`)) {
            delete state.scores[key];
          }
        });
        
        render.renderGroups();
        render.renderDashboard();
        render.renderGroupMembersList();
        dbFunctions.saveGroups();
        dbFunctions.saveGroupMembers();
        dbFunctions.saveScores();
      } else if (state.deletePending.type === 'member') {
        const memberId = state.members[state.deletePending.index].id;
        
        // Remove from members
        state.members.splice(state.deletePending.index, 1);
        
        // Remove from group members
        Object.keys(state.groupMembers).forEach(group => {
          Object.keys(state.groupMembers[group]).forEach(role => {
            if (state.groupMembers[group][role] === memberId) {
              delete state.groupMembers[group][role];
            }
          });
        });
        
        render.renderMembers();
        render.updateMemberSelects();
        render.renderGroupMembersList();
        dbFunctions.saveMembers();
        dbFunctions.saveGroupMembers();
      } else if (state.deletePending.type === 'task') {
        const taskName = state.tasks[state.deletePending.index];
        
        // Remove from tasks
        state.tasks.splice(state.deletePending.index, 1);
        
        // Remove from scores
        Object.keys(state.scores).forEach(key => {
          if (key.endsWith(`::${taskName}`)) {
            delete state.scores[key];
          }
        });
        
        render.renderTasks();
        render.renderDashboard();
        dbFunctions.saveTasks();
        dbFunctions.saveScores();
      }
      
      utils.hideModal(elements.deleteModal);
      state.deletePending = { type: null, index: null, name: null };
    });
    
    // Edit modal handlers
    elements.cancelEdit.addEventListener('click', () => {
      utils.hideModal(elements.editModal);
      state.editPending = { type: null, index: null, data: null };
    });
    
    elements.saveEdit.addEventListener('click', () => {
      if (state.editPending.type === 'group') {
        const newName = document.getElementById('editGroupName').value.trim();
        
        if (newName && newName !== state.editPending.data) {
          if (state.groups.includes(newName)) {
            alert('এই নামে একটি গ্রুপ ইতিমধ্যে বিদ্যমান!');
            return;
          }
          
          // Update group name in all related data
          const oldName = state.groups[state.editPending.index];
          state.groups[state.editPending.index] = newName;
          
          // Update group members
          if (state.groupMembers[oldName]) {
            state.groupMembers[newName] = state.groupMembers[oldName];
            delete state.groupMembers[oldName];
          }
          
          // Update scores
          Object.keys(state.scores).forEach(key => {
            if (key.startsWith(`${oldName}::`)) {
              const newKey = key.replace(`${oldName}::`, `${newName}::`);
              state.scores[newKey] = state.scores[key];
              delete state.scores[key];
            }
          });
          
          render.renderGroups();
          render.renderDashboard();
          render.renderGroupMembersList();
          dbFunctions.saveGroups();
          dbFunctions.saveGroupMembers();
          dbFunctions.saveScores();
        }
      } else if (state.editPending.type === 'member') {
        const newName = document.getElementById('editMemberName').value.trim();
        const newRoll = document.getElementById('editMemberRoll').value.trim();
        const newDept = document.getElementById('editMemberDept').value.trim();
        const newEmail = document.getElementById('editMemberEmail').value.trim();
        
        if (newName && newRoll && newDept) {
          // Check if roll already exists (excluding current member)
          const currentMember = state.members[state.editPending.index];
          if (state.members.some(m => m.roll === newRoll && m.id !== currentMember.id)) {
            alert('এই রোল নম্বরটি ইতিমধ্যে বিদ্যমান!');
            return;
          }
          
          state.members[state.editPending.index] = {
            ...currentMember,
            name: newName,
            roll: newRoll,
            dept: newDept,
            email: newEmail
          };
          
          render.renderMembers();
          render.updateMemberSelects();
          render.renderGroupMembersList();
          dbFunctions.saveMembers();
        }
      } else if (state.editPending.type === 'task') {
        const newName = document.getElementById('editTaskName').value.trim();
        
        if (newName && newName !== state.editPending.data) {
          if (state.tasks.includes(newName)) {
            alert('এই নামে একটি টাস্ক ইতিমধ্যে বিদ্যমান!');
            return;
          }
          
          // Update task name in scores
          const oldName = state.tasks[state.editPending.index];
          state.tasks[state.editPending.index] = newName;
          
          Object.keys(state.scores).forEach(key => {
            if (key.endsWith(`::${oldName}`)) {
              const newKey = key.replace(`::${oldName}`, `::${newName}`);
              state.scores[newKey] = state.scores[key];
              delete state.scores[key];
            }
          });
          
          render.renderTasks();
          render.renderDashboard();
          dbFunctions.saveTasks();
          dbFunctions.saveScores();
        }
      }
      
      utils.hideModal(elements.editModal);
      state.editPending = { type: null, index: null, data: null };
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
      if (e.target === elements.deleteModal) {
        utils.hideModal(elements.deleteModal);
        state.deletePending = { type: null, index: null, name: null };
      }
      if (e.target === elements.editModal) {
        utils.hideModal(elements.editModal);
        state.editPending = { type: null, index: null, data: null };
      }
      if (e.target === elements.authModal) {
        // Don't allow closing auth modal by clicking outside
      }
    });
    
    // Add admin
    elements.addAdminBtn.addEventListener('click', async () => {
      const email = elements.newAdminEmail.value.trim();
      const adminType = elements.newAdminType.value;
      
      if (!email) {
        alert('ইমেইল প্রয়োজন');
        return;
      }
      
      // Check if admin already exists
      if (state.admins.some(admin => admin.email === email)) {
        alert('এই ইমেইল দিয়ে ইতিমধ্যে একটি অ্যাডমিন অ্যাকাউন্ট রয়েছে');
        return;
      }
      
      try {
        // Create auth account
        const password = Math.random().toString(36).slice(-8); // Generate random password
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Add to admins list
        const newAdmin = {
          id: user.uid,
          email: email,
          role: adminType
        };
        
        state.admins.push(newAdmin);
        elements.newAdminEmail.value = '';
        
        // Save to Firestore
        await db.collection('admins').doc(user.uid).set({
          email: email,
          role: adminType
        });
        
        render.renderAdminManagement();
        
        alert(`নতুন অ্যাডমিন যোগ করা হয়েছে! পাসওয়ার্ড: ${password} (ব্যবহারকারীকে এটি পরিবর্তন করার পরামর্শ দিন)`);
      } catch (error) {
        console.error('Error adding admin:', error);
        alert('অ্যাডমিন যোগ করতে ব্যর্থ: ' + error.message);
      }
    });
  }
};

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', handlers.init);

// Check for saved theme preference
if (localStorage.getItem('theme') === 'dark') {
  document.documentElement.classList.add('dark');
  elements.themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
}
 </script>
 </body>
 </html>