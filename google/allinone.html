<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Group Evaluator</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papa Parse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <!-- JSZip -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .student-card-bg-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .student-card-bg-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .student-card-bg-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .student-card-bg-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .student-card-bg-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .student-card-bg-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .student-card-bg-7 { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .student-card-bg-8 { background: linear-gradient(135deg, #9890e3 0%, #b1f4cf 100%); }
        
        .student-card { position: relative; color: white; }
        .student-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; }
        .serial-number { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFEC8B 100%); color: #8B7500; }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #E8E8E8 100%); color: #696969; }
        .rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #E8B580 100%); color: #8B4513; }
        .rank-other { background: #f8fafc; color: #4b5563; }
        
        .rank-badge { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .rank-1-card { background: linear-gradient(135deg, #FFD700 0%, #FFF8DC 100%); border: 2px solid #FFD700; }
        .rank-2-card { background: linear-gradient(135deg, #C0C0C0 0%, #F5F5F5 100%); border: 2px solid #C0C0C0; }
        .rank-3-card { background: linear-gradient(135deg, #CD7F32 0%, #F5DEB3 100%); border: 2px solid #CD7F32; }
        
        .rank-1-title { color: #B8860B; font-weight: bold; }
        .rank-2-title { color: #696969; font-weight: bold; }
        .rank-3-title { color: #8B4513; font-weight: bold; }
        
        .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass-card { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        .card-hover { transition: transform 0.3s, box-shadow 0.3s; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .progress-bar { width: 100%; height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        
        .policy-section { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem; overflow: hidden; }
        .policy-header { background-color: #f8fafc; padding: 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .policy-content { padding: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s, padding 0.3s; }
        .policy-content.open { padding: 1rem; max-height: 500px; }
        
        .member-role-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-left: 8px; }
        .team-leader { background-color: #fef3c7; color: #92400e; }
        .time-keeper { background-color: #dbeafe; color: #1e40af; }
        .reporter { background-color: #fce7f3; color: #be185d; }
        .resource-manager { background-color: #dcfce7; color: #166534; }
        .peace-maker { background-color: #f3e8ff; color: #7e22ce; }
        
        .evaluation-table { width: 100%; border-collapse: collapse; }
        .evaluation-table th, .evaluation-table td { border: 1px solid #e5e7eb; padding: 8px 12px; text-align: left; }
        .evaluation-table th { background-color: #f8fafc; font-weight: 600; }
        
        .toast { z-index: 10000; }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; left: 0; height: 100vh; z-index: 40; transform: translateX(-100%); transition: transform 0.3s; }
            .sidebar.open { transform: translateX(0); }
        }
        
        .dark .policy-header { background-color: #1e293b; }
        .dark .evaluation-table th { background-color: #1e293b; }
        .dark .evaluation-table th, .dark .evaluation-table td { border-color: #374151; }
    </style>


<link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors">
    <!-- Authentication Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">লগইন / রেজিস্ট্রেশন</h2>
                <button onclick="smartEvaluator.hideModal(document.getElementById('authModal'))" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ইমেইল</label>
                    <input id="loginEmail" type="email" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" placeholder="your@email.com">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">পাসওয়ার্ড</label>
                    <input id="loginPassword" type="password" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" placeholder="পাসওয়ার্ড">
                </div>
                <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">লগইন</button>
                <div class="mt-4 text-center">
                    <span class="text-sm text-gray-600 dark:text-gray-400">অ্যাকাউন্ট নেই? </span>
                    <button id="showRegister" class="text-blue-600 hover:text-blue-800 text-sm font-medium">রেজিস্ট্রেশন করুন</button>
                </div>
                <div class="mt-4">
                    <button id="googleSignInBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i class="fab fa-google"></i>
                        Google দিয়ে লগইন
                    </button>
                </div>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ইমেইল</label>
                    <input id="registerEmail" type="email" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" placeholder="your@email.com">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">পাসওয়ার্ড</label>
                    <input id="registerPassword" type="password" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" placeholder="ন্যূনতম ৬ অক্ষর">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">অ্যাডমিন টাইপ</label>
                    <select id="adminType" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                        <option value="admin">সাধারণ অ্যাডমিন</option>
                        <option value="super-admin">সুপার অ্যাডমিন</option>
                    </select>
                </div>
                <button id="registerBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition-colors">রেজিস্ট্রেশন</button>
                <div class="mt-4 text-center">
                    <span class="text-sm text-gray-600 dark:text-gray-400">ইতিমধ্যে অ্যাকাউন্ট আছে? </span>
                    <button id="showLogin" class="text-blue-600 hover:text-blue-800 text-sm font-medium">লগইন করুন</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-bold mb-4">লগআউট নিশ্চিতকরণ</h3>
            <p class="mb-6">আপনি কি নিশ্চিত যে আপনি লগআউট করতে চান?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelLogout" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">বাতিল</button>
                <button id="confirmLogout" class="px-4 py-2 bg-red-600 text-white rounded-lg">লগআউট</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-bold mb-4">ডিলিট নিশ্চিতকরণ</h3>
            <p id="deleteModalText" class="mb-6">আপনি কি নিশ্চিত যে আপনি এই আইটেমটি ডিলিট করতে চান?</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDelete" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">বাতিল</button>
                <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg">ডিলিট</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <h3 id="editModalTitle" class="text-lg font-bold mb-4">সম্পাদনা</h3>
            <div id="editModalContent" class="mb-6">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="flex justify-end gap-3">
                <button id="cancelEdit" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">বাতিল</button>
                <button id="saveEdit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">সংরক্ষণ</button>
            </div>
        </div>
    </div>

    <!-- Group Details Modal -->
    <div id="groupDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-6xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="groupDetailsTitle" class="text-lg font-bold">গ্রুপ বিস্তারিত</h3>
                <button id="closeGroupDetails" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="groupDetailsContent">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Admin Management Modal -->
    <div id="adminModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4">
            <h3 id="adminModalTitle" class="text-lg font-bold mb-4">অ্যাডমিন ব্যবস্থাপনা</h3>
            <div id="adminModalContent" class="mb-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ইমেইল</label>
                    <input id="adminEmail" type="email" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">পাসওয়ার্ড</label>
                    <input id="adminPassword" type="password" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" placeholder="নতুন অ্যাডমিনের জন্য প্রয়োজন">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">অ্যাডমিন টাইপ</label>
                    <select id="adminTypeSelect" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                        <option value="admin">সাধারণ অ্যাডমিন</option>
                        <option value="super-admin">সুপার অ্যাডমিন</option>
                    </select>
                </div>
                <div id="permissionsSection" class="mb-4 hidden">
                    <label class="block text-sm font-medium mb-2">পারমিশন</label>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input id="permissionRead" type="checkbox" class="mr-2">
                            <label for="permissionRead">ডেটা দেখা</label>
                        </div>
                        <div class="flex items-center">
                            <input id="permissionWrite" type="checkbox" class="mr-2">
                            <label for="permissionWrite">ডেটা এডিট</label>
                        </div>
                        <div class="flex items-center">
                            <input id="permissionDelete" type="checkbox" class="mr-2">
                            <label for="permissionDelete">ডেটা ডিলিট</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button id="cancelAdmin" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">বাতিল</button>
                <button id="saveAdmin" class="px-4 py-2 bg-blue-600 text-white rounded-lg">সংরক্ষণ</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 flex items-center gap-3">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p>লোড হচ্ছে...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <span id="toastMessage"></span>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="min-h-screen flex">
        <!-- Sidebar -->
        <div class="sidebar bg-white dark:bg-gray-800 w-64 p-4 shadow-lg md:shadow-none md:static md:translate-x-0">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-xl font-bold">Smart Evaluator</h1>
                <button id="mobileMenuBtn" class="md:hidden text-gray-500">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            
            <div class="user-info mb-6 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <div id="userInfo">
                    <div class="text-xs text-gray-500">সাধারণ ব্যবহারকারী</div>
                </div>
            </div>
            
            <nav class="space-y-2">
                <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt mr-3"></i>ড্যাশবোর্ড
                </button>
                <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-page="groups">
                    <i class="fas fa-layer-group mr-3"></i>গ্রুপ ব্যবস্থাপনা
                </button>
                <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-page="members">
                    <i class="fas fa-users mr-3"></i>সদস্য ব্যবস্থাপনা
                </button>
                <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-page="group-members">
                    <i class="fas fa-user-friends mr-3"></i>গ্রুপ সদস্য
                </button>
                <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-page="all-students">
                    <i class="fas fa-id-card mr-3"></i>সকল শিক্ষার্থী
                </button>
                <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-page="student-ranking">
                    <i class="fas fa-trophy mr-3"></i>শিক্ষার্থী র‌্যাঙ্কিং
                </button>
                <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-page="group-analysis">
                    <i class="fas fa-chart-bar mr-3"></i>গ্রুপ বিশ্লেষণ
                </button>
                <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-page="tasks">
                    <i class="fas fa-tasks mr-3"></i>টাস্ক ব্যবস্থাপনা
                </button>
                <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-page="evaluation">
                    <i class="fas fa-clipboard-check mr-3"></i>মূল্যায়ন
                </button>
                <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-page="group-policy">
                    <i class="fas fa-book mr-3"></i>গ্রুপ নীতিমালা
                </button>
                <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-page="export">
                    <i class="fas fa-file-export mr-3"></i>এক্সপোর্ট
                </button>
                <div id="adminManagementSection" class="hidden">
                    <button class="nav-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-page="admin-management">
                        <i class="fas fa-user-shield mr-3"></i>অ্যাডমিন ব্যবস্থাপনা
                    </button>
                </div>
            </nav>
            
            <div class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button id="themeToggle" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fas fa-moon mr-3"></i>থিম পরিবর্তন
                </button>
                <button id="logoutBtn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 hidden">
                    <i class="fas fa-sign-out-alt mr-3"></i>লগআউট
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 p-4 md:p-6 overflow-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="pageTitle" class="text-2xl font-bold">ড্যাশবোর্ড</h2>
                <div class="flex items-center gap-4">
                    <div id="userInfo" class="text-right hidden md:block">
                        <div class="text-xs text-gray-500">সাধারণ ব্যবহারকারী</div>
                    </div>
                    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg hidden">
                        লগআউট
                    </button>
                </div>
            </div>
            
            <!-- Pages -->
            <div id="page-dashboard" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div id="statsSummary">
                        <!-- Stats will be loaded here -->
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                        <h3 class="text-lg font-bold mb-4">একাডেমিক গ্রুপ অনুযায়ী শিক্ষার্থী</h3>
                        <div id="academicGroupStatsList">
                            <!-- Academic group stats will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                        <h3 class="text-lg font-bold mb-4">টাস্ক পরিসংখ্যান</h3>
                        <div id="taskStats">
                            <!-- Task stats will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                        <h3 class="text-lg font-bold mb-4">শীর্ষ গ্রুপসমূহ</h3>
                        <div id="topGroupsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Top groups will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                        <h3 class="text-lg font-bold mb-4">মূল্যায়ন পরিসংখ্যান</h3>
                        <div id="evaluationStats">
                            <!-- Evaluation stats will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                    <h3 class="text-lg font-bold mb-4">গ্রুপ র‌্যাঙ্কিং</h3>
                    <div id="groupsRankingList" class="space-y-3">
                        <!-- Groups ranking will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Groups Management Page -->
            <div id="page-groups" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-6">
                    <h3 class="text-lg font-bold mb-4">নতুন গ্রুপ যোগ করুন</h3>
                    <div class="flex gap-4">
                        <input id="groupNameInput" type="text" class="flex-1 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" placeholder="গ্রুপের নাম">
                        <button id="addGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">গ্রুপ যোগ করুন</button>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                    <h3 class="text-lg font-bold mb-4">গ্রুপ তালিকা</h3>
                    <div id="groupsList" class="space-y-3">
                        <!-- Groups will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Members Management Page -->
            <div id="page-members" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-6">
                    <h3 class="text-lg font-bold mb-4">নতুন শিক্ষার্থী যোগ করুন</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">নাম</label>
                            <input id="studentNameInput" type="text" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">রোল</label>
                            <input id="studentRollInput" type="text" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">লিঙ্গ</label>
                            <select id="studentGenderInput" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                                <option value="ছেলে">ছেলে</option>
                                <option value="মেয়ে">মেয়ে</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">গ্রুপ</label>
                            <select id="studentGroupInput" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">যোগাযোগ</label>
                            <input id="studentContactInput" type="text" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">একাডেমিক গ্রুপ</label>
                            <input id="studentAcademicGroupInput" type="text" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">সেশন</label>
                            <input id="studentSessionInput" type="text" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">দায়িত্ব</label>
                            <select id="studentRoleInput" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                                <option value="">কোনোটি না</option>
                                <option value="team-leader">টিম লিডার</option>
                                <option value="time-keeper">টাইম কিপার</option>
                                <option value="reporter">রিপোর্টার</option>
                                <option value="resource-manager">রিসোর্স ম্যানেজার</option>
                                <option value="peace-maker">পিস মেকার</option>
                            </select>
                        </div>
                    </div>
                    <button id="addStudentBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">শিক্ষার্থী যোগ করুন</button>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-4">
                    <h3 class="text-lg font-bold mb-4">ফিল্টার</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium mb-2">গ্রুপ</label>
                            <select id="membersFilterGroup" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                                <option value="">সকল গ্রুপ</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium mb-2">খুঁজুন</label>
                            <input id="studentSearchInput" type="text" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" placeholder="নাম বা রোল দ্বারা খুঁজুন">
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                    <h3 class="text-lg font-bold mb-4">শিক্ষার্থী তালিকা</h3>
                    <div id="studentsList" class="space-y-3">
                        <!-- Students will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Group Members Page -->
            <div id="page-group-members" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-6">
                    <h3 class="text-lg font-bold mb-4">গ্রুপ সদস্য</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">গ্রুপ নির্বাচন করুন</label>
                        <select id="groupMembersGroupSelect" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                            <option value="">সকল গ্রুপ</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div id="groupMembersList" class="space-y-3">
                        <!-- Group members will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- All Students Page -->
            <div id="page-all-students" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-4">
                    <h3 class="text-lg font-bold mb-4">ফিল্টার</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium mb-2">গ্রুপ</label>
                            <select id="cardsFilterGroup" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                                <option value="">সকল গ্রুপ</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium mb-2">খুঁজুন</label>
                            <input id="allStudentsSearchInput" type="text" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" placeholder="নাম বা রোল দ্বারা খুঁজুন">
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                    <h3 class="text-lg font-bold mb-4">সকল শিক্ষার্থী</h3>
                    <div id="allStudentsCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Student cards will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Student Ranking Page -->
            <div id="page-student-ranking" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">শিক্ষার্থী র‌্যাঙ্কিং</h3>
                        <button id="refreshRanking" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">রিফ্রেশ</button>
                    </div>
                    <div id="studentRankingList" class="space-y-3">
                        <!-- Student ranking will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Group Analysis Page -->
            <div id="page-group-analysis" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-6">
                    <h3 class="text-lg font-bold mb-4">গ্রুপ বিশ্লেষণ</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">গ্রুপ নির্বাচন করুন (একাধিক)</label>
                        <select id="analysisGroupSelect" multiple class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <button id="updateAnalysisBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">বিশ্লেষণ আপডেট করুন</button>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-6">
                    <h3 class="text-lg font-bold mb-4">গ্রুপ স্কোর তুলনা</h3>
                    <div class="h-80">
                        <canvas id="groupAnalysisChart"></canvas>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                    <h3 class="text-lg font-bold mb-4">গ্রুপ বিশ্লেষণ বিস্তারিত</h3>
                    <div id="groupAnalysisDetails" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Group analysis details will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Tasks Management Page -->
            <div id="page-tasks" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-6">
                    <h3 class="text-lg font-bold mb-4">নতুন টাস্ক যোগ করুন</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">টাস্ক নাম</label>
                            <input id="taskNameInput" type="text" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">সর্বোচ্চ স্কোর</label>
                            <input id="taskMaxScoreInput" type="number" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium mb-2">বিবরণ</label>
                            <textarea id="taskDescriptionInput" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" rows="3"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">তারিখ</label>
                            <input id="taskDateInput" type="date" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                        </div>
                    </div>
                    <button id="addTaskBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">টাস্ক যোগ করুন</button>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                    <h3 class="text-lg font-bold mb-4">টাস্ক তালিকা</h3>
                    <div id="tasksList" class="space-y-4">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Evaluation Page -->
            <div id="page-evaluation" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-6">
                    <h3 class="text-lg font-bold mb-4">মূল্যায়ন শুরু করুন</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">টাস্ক নির্বাচন করুন</label>
                            <select id="evaluationTaskSelect" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">গ্রুপ নির্বাচন করুন</label>
                            <select id="evaluationGroupSelect" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                                <option value="">সকল গ্রুপ</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                    <button id="startEvaluationBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">মূল্যায়ন শুরু করুন</button>
                </div>
                
                <div id="evaluationForm" class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                    <!-- Evaluation form will be loaded here -->
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mt-6">
                    <h3 class="text-lg font-bold mb-4">মূল্যায়ন তালিকা</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-gray-700">
                                    <th class="border border-gray-300 dark:border-gray-600 p-2">টাস্ক</th>
                                    <th class="border border-gray-300 dark:border-gray-600 p-2">গ্রুপ</th>
                                    <th class="border border-gray-300 dark:border-gray-600 p-2">তারিখ</th>
                                    <th class="border border-gray-300 dark:border-gray-600 p-2">মোট স্কোর</th>
                                    <th class="border border-gray-300 dark:border-gray-600 p-2">গড় স্কোর</th>
                                    <th class="border border-gray-300 dark:border-gray-600 p-2">কার্যক্রম</th>
                                </tr>
                            </thead>
                            <tbody id="evaluationListTable">
                                <!-- Evaluation list will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Group Policy Page -->
            <div id="page-group-policy" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                    <h3 class="text-lg font-bold mb-4">গ্রুপ নীতিমালা</h3>
                    <div id="policySections" class="space-y-4">
                        <!-- Policy sections will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Export Page -->
            <div id="page-export" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-6">
                    <h3 class="text-lg font-bold mb-4">CSV ইম্পোর্ট</h3>
                    <div class="mb-4">
                        <p class="mb-2">শিক্ষার্থী ডেটা CSV ফাইল থেকে ইম্পোর্ট করুন:</p>
                        <div class="flex flex-col md:flex-row gap-4 items-center">
                            <input id="csvFileInput" type="file" accept=".csv" class="hidden">
                            <button id="importStudentsBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">CSV ফাইল নির্বাচন করুন</button>
                            <span id="csvFileName" class="text-gray-600 dark:text-gray-400">কোন ফাইল নির্বাচন করা হয়নি</span>
                            <button id="processImportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg hidden">ইম্পোর্ট করুন</button>
                        </div>
                    </div>
                    <div>
                        <button id="downloadTemplateBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">CSV টেমপ্লেট ডাউনলোড</button>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
                    <h3 class="text-lg font-bold mb-4">ডেটা এক্সপোর্ট</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button id="exportAllData" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg flex flex-col items-center justify-center">
                            <i class="fas fa-file-archive text-2xl mb-2"></i>
                            <span>সমস্ত ডেটা (ZIP)</span>
                        </button>
                        <button id="exportStudentsCSV" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg flex flex-col items-center justify-center">
                            <i class="fas fa-users text-2xl mb-2"></i>
                            <span>শিক্ষার্থী CSV</span>
                        </button>
                        <button id="exportGroupsCSV" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg flex flex-col items-center justify-center">
                            <i class="fas fa-layer-group text-2xl mb-2"></i>
                            <span>গ্রুপ CSV</span>
                        </button>
                        <button id="exportEvaluationsCSV" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-3 rounded-lg flex flex-col items-center justify-center">
                            <i class="fas fa-clipboard-check text-2xl mb-2"></i>
                            <span>মূল্যায়ন CSV</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Admin Management Page -->
            <div id="page-admin-management" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">অ্যাডমিন ব্যবস্থাপনা</h3>
                        <button id="addAdminBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">নতুন অ্যাডমিন</button>
                    </div>
                    <div class="mb-4">
                        <input id="adminSearchInput" type="text" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" placeholder="অ্যাডমিন খুঁজুন">
                    </div>
                    <div id="adminManagementContent">
                        <!-- Admin management content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkw1kL7AU73Y9FWrPZ-ERv5xFvXGGILBA",
            authDomain: "claritybudget-6lnmd.firebaseapp.com",
            projectId: "claritybudget-6lnmd",
            storageBucket: "claritybudget-6lnmd.firebasestorage.app",
            messagingSenderId: "40318182466",
            appId: "1:40318182466:web:c2ce0637f8f23afa95b9db",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
    </script>
    
    <script>
        // app.js - COMPLETE FIXED VERSION WITH ALL FEATURES
        class CacheManager {
            constructor() {
                this.CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
                this.PREFIX = 'smart_evaluator_';
                this.forceRefresh = false;
            }

            set(key, data, customDuration = null) {
                const cacheData = {
                    data,
                    timestamp: Date.now(),
                    expires: Date.now() + (customDuration || this.CACHE_DURATION)
                };
                try {
                    localStorage.setItem(this.PREFIX + key, JSON.stringify(cacheData));
                } catch (e) {
                    this.clearOldest();
                    localStorage.setItem(this.PREFIX + key, JSON.stringify(cacheData));
                }
            }

            get(key) {
                const cached = localStorage.getItem(this.PREFIX + key);
                if (!cached || this.forceRefresh) return null;

                try {
                    const cacheData = JSON.parse(cached);
                    const { data, expires } = cacheData;
                    
                    if (Date.now() > expires) {
                        this.clear(key);
                        return null;
                    }
                    return data;
                } catch (e) {
                    this.clear(key);
                    return null;
                }
            }

            clear(key) {
                localStorage.removeItem(this.PREFIX + key);
            }

            clearAll() {
                Object.keys(localStorage)
                    .filter(key => key.startsWith(this.PREFIX))
                    .forEach(key => localStorage.removeItem(key));
            }

            clearOldest() {
                const keys = Object.keys(localStorage).filter(key => key.startsWith(this.PREFIX));
                if (keys.length > 50) {
                    const sorted = keys.map(key => ({
                        key,
                        timestamp: JSON.parse(localStorage.getItem(key)).timestamp
                    })).sort((a, b) => a.timestamp - b.timestamp);
                    
                    sorted.slice(0, 10).forEach(item => this.clear(item.key));
                }
            }
        }

        class SmartGroupEvaluator {
            constructor() {
                this.cache = new CacheManager();
                this.currentUser = null;
                this.isPublicMode = true;
                this.currentChart = null;
                this.isInitialized = false;
                
                this.state = {
                    groups: [],
                    students: [],
                    tasks: [],
                    evaluations: [],
                    admins: [],
                    problemStats: {}
                };

                this.filters = {
                    membersFilterGroupId: "",
                    membersSearchTerm: "",
                    cardsFilterGroupId: "",
                    cardsSearchTerm: "",
                    groupMembersFilterGroupId: "",
                    analysisFilterGroupIds: [],
                    adminSearchTerm: ""
                };

                this.PUBLIC_PAGES = ['dashboard', 'all-students', 'group-policy', 'export', 'student-ranking', 'group-analysis'];
                this.PRIVATE_PAGES = ['groups', 'members', 'group-members', 'tasks', 'evaluation', 'admin-management'];

                this.evaluationOptions = [
                    { id: 'cannot_do', text: 'আমি এই টপিক ্এখনো পারিনা', marks: -5 },
                    { id: 'learned_cannot_write', text: 'আমি এই টপিক শুধুমাত্র বুঝেছি কিন্তু ভালো করে শেখা হয়নি', marks: 5 },
                    { id: 'learned_can_write', text: 'আমি এই টপিক বুঝেছি ও ভালো করে শিখেছি', marks: 10 },
                    { id: 'weekly_homework', text: 'আমি বাড়ির কাজ সপ্তাহে প্রতিদিন করেছি', marks: 5 },
                    { id: 'weekly_attendance', text: 'আমি সপ্তাহে প্রতিদিন উপস্থিত ছিলাম', marks: 5 }
                ];

                this.roleNames = {
                    "team-leader": "টিম লিডার",
                    "time-keeper": "টাইম কিপার", 
                    "reporter": "রিপোর্টার",
                    "resource-manager": "রিসোর্স ম্যানেজার",
                    "peace-maker": "পিস মেকার",
                };

                this.policySections = [
                    {
                        title: "গ্রুপ সদস্য নিয়মাবলী",
                        content: "১. প্রতিটি গ্রুপে সর্বোচ্চ ৫ জন সদস্য থাকবে।\n২. প্রত্যেক সদস্যের একটি নির্দিষ্ট দায়িত্ব থাকবে।\n৩. গ্রুপ লিডার দায়িত্ব পালন নিশ্চিত করবে।\n৪. সকল সদস্যকে সাপ্তাহিক মিটিং এ উপস্থিত থাকতে হবে।\n৫. গ্রুপ কাজ সময়মতো জমা দিতে হবে।"
                    },
                    {
                        title: "মূল্যায়ন পদ্ধতি",
                        content: "১. টাস্ক সম্পূর্ণতা - ৪০%\n২. টিমওয়ার্ক - ৩০%\n৩. সময়ানুবর্তিতা - ২০%\n৪. অতিরিক্ত কাজ - ১০%\n৫. উপস্থিতি - বোনাস পয়েন্ট\n৬. বাড়ির কাজ - বোনাস পয়েন্ট"
                    },
                    {
                        title: "স্কোরিং সিস্টেম",
                        content: "টাস্ক স্কোর: ০-১০০ পয়েন্ট\nটিমওয়ার্ক: ০-১০ পয়েন্ট\nঅতিরিক্ত পয়েন্ট: বিশেষ কৃতিত্বের জন্য\nনেগেটিভ পয়েন্ট: দায়িত্ব পালনে ব্যর্থতা\nবোনাস পয়েন্ট: অতিরিক্ত কাজের জন্য"
                    },
                    {
                        title: "গ্রুপ লিডারের দায়িত্ব",
                        content: "১. গ্রুপ মিটিং পরিচালনা\n২. কাজ বণ্টন করা\n৩. প্রোগ্রেস ট্র্যাক করা\n৪. সমস্যা সমাধান করা\n৫. রিপোর্ট তৈরি করা"
                    },
                    {
                        title: "সদস্যদের দায়িত্ব",
                        content: "১. নির্দিষ্ট কাজ সময়মতো করা\n২. গ্রুপ মিটিং এ উপস্থিত থাকা\n৩. অন্যান্য সদস্যদের সহযোগিতা করা\n৪. সমস্যা হলে লিডারকে জানানো\n৫. গ্রুপের উন্নতির জন্য পরামর্শ দেওয়া"
                    }
                ];

                this.deleteCallback = null;
                this.editCallback = null;
                this.currentEditingAdmin = null;
                this.currentEvaluation = null;
                this.csvImportData = null;

                // Initialize debouncers
                this.searchDebouncer = this.createDebouncer(300);

                this.init();
            }

            createDebouncer(delay) {
                let timeoutId;
                return (callback) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(callback, delay);
                };
            }

            async init() {
                this.setupDOMReferences();
                await this.initializeFirebase();
                this.setupEventListeners();
                this.setupAuthStateListener();
                this.applySavedTheme();
                this.isInitialized = true;
            }

            async initializeFirebase() {
                try {
                    // Test Firebase connection
                    await db.collection('groups').limit(1).get();
                    console.log('Firebase connected successfully');
                } catch (error) {
                    console.error('Firebase connection failed:', error);
                    this.showToast('ডেটাবেস সংযোগ ব্যর্থ', 'error');
                }
            }

            setupDOMReferences() {
                // Core DOM elements
                this.dom = {
                    authModal: document.getElementById("authModal"),
                    appContainer: document.getElementById("appContainer"),
                    loginForm: document.getElementById("loginForm"),
                    registerForm: document.getElementById("registerForm"),
                    showRegister: document.getElementById("showRegister"),
                    showLogin: document.getElementById("showLogin"),
                    loginBtn: document.getElementById("loginBtn"),
                    registerBtn: document.getElementById("registerBtn"),
                    googleSignInBtn: document.getElementById("googleSignInBtn"),
                    logoutBtn: document.getElementById("logoutBtn"),
                    themeToggle: document.getElementById("themeToggle"),
                    mobileMenuBtn: document.getElementById("mobileMenuBtn"),
                    sidebar: document.querySelector(".sidebar"),
                    pageTitle: document.getElementById("pageTitle"),
                    userInfo: document.getElementById("userInfo"),
                    adminManagementSection: document.getElementById("adminManagementSection"),
                    pages: document.querySelectorAll(".page"),
                    navBtns: document.querySelectorAll(".nav-btn"),
                    
                    // Modals
                    logoutModal: document.getElementById("logoutModal"),
                    cancelLogout: document.getElementById("cancelLogout"),
                    confirmLogout: document.getElementById("confirmLogout"),
                    deleteModal: document.getElementById("deleteModal"),
                    cancelDelete: document.getElementById("cancelDelete"),
                    confirmDelete: document.getElementById("confirmDelete"),
                    editModal: document.getElementById("editModal"),
                    cancelEdit: document.getElementById("cancelEdit"),
                    saveEdit: document.getElementById("saveEdit"),
                    editModalTitle: document.getElementById("editModalTitle"),
                    editModalContent: document.getElementById("editModalContent"),
                    deleteModalText: document.getElementById("deleteModalText"),
                    groupDetailsModal: document.getElementById("groupDetailsModal"),
                    groupDetailsTitle: document.getElementById("groupDetailsTitle"),
                    groupDetailsContent: document.getElementById("groupDetailsContent"),
                    closeGroupDetails: document.getElementById("closeGroupDetails"),
                    adminModal: document.getElementById("adminModal"),
                    adminModalTitle: document.getElementById("adminModalTitle"),
                    adminModalContent: document.getElementById("adminModalContent"),
                    
                    // UI Elements
                    loadingOverlay: document.getElementById("loadingOverlay"),
                    toast: document.getElementById("toast"),
                    toastMessage: document.getElementById("toastMessage"),

                    // Form elements
                    groupNameInput: document.getElementById("groupNameInput"),
                    addGroupBtn: document.getElementById("addGroupBtn"),
                    groupsList: document.getElementById("groupsList"),
                    studentNameInput: document.getElementById("studentNameInput"),
                    studentRollInput: document.getElementById("studentRollInput"),
                    studentGenderInput: document.getElementById("studentGenderInput"),
                    studentGroupInput: document.getElementById("studentGroupInput"),
                    studentContactInput: document.getElementById("studentContactInput"),
                    studentAcademicGroupInput: document.getElementById("studentAcademicGroupInput"),
                    studentSessionInput: document.getElementById("studentSessionInput"),
                    studentRoleInput: document.getElementById("studentRoleInput"),
                    addStudentBtn: document.getElementById("addStudentBtn"),
                    studentsList: document.getElementById("studentsList"),
                    allStudentsCards: document.getElementById("allStudentsCards"),
                    tasksList: document.getElementById("tasksList"),
                    taskNameInput: document.getElementById("taskNameInput"),
                    taskDescriptionInput: document.getElementById("taskDescriptionInput"),
                    taskMaxScoreInput: document.getElementById("taskMaxScoreInput"),
                    taskDateInput: document.getElementById("taskDateInput"),
                    addTaskBtn: document.getElementById("addTaskBtn"),
                    evaluationTaskSelect: document.getElementById("evaluationTaskSelect"),
                    evaluationGroupSelect: document.getElementById("evaluationGroupSelect"),
                    startEvaluationBtn: document.getElementById("startEvaluationBtn"),
                    evaluationForm: document.getElementById("evaluationForm"),
                    csvFileInput: document.getElementById("csvFileInput"),
                    importStudentsBtn: document.getElementById("importStudentsBtn"),
                    processImportBtn: document.getElementById("processImportBtn"),
                    csvFileName: document.getElementById("csvFileName"),
                    downloadTemplateBtn: document.getElementById("downloadTemplateBtn"),
                    membersFilterGroup: document.getElementById("membersFilterGroup"),
                    studentSearchInput: document.getElementById("studentSearchInput"),
                    cardsFilterGroup: document.getElementById("cardsFilterGroup"),
                    allStudentsSearchInput: document.getElementById("allStudentsSearchInput"),
                    refreshRanking: document.getElementById("refreshRanking"),
                    studentRankingList: document.getElementById("studentRankingList"),
                    groupAnalysisChart: document.getElementById("groupAnalysisChart"),
                    policySections: document.getElementById("policySections"),
                    exportAllData: document.getElementById("exportAllData"),
                    exportStudentsCSV: document.getElementById("exportStudentsCSV"),
                    exportGroupsCSV: document.getElementById("exportGroupsCSV"),
                    exportEvaluationsCSV: document.getElementById("exportEvaluationsCSV"),
                    groupMembersGroupSelect: document.getElementById("groupMembersGroupSelect"),
                    groupMembersList: document.getElementById("groupMembersList"),

                    // Admin Management
                    adminManagementContent: document.getElementById("adminManagementContent"),
                    addAdminBtn: document.getElementById("addAdminBtn"),
                    adminSearchInput: document.getElementById("adminSearchInput"),
                    adminEmail: document.getElementById("adminEmail"),
                    adminPassword: document.getElementById("adminPassword"),
                    adminTypeSelect: document.getElementById("adminTypeSelect"),
                    permissionsSection: document.getElementById("permissionsSection"),
                    permissionRead: document.getElementById("permissionRead"),
                    permissionWrite: document.getElementById("permissionWrite"),
                    permissionDelete: document.getElementById("permissionDelete"),
                    cancelAdmin: document.getElementById("cancelAdmin"),
                    saveAdmin: document.getElementById("saveAdmin"),

                    // Evaluation List
                    evaluationListTable: document.getElementById("evaluationListTable"),

                    // Group Analysis
                    analysisGroupSelect: document.getElementById("analysisGroupSelect"),
                    updateAnalysisBtn: document.getElementById("updateAnalysisBtn"),
                    groupAnalysisDetails: document.getElementById("groupAnalysisDetails")
                };
            }

            setupEventListeners() {
                // Auth events
                this.addListener(this.dom.showRegister, 'click', () => this.toggleAuthForms());
                this.addListener(this.dom.showLogin, 'click', () => this.toggleAuthForms(false));
                this.addListener(this.dom.loginBtn, 'click', () => this.handleLogin());
                this.addListener(this.dom.registerBtn, 'click', () => this.handleRegister());
                this.addListener(this.dom.googleSignInBtn, 'click', () => this.handleGoogleSignIn());

                // Logout events
                this.addListener(this.dom.logoutBtn, 'click', () => this.showLogoutModal());
                this.addListener(this.dom.cancelLogout, 'click', () => this.hideLogoutModal());
                this.addListener(this.dom.confirmLogout, 'click', () => this.handleLogout());

                // Modal events
                this.addListener(this.dom.cancelDelete, 'click', () => this.hideDeleteModal());
                this.addListener(this.dom.confirmDelete, 'click', () => {
                    if (this.deleteCallback) this.deleteCallback();
                    this.hideDeleteModal();
                });
                this.addListener(this.dom.cancelEdit, 'click', () => this.hideEditModal());
                this.addListener(this.dom.saveEdit, 'click', () => {
                    if (this.editCallback) this.editCallback();
                    this.hideEditModal();
                });
                this.addListener(this.dom.closeGroupDetails, 'click', () => this.hideGroupDetailsModal());

                // Admin Management events
                this.addListener(this.dom.addAdminBtn, 'click', () => this.showAdminModal());
                this.addListener(this.dom.cancelAdmin, 'click', () => this.hideAdminModal());
                this.addListener(this.dom.saveAdmin, 'click', () => this.saveAdmin());
                this.addListener(this.dom.adminTypeSelect, 'change', (e) => this.handleAdminTypeChange(e));

                // Group Analysis events
                this.addListener(this.dom.updateAnalysisBtn, 'click', () => this.updateGroupAnalysis());

                // Theme and mobile menu
                this.addListener(this.dom.themeToggle, 'click', () => this.toggleTheme());
                this.addListener(this.dom.mobileMenuBtn, 'click', () => this.toggleMobileMenu());

                // Navigation
                this.dom.navBtns.forEach(btn => {
                    this.addListener(btn, 'click', (e) => this.handleNavigation(e));
                });

                // CRUD Operations
                this.addListener(this.dom.addGroupBtn, 'click', () => this.addGroup());
                this.addListener(this.dom.addStudentBtn, 'click', () => this.addStudent());
                this.addListener(this.dom.addTaskBtn, 'click', () => this.addTask());
                this.addListener(this.dom.startEvaluationBtn, 'click', () => this.startEvaluation());

                // CSV Operations
                this.addListener(this.dom.importStudentsBtn, 'click', () => this.importCSV());
                this.addListener(this.dom.processImportBtn, 'click', () => this.processCSVImport());
                this.addListener(this.dom.csvFileInput, 'change', (e) => this.handleCSVFileSelect(e));
                this.addListener(this.dom.downloadTemplateBtn, 'click', () => this.downloadCSVTemplate());

                // Export Operations
                this.addListener(this.dom.exportAllData, 'click', () => this.exportAllData());
                this.addListener(this.dom.exportStudentsCSV, 'click', () => this.exportStudentsCSV());
                this.addListener(this.dom.exportGroupsCSV, 'click', () => this.exportGroupsCSV());
                this.addListener(this.dom.exportEvaluationsCSV, 'click', () => this.exportEvaluationsCSV());

                // Refresh
                this.addListener(this.dom.refreshRanking, 'click', () => this.refreshRanking());

                // Search and filter events
                this.setupSearchAndFilterEvents();
                this.setupModalCloseHandlers();
            }

            addListener(element, event, handler) {
                if (element) {
                    element.addEventListener(event, handler);
                }
            }

            setupSearchAndFilterEvents() {
                // Search functionality with debouncing
                const searchInputs = [
                    { id: 'studentSearchInput', callback: (value) => this.handleStudentSearch(value) },
                    { id: 'allStudentsSearchInput', callback: (value) => this.handleAllStudentsSearch(value) },
                    { id: 'adminSearchInput', callback: (value) => this.handleAdminSearch(value) }
                ];

                searchInputs.forEach(({id, callback}) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', (e) => {
                            this.searchDebouncer(() => callback(e.target.value));
                        });
                    }
                });

                // Filter events
                const groupFilters = [
                    { id: 'membersFilterGroup', callback: (value) => this.handleMembersFilter(value) },
                    { id: 'cardsFilterGroup', callback: (value) => this.handleCardsFilter(value) },
                    { id: 'groupMembersGroupSelect', callback: (value) => this.handleGroupMembersFilter(value) }
                ];

                groupFilters.forEach(({id, callback}) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', (e) => callback(e.target.value));
                    }
                });
            }

            setupModalCloseHandlers() {
                const modals = [
                    this.dom.authModal, this.dom.deleteModal, this.dom.editModal, 
                    this.dom.logoutModal, this.dom.groupDetailsModal, this.dom.adminModal
                ];
                
                modals.forEach(modal => {
                    if (modal) {
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                this.hideModal(modal);
                            }
                        });
                    }
                });
            }

            // ===============================
            // AUTHENTICATION - FIXED AUTO LOGIN/LOGOUT
            // ===============================
            setupAuthStateListener() {
                auth.onAuthStateChanged(async (user) => {
                    console.log('Auth State Changed:', user);
                    this.currentUser = user;
                    
                    if (user) {
                        console.log('User automatically logged in:', user.email);
                        await this.handleAutoLogin(user);
                    } else {
                        console.log('User automatically logged out');
                        await this.handleAutoLogout();
                    }
                });
            }

            async handleAutoLogin(user) {
                this.isPublicMode = false;
                
                // Update UI immediately
                this.updateAuthUI(false);
                
                try {
                    const userData = await this.getUserAdminData(user);
                    this.updateUserInterface(userData);
                    
                    // Load all data for authenticated user
                    await this.loadInitialData();
                    
                    // Update dashboard with fresh data
                    if (document.getElementById('page-dashboard') && !document.getElementById('page-dashboard').classList.contains('hidden')) {
                        await this.loadDashboard();
                    }
                    
                    this.showToast(`স্বয়ংক্রিয় লগইন সফল! ${user.email}`, 'success');
                    
                } catch (error) {
                    console.error("Auto login handling error:", error);
                    this.showToast('স্বয়ংক্রিয় লগইন সম্পন্ন কিন্তু ডেটা লোড করতে সমস্যা', 'warning');
                }
            }

            async handleAutoLogout() {
                this.isPublicMode = true;
                this.currentUser = null;
                
                // Update UI immediately
                this.updateAuthUI(true);
                
                // Clear all cached data
                this.cache.clearAll();
                
                // Reset UI state
                this.updateUserInterface(null);
                
                // Load public data
                await this.loadPublicData();
                
                this.showToast('স্বয়ংক্রিয় লগআউট সম্পন্ন', 'info');
            }

            updateAuthUI(showAuthModal) {
                if (showAuthModal) {
                    // Show auth modal, hide app
                    if (this.dom.authModal) this.dom.authModal.classList.remove('hidden');
                    if (this.dom.appContainer) this.dom.appContainer.classList.add('hidden');
                } else {
                    // Hide auth modal, show app
                    if (this.dom.authModal) this.dom.authModal.classList.add('hidden');
                    if (this.dom.appContainer) this.dom.appContainer.classList.remove('hidden');
                }
            }

            async handleLogin() {
                const email = document.getElementById("loginEmail")?.value.trim();
                const password = document.getElementById("loginPassword")?.value;
                
                // Enhanced validation
                if (!email || !password) {
                    this.showToast("ইমেইল এবং পাসওয়ার্ড প্রয়োজন", "error");
                    return;
                }

                if (!this.validateEmail(email)) {
                    this.showToast("সঠিক ইমেইল ঠিকানা লিখুন", "error");
                    return;
                }

                if (password.length < 6) {
                    this.showToast("পাসওয়ার্ড ন্যূনতম ৬ অক্ষর হতে হবে", "error");
                    return;
                }

                this.showLoading();
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    // Clear form fields on success
                    if (document.getElementById("loginEmail")) document.getElementById("loginEmail").value = '';
                    if (document.getElementById("loginPassword")) document.getElementById("loginPassword").value = '';
                } catch (error) {
                    this.handleAuthError(error, 'login');
                } finally {
                    this.hideLoading();
                }
            }

            async handleRegister() {
                const email = document.getElementById("registerEmail")?.value.trim();
                const password = document.getElementById("registerPassword")?.value;
                const adminType = document.getElementById("adminType")?.value;

                if (!this.validateEmail(email)) {
                    this.showToast("সঠিক ইমেইল ঠিকানা লিখুন", "error");
                    return;
                }

                if (password.length < 6) {
                    this.showToast("পাসওয়ার্ড ন্যূনতম ৬ অক্ষর হতে হবে", "error");
                    return;
                }

                this.showLoading();
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    await db.collection("admins").doc(user.uid).set({
                        email,
                        type: adminType,
                        permissions: {
                            read: true,
                            write: true,
                            delete: adminType === 'super-admin'
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });

                    this.showToast("রেজিস্ট্রেশন সফল!", "success");
                    this.toggleAuthForms(false);
                    
                    // Clear form fields
                    if (document.getElementById("registerEmail")) document.getElementById("registerEmail").value = '';
                    if (document.getElementById("registerPassword")) document.getElementById("registerPassword").value = '';
                    
                } catch (error) {
                    this.handleAuthError(error, 'register');
                } finally {
                    this.hideLoading();
                }
            }

            async handleGoogleSignIn() {
                this.showLoading();
                try {
                    const result = await auth.signInWithPopup(googleProvider);
                    const user = result.user;
                    
                    const adminDoc = await db.collection("admins").doc(user.uid).get();
                    if (!adminDoc.exists) {
                        await db.collection("admins").doc(user.uid).set({
                            email: user.email,
                            type: "admin",
                            permissions: {
                                read: true,
                                write: true,
                                delete: false
                            },
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        });
                    }
                    this.showToast('Google লগইন সফল!', 'success');
                } catch (error) {
                    this.handleAuthError(error, 'google');
                } finally {
                    this.hideLoading();
                }
            }

            handleAuthError(error, type) {
                let errorMessage = "";
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = "এই ইমেইলে কোনো অ্যাকাউন্ট নেই";
                        break;
                    case 'auth/wrong-password':
                        errorMessage = "ভুল পাসওয়ার্ড";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "অবৈধ ইমেইল ঠিকানা";
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = "এই ইমেইল ইতিমধ্যে ব্যবহার করা হয়েছে";
                        break;
                    case 'auth/weak-password':
                        errorMessage = "পাসওয়ার্ড খুব দুর্বল";
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = "বহুবার চেষ্টা করা হয়েছে। পরে আবার চেষ্টা করুন";
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = "নেটওয়ার্ক সংযোগ ব্যর্থ";
                        break;
                    case 'auth/popup-closed-by-user':
                        errorMessage = "লগইন পপআপ বন্ধ করা হয়েছে";
                        break;
                    default:
                        errorMessage = `${type === 'login' ? 'লগইন' : type === 'register' ? 'রেজিস্ট্রেশন' : 'Google লগইন'} ব্যর্থ: ${error.message}`;
                }
                
                this.showToast(errorMessage, "error");
            }

            async handleLogout() {
                try {
                    await auth.signOut();
                    this.hideLogoutModal();
                } catch (error) {
                    console.error("Logout error:", error);
                    this.showToast("লগআউট করতে সমস্যা: " + error.message, "error");
                }
            }

            async getUserAdminData(user) {
                const cacheKey = `admin_${user.uid}`;
                const cached = this.cache.get(cacheKey);
                if (cached) return cached;

                try {
                    const byUid = await db.collection("admins").doc(user.uid).get();
                    if (byUid.exists) {
                        const data = byUid.data();
                        this.cache.set(cacheKey, data);
                        return data;
                    }

                    const byEmailSnap = await db.collection("admins").where("email", "==", user.email).limit(1).get();
                    if (!byEmailSnap.empty) {
                        const data = byEmailSnap.docs[0].data();
                        this.cache.set(cacheKey, data);
                        return data;
                    }

                    // Return basic user data if not in admin collection
                    return {
                        email: user.email,
                        type: "user",
                        permissions: { read: true, write: false, delete: false }
                    };
                } catch (error) {
                    console.error("Error fetching admin data:", error);
                    // Return basic access on error
                    return {
                        email: user.email,
                        type: "user",
                        permissions: { read: true, write: false, delete: false }
                    };
                }
            }

            // ===============================
            // PUBLIC ACCESS MANAGEMENT
            // ===============================
            async loadPublicData() {
                this.showLoading();
                try {
                    await Promise.all([
                        this.loadGroups(),
                        this.loadStudents(),
                        this.loadTasks(),
                        this.loadEvaluations()
                    ]);
                    this.populateSelects();
                    this.renderPolicySections();
                    
                    // Update dashboard if it's active
                    if (document.getElementById('page-dashboard') && !document.getElementById('page-dashboard').classList.contains('hidden')) {
                        await this.loadDashboard();
                    }
                    
                } catch (error) {
                    console.error("Public data load error:", error);
                    this.showToast('পাবলিক ডেটা লোড করতে সমস্যা', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            // ===============================
            // TOAST NOTIFICATIONS
            // ===============================
            showToast(message, type = 'success') {
                const toast = this.dom.toast;
                const toastMessage = this.dom.toastMessage;
                
                if (!toast || !toastMessage) return;

                // Set message and style based on type
                toastMessage.textContent = message;
                
                // Remove existing classes and add new ones
                toast.className = 'toast fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 transition-all duration-300';
                
                switch(type) {
                    case 'success':
                        toast.classList.add('bg-green-500', 'text-white');
                        break;
                    case 'error':
                        toast.classList.add('bg-red-500', 'text-white');
                        break;
                    case 'warning':
                        toast.classList.add('bg-yellow-500', 'text-white');
                        break;
                    case 'info':
                        toast.classList.add('bg-blue-500', 'text-white');
                        break;
                }

                // Show toast with animation
                toast.classList.remove('hidden', 'opacity-0', 'translate-x-full');
                toast.classList.add('flex', 'opacity-100', 'translate-x-0');

                // Auto hide after 4 seconds
                setTimeout(() => {
                    this.hideToast();
                }, 4000);
            }

            hideToast() {
                const toast = this.dom.toast;
                if (toast) {
                    toast.classList.add('opacity-0', 'translate-x-full');
                    setTimeout(() => {
                        toast.classList.add('hidden');
                        toast.classList.remove('flex', 'opacity-100', 'translate-x-0');
                    }, 300);
                }
            }

            // ===============================
            // MODAL MANAGEMENT
            // ===============================
            showLogoutModal() {
                this.showModal(this.dom.logoutModal);
            }

            hideLogoutModal() {
                this.hideModal(this.dom.logoutModal);
            }

            showDeleteModal(text, callback) {
                if (this.dom.deleteModalText) this.dom.deleteModalText.textContent = text;
                this.deleteCallback = callback;
                this.showModal(this.dom.deleteModal);
            }

            hideDeleteModal() {
                this.hideModal(this.dom.deleteModal);
            }

            showEditModal() {
                this.showModal(this.dom.editModal);
            }

            hideEditModal() {
                this.hideModal(this.dom.editModal);
            }

            showGroupDetailsModal(groupId) {
                const group = this.state.groups.find(g => g.id === groupId);
                if (!group) return;

                this.dom.groupDetailsTitle.textContent = `${group.name} - বিস্তারিত ফলাফল`;
                this.renderGroupDetails(groupId);
                this.showModal(this.dom.groupDetailsModal);
            }

            hideGroupDetailsModal() {
                this.hideModal(this.dom.groupDetailsModal);
            }

            showAdminModal(admin = null) {
                this.dom.adminModalTitle.textContent = admin ? 'অ্যাডমিন সম্পাদনা' : 'নতুন অ্যাডমিন';
                
                if (admin) {
                    this.dom.adminEmail.value = admin.email;
                    this.dom.adminPassword.value = '';
                    this.dom.adminTypeSelect.value = admin.type;
                    this.dom.permissionRead.checked = admin.permissions?.read || false;
                    this.dom.permissionWrite.checked = admin.permissions?.write || false;
                    this.dom.permissionDelete.checked = admin.permissions?.delete || false;
                    this.currentEditingAdmin = admin;
                } else {
                    this.dom.adminEmail.value = '';
                    this.dom.adminPassword.value = '';
                    this.dom.adminTypeSelect.value = 'admin';
                    this.dom.permissionRead.checked = true;
                    this.dom.permissionWrite.checked = true;
                    this.dom.permissionDelete.checked = false;
                    this.currentEditingAdmin = null;
                }
                
                this.handleAdminTypeChange({ target: this.dom.adminTypeSelect });
                this.showModal(this.dom.adminModal);
            }

            hideAdminModal() {
                this.hideModal(this.dom.adminModal);
                this.currentEditingAdmin = null;
            }

            showModal(modal) {
                if (modal) {
                    modal.classList.remove("hidden");
                }
            }

            hideModal(modal) {
                if (modal) {
                    modal.classList.add("hidden");
                }
            }

            // ===============================
            // DATA MANAGEMENT
            // ===============================
            async loadInitialData() {
                this.showLoading();
                try {
                    await Promise.all([
                        this.loadGroups(),
                        this.loadStudents(),
                        this.loadTasks(),
                        this.loadEvaluations(),
                        this.loadAdmins()
                    ]);
                    this.populateSelects();
                    this.renderPolicySections();
                } catch (error) {
                    console.error("Initial data load error:", error);
                    this.showToast("ডেটা লোড করতে সমস্যা", "error");
                } finally {
                    this.hideLoading();
                }
            }

            populateSelects() {
                // Populate student group select
                if (this.dom.studentGroupInput) {
                    this.dom.studentGroupInput.innerHTML = this.state.groups.map(g => 
                        `<option value="${g.id}">${g.name}</option>`
                    ).join('');
                }

                // Populate filter selects
                const filterSelects = ['membersFilterGroup', 'cardsFilterGroup', 'evaluationGroupSelect', 'groupMembersGroupSelect'];
                filterSelects.forEach(selectId => {
                    const element = document.getElementById(selectId);
                    if (element) {
                        element.innerHTML = '<option value="">সকল গ্রুপ</option>' + 
                            this.state.groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                    }
                });

                // Populate analysis group select (multiple)
                if (this.dom.analysisGroupSelect) {
                    this.dom.analysisGroupSelect.innerHTML = this.state.groups.map(g => 
                        `<option value="${g.id}">${g.name}</option>`
                    ).join('');
                }

                // Populate evaluation task select
                if (this.dom.evaluationTaskSelect) {
                    this.dom.evaluationTaskSelect.innerHTML = this.state.tasks.map(t => 
                        `<option value="${t.id}">${t.name}</option>`
                    ).join('');
                }
            }

            async loadGroups() {
                try {
                    const cacheKey = 'groups_data';
                    const cached = this.cache.get(cacheKey);
                    
                    if (!cached) {
                        const snap = await db.collection("groups").orderBy("name").get();
                        this.state.groups = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.cache.set(cacheKey, this.state.groups);
                    } else {
                        this.state.groups = cached;
                    }
                    
                    this.renderGroups();
                } catch (error) {
                    console.error("Error loading groups:", error);
                    const cached = this.cache.get('groups_data');
                    if (cached) this.state.groups = cached;
                    this.showToast('গ্রুপ লোড করতে সমস্যা', 'error');
                }
            }

            async loadStudents() {
                try {
                    const cacheKey = 'students_data';
                    const cached = this.cache.get(cacheKey);
                    
                    if (!cached) {
                        const snap = await db.collection("students").orderBy("name").get();
                        this.state.students = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.cache.set(cacheKey, this.state.students);
                    } else {
                        this.state.students = cached;
                    }
                    
                    this.renderStudentsList();
                    this.renderStudentCards();
                } catch (error) {
                    console.error("Error loading students:", error);
                    this.showToast('শিক্ষার্থী লোড করতে সমস্যা', 'error');
                }
            }

            async loadTasks() {
                try {
                    const cacheKey = 'tasks_data';
                    const cached = this.cache.get(cacheKey);
                    
                    if (!cached) {
                        const snap = await db.collection("tasks").orderBy("date", "desc").get();
                        this.state.tasks = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.cache.set(cacheKey, this.state.tasks);
                    } else {
                        this.state.tasks = cached;
                    }
                    
                    this.renderTasks();
                } catch (error) {
                    console.error("Error loading tasks:", error);
                    this.showToast('টাস্ক লোড করতে সমস্যা', 'error');
                }
            }

            async loadEvaluations() {
                try {
                    const cacheKey = 'evaluations_data';
                    const cached = this.cache.get(cacheKey);
                    
                    if (!cached) {
                        const snap = await db.collection("evaluations").get();
                        this.state.evaluations = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        this.cache.set(cacheKey, this.state.evaluations);
                    } else {
                        this.state.evaluations = cached;
                    }
                    
                    this.calculateProblemSolvingStats();
                    this.renderEvaluationList();
                } catch (error) {
                    console.error("Error loading evaluations:", error);
                    this.showToast('মূল্যায়ন লোড করতে সমস্যা', 'error');
                }
            }

            async loadAdmins() {
                if (!this.currentUser) return;
                
                try {
                    const userData = await this.getUserAdminData(this.currentUser);
                    if (userData && userData.type === 'super-admin') {
                        const cacheKey = 'admins_data';
                        const cached = this.cache.get(cacheKey);
                        
                        if (!cached) {
                            const snap = await db.collection("admins").get();
                            this.state.admins = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            this.cache.set(cacheKey, this.state.admins);
                        } else {
                            this.state.admins = cached;
                        }
                        
                        this.renderAdminManagement();
                    }
                } catch (error) {
                    console.error("Error loading admins:", error);
                }
            }

            // ===============================
            // RENDERING METHODS
            // ===============================
            renderGroups() {
                if (!this.dom.groupsList) return;
                
                const memberCountMap = this.computeMemberCountMap();
                
                this.dom.groupsList.innerHTML = this.state.groups.map(group => `
                    <div class="flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <div>
                            <div class="font-medium">${group.name}</div>
                            <div class="text-sm text-gray-500">সদস্য: ${memberCountMap[group.id] || 0} জন</div>
                        </div>
                        <div class="flex gap-2">
                            ${this.currentUser ? `
                                <button onclick="smartEvaluator.editGroup('${group.id}')" class="edit-group-btn px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg text-sm">সম্পাদনা</button>
                                <button onclick="smartEvaluator.deleteGroup('${group.id}')" class="delete-group-btn px-3 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg text-sm">ডিলিট</button>
                            ` : '<span class="text-sm text-gray-500">লগইন প্রয়োজন</span>'}
                        </div>
                    </div>
                `).join('');
            }

            renderStudentsList() {
                if (!this.dom.studentsList) return;

                const filteredStudents = this.getFilteredStudents();
                
                this.dom.studentsList.innerHTML = filteredStudents.map(student => {
                    const group = this.state.groups.find(g => g.id === student.groupId);
                    const roleBadge = student.role ? 
                        `<span class="member-role-badge ${student.role}">${this.roleNames[student.role] || student.role}</span>` : '';
                    return `
                        <div class="flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg">
                            <div>
                                <div class="font-medium">${student.name} ${roleBadge}</div>
                                <div class="text-sm text-gray-500">রোল: ${student.roll} | লিঙ্গ: ${student.gender} | গ্রুপ: ${group?.name || 'না'}</div>
                                <div class="text-sm text-gray-500">একাডেমিক: ${student.academicGroup || 'না'} | সেশন: ${student.session || 'না'}</div>
                            </div>
                            <div class="flex gap-2">
                                ${this.currentUser ? `
                                    <button onclick="smartEvaluator.editStudent('${student.id}')" class="edit-student-btn px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg text-sm">সম্পাদনা</button>
                                    <button onclick="smartEvaluator.deleteStudent('${student.id}')" class="delete-student-btn px-3 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg text-sm">ডিলিট</button>
                                ` : '<span class="text-sm text-gray-500">লগইন প্রয়োজন</span>'}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderStudentCards() {
                if (!this.dom.allStudentsCards) return;

                const filteredStudents = this.getFilteredStudents('cards');
                
                this.dom.allStudentsCards.innerHTML = filteredStudents.map((student, index) => {
                    const group = this.state.groups.find(g => g.id === student.groupId);
                    const bgClass = `student-card-bg-${(index % 8) + 1}`;
                    
                    const roleBadge = student.role ? 
                        `<span class="member-role-badge ${student.role}">${this.roleNames[student.role] || student.role}</span>` :
                        `<span class="px-2 py-1 text-xs rounded-md bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">দায়িত্ব বাকি</span>`;

                    return `
                        <div class="student-card ${bgClass} rounded-xl p-4 shadow-md relative overflow-hidden">
                            <span class="serial-number">${index + 1}</span>
                            <div class="flex items-start mb-3">
                                <div class="student-avatar ${student.gender === 'মেয়ে' ? 'bg-pink-500' : 'bg-blue-500'}">
                                    ${student.name.charAt(0)}
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg">${student.name}</h3>
                                    <div class="mt-1">${roleBadge}</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 gap-2 text-sm">
                                <p><i class="fas fa-id-card mr-2"></i> রোল: ${student.roll}</p>
                                <p><i class="fas fa-venus-mars mr-2"></i> লিঙ্গ: ${student.gender}</p>
                                <p><i class="fas fa-users mr-2"></i> গ্রুপ: ${group?.name || 'না'}</p>
                                <p><i class="fas fa-book mr-2"></i> একাডেমিক: ${student.academicGroup || 'না'}</p>
                                <p><i class="fas fa-calendar mr-2"></i> সেশন: ${student.session || 'না'}</p>
                                ${student.contact ? `<p><i class="fas fa-envelope mr-2"></i> ${student.contact}</p>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderTasks() {
                if (!this.dom.tasksList) return;

                this.dom.tasksList.innerHTML = this.state.tasks.map(task => {
                    const dateStr = task.date?.seconds ? 
                        new Date(task.date.seconds * 1000).toLocaleDateString("bn-BD") : 
                        'তারিখ নেই';
                        
                    return `
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
                            <div class="p-4 bg-gray-50 dark:bg-gray-800 flex justify-between items-center">
                                <div>
                                    <h3 class="font-semibold">${task.name}</h3>
                                    <p class="text-sm text-gray-500">তারিখ: ${dateStr} | সর্বোচ্চ স্কোর: ${task.maxScore}</p>
                                </div>
                                <div class="flex gap-2">
                                    ${this.currentUser ? `
                                        <button onclick="smartEvaluator.editTask('${task.id}')" class="edit-task-btn px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg text-sm">সম্পাদনা</button>
                                        <button onclick="smartEvaluator.deleteTask('${task.id}')" class="delete-task-btn px-3 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg text-sm">ডিলিট</button>
                                    ` : '<span class="text-sm text-gray-500">লগইন প্রয়োজন</span>'}
                                </div>
                            </div>
                            <div class="p-4">
                                <p class="text-gray-600 dark:text-gray-300">${task.description || 'কোন বিবরণ নেই'}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderEvaluationList() {
                if (!this.dom.evaluationListTable) return;

                this.dom.evaluationListTable.innerHTML = this.state.evaluations.map(evaluation => {
                    const task = this.state.tasks.find(t => t.id === evaluation.taskId);
                    const group = this.state.groups.find(g => g.id === evaluation.groupId);
                    const totalScore = this.calculateEvaluationTotalScore(evaluation);
                    const dateStr = evaluation.updatedAt?.seconds ? 
                        new Date(evaluation.updatedAt.seconds * 1000).toLocaleDateString("bn-BD") : 
                        'তারিখ নেই';

                    return `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td class="border border-gray-300 dark:border-gray-600 p-2">${task?.name || 'Unknown Task'}</td>
                            <td class="border border-gray-300 dark:border-gray-600 p-2">${group?.name || 'Unknown Group'}</td>
                            <td class="border border-gray-300 dark:border-gray-600 p-2">${dateStr}</td>
                            <td class="border border-gray-300 dark:border-gray-600 p-2 font-semibold">${totalScore}</td>
                            <td class="border border-gray-300 dark:border-gray-600 p-2 font-semibold">${totalScore}</td>
                            <td class="border border-gray-300 dark:border-gray-600 p-2">
                                <div class="flex gap-2">
                                    <button onclick="smartEvaluator.editEvaluation('${evaluation.id}')" class="edit-evaluation-btn px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg text-sm">সম্পাদনা</button>
                                    ${this.currentUser?.type === 'super-admin' ? `
                                        <button onclick="smartEvaluator.deleteEvaluation('${evaluation.id}')" class="delete-evaluation-btn px-3 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg text-sm">ডিলিট</button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            renderPolicySections() {
                if (!this.dom.policySections) return;

                this.dom.policySections.innerHTML = this.policySections.map((section, index) => `
                    <div class="policy-section">
                        <div class="policy-header" onclick="smartEvaluator.togglePolicySection(${index})">
                            <h4 class="font-semibold">${section.title}</h4>
                            <i class="fas fa-chevron-down transform transition-transform" id="policyIcon-${index}"></i>
                        </div>
                        <div class="policy-content" id="policyContent-${index}">
                            <div class="whitespace-pre-line">${section.content}</div>
                        </div>
                    </div>
                `).join('');
            }

            renderAdminManagement() {
                if (!this.dom.adminManagementContent) return;

                const filteredAdmins = this.getFilteredAdmins();
                
                this.dom.adminManagementContent.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-gray-700">
                                    <th class="border border-gray-300 dark:border-gray-600 p-2">ইমেইল</th>
                                    <th class="border border-gray-300 dark:border-gray-600 p-2">টাইপ</th>
                                    <th class="border border-gray-300 dark:border-gray-600 p-2">পারমিশন</th>
                                    <th class="border border-gray-300 dark:border-gray-600 p-2">কার্যক্রম</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredAdmins.map(admin => `
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800">
                                        <td class="border border-gray-300 dark:border-gray-600 p-2">${admin.email}</td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2">
                                            <span class="px-2 py-1 rounded text-xs ${
                                                admin.type === 'super-admin' 
                                                    ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' 
                                                    : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
                                            }">
                                                ${admin.type === 'super-admin' ? 'সুপার অ্যাডমিন' : 'সাধারণ অ্যাডমিন'}
                                            </span>
                                        </td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2">
                                            <div class="flex flex-wrap gap-1">
                                                <span class="px-2 py-1 rounded text-xs ${
                                                    admin.permissions?.read 
                                                        ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' 
                                                        : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                                                }">
                                                    রিড
                                                </span>
                                                <span class="px-2 py-1 rounded text-xs ${
                                                    admin.permissions?.write 
                                                        ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' 
                                                        : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                                                }">
                                                    এডিট
                                                </span>
                                                <span class="px-2 py-1 rounded text-xs ${
                                                    admin.permissions?.delete 
                                                        ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' 
                                                        : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                                                }">
                                                    ডিলিট
                                                </span>
                                            </div>
                                        </td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-2">
                                            <div class="flex gap-2">
                                                <button onclick="smartEvaluator.showAdminModal(${JSON.stringify(admin).replace(/"/g, '&quot;')})" class="edit-admin-btn px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg text-sm">
                                                    সম্পাদনা
                                                </button>
                                                ${admin.id !== this.currentUser.uid ? `
                                                    <button onclick="smartEvaluator.deleteAdmin('${admin.id}')" class="delete-admin-btn px-3 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg text-sm">
                                                        ডিলিট
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // ===============================
            // HELPER METHODS
            // ===============================
            getStudentsInGroup(groupId) {
                return this.state.students.filter(student => student.groupId === groupId);
            }

            computeMemberCountMap() {
                const map = {};
                this.state.groups.forEach(g => { map[g.id] = 0; });
                this.state.students.forEach(s => {
                    if (s.groupId) map[s.groupId] = (map[s.groupId] || 0) + 1;
                });
                return map;
            }

            getFilteredStudents(type = 'members') {
                let students = this.state.students;
                
                if (type === 'members') {
                    // Apply group filter
                    if (this.filters.membersFilterGroupId) {
                        students = students.filter(s => s.groupId === this.filters.membersFilterGroupId);
                    }
                    
                    // Apply search filter
                    if (this.filters.membersSearchTerm) {
                        const term = this.filters.membersSearchTerm.toLowerCase();
                        students = students.filter(s => 
                            s.name.toLowerCase().includes(term) ||
                            s.roll.toLowerCase().includes(term) ||
                            (s.academicGroup && s.academicGroup.toLowerCase().includes(term))
                        );
                    }
                } else if (type === 'cards') {
                    // Apply group filter
                    if (this.filters.cardsFilterGroupId) {
                        students = students.filter(s => s.groupId === this.filters.cardsFilterGroupId);
                    }
                    
                    // Apply search filter
                    if (this.filters.cardsSearchTerm) {
                        const term = this.filters.cardsSearchTerm.toLowerCase();
                        students = students.filter(s => 
                            s.name.toLowerCase().includes(term) ||
                            s.roll.toLowerCase().includes(term) ||
                            (s.academicGroup && s.academicGroup.toLowerCase().includes(term))
                        );
                    }
                }
                
                return students;
            }

            getFilteredAdmins() {
                let admins = this.state.admins;
                
                if (this.filters.adminSearchTerm) {
                    const term = this.filters.adminSearchTerm.toLowerCase();
                    admins = admins.filter(admin => 
                        admin.email.toLowerCase().includes(term) ||
                        admin.type.toLowerCase().includes(term)
                    );
                }
                
                return admins;
            }

            calculateStudentTotalScore(studentId) {
                const studentEvaluations = this.state.evaluations.filter(e => {
                    if (e.scores && e.scores[studentId]) {
                        return true;
                    }
                    return false;
                });
                
                let totalScore = 0;
                studentEvaluations.forEach(evaluation => {
                    if (evaluation.scores && evaluation.scores[studentId]) {
                        const score = evaluation.scores[studentId];
                        totalScore += (score.taskScore || 0) + (score.teamworkScore || 0);
                        
                        // Add option marks
                        if (score.optionMarks) {
                            Object.values(score.optionMarks).forEach(opt => {
                                if (opt.selected) {
                                    const optionDef = this.evaluationOptions.find(o => o.id === opt.optionId);
                                    if (optionDef) {
                                        totalScore += optionDef.marks;
                                    }
                                }
                            });
                        }
                    }
                });
                
                return totalScore;
            }

            calculateEvaluationTotalScore(evaluation) {
                if (!evaluation.scores) return 0;
                
                let total = 0;
                Object.values(evaluation.scores).forEach(score => {
                    let additionalMarks = 0;
                    if (score.optionMarks) {
                        Object.values(score.optionMarks).forEach(opt => {
                            if (opt.selected) {
                                const optDef = this.evaluationOptions.find(o => o.id === opt.optionId);
                                if (optDef) additionalMarks += optDef.marks;
                            }
                        });
                    }
                    
                    total += (score.taskScore || 0) + (score.teamworkScore || 0) + additionalMarks;
                });
                
                return total;
            }

            calculateProblemSolvingStats() {
                const stats = {
                    totalProblems: 0,
                    cannotDo: 0,
                    learnedCannotWrite: 0,
                    learnedCanWrite: 0,
                    weeklyHomework: 0,
                    weeklyAttendance: 0
                };

                this.state.evaluations.forEach(evalItem => {
                    if (!evalItem.scores) return;
                    Object.values(evalItem.scores).forEach(score => {
                        stats.totalProblems++;
                        if (score.optionMarks) {
                            Object.values(score.optionMarks).forEach(opt => {
                                if (opt.selected) {
                                    switch(opt.optionId) {
                                        case 'cannot_do': stats.cannotDo++; break;
                                        case 'learned_cannot_write': stats.learnedCannotWrite++; break;
                                        case 'learned_can_write': stats.learnedCanWrite++; break;
                                        case 'weekly_homework': stats.weeklyHomework++; break;
                                        case 'weekly_attendance': stats.weeklyAttendance++; break;
                                    }
                                }
                            });
                        }
                    });
                });

                this.state.problemStats = stats;
            }

            validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            // ===============================
            // UI MANAGEMENT
            // ===============================
            async handleNavigation(event) {
                const btn = event.currentTarget;
                const pageId = btn.getAttribute("data-page");

                // Check authentication for private pages
                if (!this.currentUser && this.PRIVATE_PAGES.includes(pageId)) {
                    this.showToast("এই পেজ দেখতে লগইন প্রয়োজন", "error");
                    return;
                }

                // Update navigation
                this.dom.navBtns.forEach(navBtn => {
                    navBtn.classList.remove("active");
                });
                btn.classList.add("active");

                // Show page
                this.dom.pages.forEach(page => page.classList.add("hidden"));
                const selectedPage = document.getElementById(`page-${pageId}`);
                if (selectedPage) {
                    selectedPage.classList.remove("hidden");
                    if (this.dom.pageTitle) this.dom.pageTitle.textContent = btn.textContent.trim();

                    // Load page-specific data
                    switch(pageId) {
                        case 'dashboard':
                            await this.loadDashboard();
                            break;
                        case 'groups':
                            this.renderGroups();
                            break;
                        case 'members':
                            this.renderStudentsList();
                            break;
                        case 'group-members':
                            this.renderGroupMembers();
                            break;
                        case 'all-students':
                            this.renderStudentCards();
                            break;
                        case 'student-ranking':
                            this.renderStudentRanking();
                            break;
                        case 'group-analysis':
                            this.renderGroupAnalysis();
                            break;
                        case 'tasks':
                            this.renderTasks();
                            break;
                        case 'evaluation':
                            this.renderEvaluationList();
                            break;
                        case 'group-policy':
                            this.renderPolicySections();
                            break;
                        case 'export':
                            // Export page doesn't need additional loading
                            break;
                        case 'admin-management':
                            await this.loadAdmins();
                            break;
                    }
                }
            }

            updateUserInterface(userData) {
                if (!this.dom.userInfo || !this.dom.logoutBtn) return;

                if (userData && this.currentUser) {
                    // User is logged in
                    this.dom.userInfo.innerHTML = `
                        <div class="font-medium">${userData.email}</div>
                        <div class="text-xs ${userData.type === "super-admin" ? "text-purple-600" : "text-gray-500"}">
                            ${userData.type === "super-admin" ? "সুপার অ্যাডমিন" : userData.type === "admin" ? "অ্যাডমিন" : "ব্যবহারকারী"}
                        </div>
                    `;
                    
                    // Show logout button
                    this.dom.logoutBtn.classList.remove('hidden');
                    
                    // Add user-logged-in class to body for CSS
                    document.body.classList.add('user-logged-in');
                    
                    // Show admin section if super admin
                    if (userData.type === "super-admin") {
                        if (this.dom.adminManagementSection) this.dom.adminManagementSection.classList.remove("hidden");
                    } else {
                        if (this.dom.adminManagementSection) this.dom.adminManagementSection.classList.add("hidden");
                    }
                } else {
                    // User is logged out
                    this.dom.userInfo.innerHTML = `<div class="text-xs text-gray-500">সাধারণ ব্যবহারকারী</div>`;
                    
                    // Hide logout button
                    this.dom.logoutBtn.classList.add('hidden');
                    
                    // Remove user-logged-in class
                    document.body.classList.remove('user-logged-in');
                    
                    // Hide admin section
                    if (this.dom.adminManagementSection) this.dom.adminManagementSection.classList.add("hidden");
                }
            }

            toggleAuthForms(showRegister = true) {
                if (this.dom.loginForm && this.dom.registerForm) {
                    if (showRegister) {
                        this.dom.loginForm.classList.add('hidden');
                        this.dom.registerForm.classList.remove('hidden');
                    } else {
                        this.dom.loginForm.classList.remove('hidden');
                        this.dom.registerForm.classList.add('hidden');
                    }
                }
            }

            toggleTheme() {
                const isDark = document.documentElement.classList.contains('dark');
                if (isDark) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
            }

            applySavedTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            toggleMobileMenu() {
                if (this.dom.sidebar) {
                    this.dom.sidebar.classList.toggle('hidden');
                }
            }

            showLoading(message = "লোড হচ্ছে...") {
                if (this.dom.loadingOverlay) {
                    this.dom.loadingOverlay.classList.remove("hidden");
                    const messageEl = this.dom.loadingOverlay.querySelector('p');
                    if (messageEl) messageEl.textContent = message;
                }
            }

            hideLoading() {
                if (this.dom.loadingOverlay) {
                    this.dom.loadingOverlay.classList.add("hidden");
                }
            }

            togglePolicySection(index) {
                const content = document.getElementById(`policyContent-${index}`);
                const icon = document.getElementById(`policyIcon-${index}`);
                
                if (content.classList.contains('open')) {
                    content.classList.remove('open');
                    icon.classList.remove('rotate-180');
                } else {
                    content.classList.add('open');
                    icon.classList.add('rotate-180');
                }
            }

            // ===============================
            // CRUD OPERATIONS
            // ===============================
            async addGroup() {
                const name = this.dom.groupNameInput?.value.trim();
                if (!name) {
                    this.showToast("গ্রুপের নাম লিখুন", "error");
                    return;
                }

                if (name.length > 50) {
                    this.showToast("গ্রুপ নাম ৫০ অক্ষরের মধ্যে হতে হবে", "error");
                    return;
                }

                this.showLoading();
                try {
                    await db.collection("groups").add({
                        name,
                        memberCount: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    if (this.dom.groupNameInput) this.dom.groupNameInput.value = "";
                    // Clear cache and reload data
                    this.cache.clear('groups_data');
                    await this.loadGroups();
                    this.showToast('গ্রুপ সফলভাবে যোগ করা হয়েছে', 'success');
                } catch (error) {
                    this.showToast("গ্রুপ যোগ করতে সমস্যা: " + error.message, "error");
                } finally {
                    this.hideLoading();
                }
            }

            async addStudent() {
                const studentData = this.getStudentFormData();
                if (!studentData) return;

                this.showLoading();
                try {
                    // Check uniqueness
                    const isDuplicate = await this.checkStudentUniqueness(studentData.roll, studentData.academicGroup);
                    if (isDuplicate) {
                        this.showToast("এই রোল ও একাডেমিক গ্রুপের শিক্ষার্থী ইতিমধ্যে আছে", "error");
                        this.hideLoading();
                        return;
                    }

                    await db.collection("students").add({
                        ...studentData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });

                    this.clearStudentForm();
                    // Clear cache and reload data
                    this.cache.clear('students_data');
                    await this.loadStudents();
                    this.renderGroups();
                    this.showToast('শিক্ষার্থী সফলভাবে যোগ করা হয়েছে', 'success');
                } catch (error) {
                    this.showToast("শিক্ষার্থী যোগ করতে সমস্যা: " + error.message, "error");
                } finally {
                    this.hideLoading();
                }
            }

            async addTask() {
                const taskData = this.getTaskFormData();
                if (!taskData) return;

                this.showLoading();
                try {
                    await db.collection("tasks").add({
                        ...taskData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                    this.clearTaskForm();
                    // Clear cache and reload data
                    this.cache.clear('tasks_data');
                    await this.loadTasks();
                    this.showToast('টাস্ক সফলভাবে যোগ করা হয়েছে', 'success');
                } catch (error) {
                    this.showToast("টাস্ক যোগ করতে সমস্যা: " + error.message, "error");
                } finally {
                    this.hideLoading();
                }
            }

            // ===============================
            // FORM DATA METHODS
            // ===============================
            getStudentFormData() {
                const name = this.dom.studentNameInput?.value.trim();
                const roll = this.dom.studentRollInput?.value.trim();
                const gender = this.dom.studentGenderInput?.value;
                const groupId = this.dom.studentGroupInput?.value;
                const contact = this.dom.studentContactInput?.value.trim();
                const academicGroup = this.dom.studentAcademicGroupInput?.value.trim();
                const session = this.dom.studentSessionInput?.value.trim();
                const role = this.dom.studentRoleInput?.value;

                if (!name || !roll || !gender || !groupId || !academicGroup || !session) {
                    this.showToast("সমস্ত প্রয়োজনীয় তথ্য পূরণ করুন", "error");
                    return null;
                }

                if (name.length > 100) {
                    this.showToast("নাম ১০০ অক্ষরের মধ্যে হতে হবে", "error");
                    return null;
                }

                if (roll.length > 20) {
                    this.showToast("রোল ২০ অক্ষরের মধ্যে হতে হবে", "error");
                    return null;
                }

                return {
                    name,
                    roll,
                    gender,
                    groupId,
                    contact,
                    academicGroup,
                    session,
                    role
                };
            }

            getTaskFormData() {
                const name = this.dom.taskNameInput?.value.trim();
                const description = this.dom.taskDescriptionInput?.value.trim();
                const maxScore = parseInt(this.dom.taskMaxScoreInput?.value);
                const dateStr = this.dom.taskDateInput?.value;

                if (!name || !description || isNaN(maxScore) || !dateStr) {
                    this.showToast("সমস্ত তথ্য পূরণ করুন", "error");
                    return null;
                }

                if (name.length > 100) {
                    this.showToast("টাস্ক নাম ১০০ অক্ষরের মধ্যে হতে হবে", "error");
                    return null;
                }

                if (description.length > 500) {
                    this.showToast("বিবরণ ৫০০ অক্ষরের মধ্যে হতে হবে", "error");
                    return null;
                }

                if (maxScore < 1 || maxScore > 1000) {
                    this.showToast("সর্বোচ্চ স্কোর ১-১০০০ এর মধ্যে হতে হবে", "error");
                    return null;
                }

                return { 
                    name, 
                    description, 
                    maxScore, 
                    date: new Date(dateStr) 
                };
            }

            clearStudentForm() {
                const fields = [
                    'studentNameInput', 'studentRollInput', 'studentContactInput', 
                    'studentAcademicGroupInput', 'studentSessionInput'
                ];
                fields.forEach(field => {
                    if (this.dom[field]) this.dom[field].value = '';
                });
            }

            clearTaskForm() {
                if (this.dom.taskNameInput) this.dom.taskNameInput.value = '';
                if (this.dom.taskDescriptionInput) this.dom.taskDescriptionInput.value = '';
                if (this.dom.taskMaxScoreInput) this.dom.taskMaxScoreInput.value = '';
                if (this.dom.taskDateInput) this.dom.taskDateInput.value = '';
            }

            // ===============================
            // EDIT OPERATIONS
            // ===============================
            async editStudent(id) {
                const student = this.state.students.find(s => s.id === id);
                if (!student) return;

                this.dom.editModalTitle.textContent = 'শিক্ষার্থী সম্পাদনা';
                this.dom.editModalContent.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">নাম</label>
                            <input id="editName" type="text" value="${student.name}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" maxlength="100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">রোল</label>
                            <input id="editRoll" type="text" value="${student.roll}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" maxlength="20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">লিঙ্গ</label>
                            <select id="editGender" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                                <option value="ছেলে" ${student.gender === 'ছেলে' ? 'selected' : ''}>ছেলে</option>
                                <option value="মেয়ে" ${student.gender === 'মেয়ে' ? 'selected' : ''}>মেয়ে</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">গ্রুপ</label>
                            <select id="editGroup" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                                ${this.state.groups.map(g => `<option value="${g.id}" ${student.groupId === g.id ? 'selected' : ''}>${g.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">যোগাযোগ</label>
                            <input id="editContact" type="text" value="${student.contact || ''}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" maxlength="100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">একাডেমিক গ্রুপ</label>
                            <input id="editAcademicGroup" type="text" value="${student.academicGroup || ''}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" maxlength="50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">সেশন</label>
                            <input id="editSession" type="text" value="${student.session || ''}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" maxlength="20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">দায়িত্ব</label>
                            <select id="editRole" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                                <option value="">কোনোটি না</option>
                                ${Object.entries(this.roleNames).map(([key, value]) => `<option value="${key}" ${student.role === key ? 'selected' : ''}>${value}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `;

                this.editCallback = async () => {
                    const newData = {
                        name: document.getElementById('editName').value.trim(),
                        roll: document.getElementById('editRoll').value.trim(),
                        gender: document.getElementById('editGender').value,
                        groupId: document.getElementById('editGroup').value,
                        contact: document.getElementById('editContact').value.trim(),
                        academicGroup: document.getElementById('editAcademicGroup').value.trim(),
                        session: document.getElementById('editSession').value.trim(),
                        role: document.getElementById('editRole').value
                    };

                    if (!newData.name || !newData.roll || !newData.gender || !newData.groupId || !newData.academicGroup || !newData.session) {
                        this.showToast('সমস্ত প্রয়োজনীয় তথ্য পূরণ করুন', 'error');
                        return;
                    }

                    const rollChanged = newData.roll !== student.roll;
                    const academicChanged = newData.academicGroup !== student.academicGroup;

                    if ((rollChanged || academicChanged) && await this.checkStudentUniqueness(newData.roll, newData.academicGroup, id)) {
                        this.showToast('এই রোল ও একাডেমিক গ্রুপের শিক্ষার্থী ইতিমধ্যে আছে', 'error');
                        return;
                    }

                    this.showLoading();
                    try {
                        await db.collection('students').doc(id).update(newData);
                        // Clear cache and reload data
                        this.cache.clear('students_data');
                        await this.loadStudents();
                        this.showToast('শিক্ষার্থী সফলভাবে আপডেট করা হয়েছে', 'success');
                    } catch (error) {
                        this.showToast('সম্পাদনা ব্যর্থ: ' + error.message, 'error');
                    } finally {
                        this.hideLoading();
                    }
                };

                this.showEditModal();
            }

            async editGroup(id) {
                const group = this.state.groups.find(g => g.id === id);
                if (!group) return;

                this.dom.editModalTitle.textContent = 'গ্রুপ সম্পাদনা';
                this.dom.editModalContent.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">গ্রুপ নাম</label>
                        <input id="editGroupName" type="text" value="${group.name}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" maxlength="50">
                    </div>
                `;

                this.editCallback = async () => {
                    const name = document.getElementById('editGroupName').value.trim();
                    if (!name) {
                        this.showToast('নাম লিখুন', 'error');
                        return;
                    }
                    this.showLoading();
                    try {
                        await db.collection('groups').doc(id).update({ name });
                        // Clear cache and reload data
                        this.cache.clear('groups_data');
                        await this.loadGroups();
                        this.showToast('গ্রুপ সফলভাবে আপডেট করা হয়েছে', 'success');
                    } catch (error) {
                        this.showToast('সম্পাদনা ব্যর্থ: ' + error.message, 'error');
                    } finally {
                        this.hideLoading();
                    }
                };

                this.showEditModal();
            }

            async editTask(id) {
                const task = this.state.tasks.find(t => t.id === id);
                if (!task) return;

                const dateStr = task.date?.seconds ? new Date(task.date.seconds * 1000).toISOString().split('T')[0] : '';

                this.dom.editModalTitle.textContent = 'টাস্ক সম্পাদনা';
                this.dom.editModalContent.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">টাস্ক নাম</label>
                            <input id="editTaskName" type="text" value="${task.name}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" maxlength="100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">বিবরণ</label>
                            <textarea id="editTaskDescription" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" maxlength="500">${task.description || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">সর্বোচ্চ স্কোর</label>
                            <input id="editTaskMaxScore" type="number" value="${task.maxScore}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700" min="1" max="1000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">তারিখ</label>
                            <input id="editTaskDate" type="date" value="${dateStr}" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700">
                        </div>
                    </div>
                `;

                this.editCallback = async () => {
                    const name = document.getElementById('editTaskName').value.trim();
                    const description = document.getElementById('editTaskDescription').value.trim();
                    const maxScore = parseInt(document.getElementById('editTaskMaxScore').value);
                    const dateStr = document.getElementById('editTaskDate').value;

                    if (!name || !description || isNaN(maxScore) || !dateStr) {
                        this.showToast('সমস্ত তথ্য পূরণ করুন', 'error');
                        return;
                    }

                    const date = new Date(dateStr);

                    this.showLoading();
                    try {
                        await db.collection('tasks').doc(id).update({ name, description, maxScore, date });
                        // Clear cache and reload data
                        this.cache.clear('tasks_data');
                        await this.loadTasks();
                        this.showToast('টাস্ক সফলভাবে আপডেট করা হয়েছে', 'success');
                    } catch (error) {
                        this.showToast('সম্পাদনা ব্যর্থ: ' + error.message, 'error');
                    } finally {
                        this.hideLoading();
                    }
                };

                this.showEditModal();
            }

            async editEvaluation(id) {
                const evaluation = this.state.evaluations.find(e => e.id === id);
                if (!evaluation) return;

                this.dom.editModalTitle.textContent = 'মূল্যায়ন সম্পাদনা';
                
                // Find task and group
                const task = this.state.tasks.find(t => t.id === evaluation.taskId);
                const group = this.state.groups.find(g => g.id === evaluation.groupId);
                
                this.dom.editModalContent.innerHTML = `
                    <div class="mb-4">
                        <p><strong>টাস্ক:</strong> ${task?.name || 'Unknown'}</p>
                        <p><strong>গ্রুপ:</strong> ${group?.name || 'Unknown'}</p>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400">মূল্যায়ন সম্পাদনা করতে মূল্যায়ন পৃষ্ঠায় যান এবং সংশ্লিষ্ট টাস্ক ও গ্রুপ নির্বাচন করুন।</p>
                `;

                this.editCallback = () => {
                    // Navigate to evaluation page with pre-selected values
                    this.handleNavigation({ currentTarget: document.querySelector('[data-page="evaluation"]') });
                    setTimeout(() => {
                        if (this.dom.evaluationTaskSelect) this.dom.evaluationTaskSelect.value = evaluation.taskId;
                        if (this.dom.evaluationGroupSelect) this.dom.evaluationGroupSelect.value = evaluation.groupId;
                        this.startEvaluation();
                    }, 500);
                    this.hideEditModal();
                };

                this.showEditModal();
            }

            // ===============================
            // DELETE OPERATIONS
            // ===============================
            async deleteStudent(id) {
                this.showDeleteModal('এই শিক্ষার্থী ডিলিট করবেন?', async () => {
                    this.showLoading();
                    try {
                        await db.collection('students').doc(id).delete();
                        // Clear cache and reload data
                        this.cache.clear('students_data');
                        await this.loadStudents();
                        this.showToast('শিক্ষার্থী সফলভাবে ডিলিট করা হয়েছে', 'success');
                    } catch (error) {
                        this.showToast('ডিলিট ব্যর্থ: ' + error.message, 'error');
                    } finally {
                        this.hideLoading();
                    }
                });
            }

            async deleteGroup(id) {
                this.showDeleteModal('এই গ্রুপ ডিলিট করবেন?', async () => {
                    this.showLoading();
                    try {
                        await db.collection('groups').doc(id).delete();
                        // Clear cache and reload data
                        this.cache.clear('groups_data');
                        await this.loadGroups();
                        this.showToast('গ্রুপ সফলভাবে ডিলিট করা হয়েছে', 'success');
                    } catch (error) {
                        this.showToast('ডিলিট ব্যর্থ: ' + error.message, 'error');
                    } finally {
                        this.hideLoading();
                    }
                });
            }

            async deleteTask(id) {
                this.showDeleteModal('এই টাস্ক ডিলিট করবেন?', async () => {
                    this.showLoading();
                    try {
                        await db.collection('tasks').doc(id).delete();
                        // Clear cache and reload data
                        this.cache.clear('tasks_data');
                        await this.loadTasks();
                        this.showToast('টাস্ক সফলভাবে ডিলিট করা হয়েছে', 'success');
                    } catch (error) {
                        this.showToast('ডিলিট ব্যর্থ: ' + error.message, 'error');
                    } finally {
                        this.hideLoading();
                    }
                });
            }

            async deleteEvaluation(id) {
                this.showDeleteModal('এই মূল্যায়ন ডিলিট করবেন?', async () => {
                    this.showLoading();
                    try {
                        await db.collection('evaluations').doc(id).delete();
                        // Clear cache and reload data
                        this.cache.clear('evaluations_data');
                        await this.loadEvaluations();
                        this.showToast('মূল্যায়ন সফলভাবে ডিলিট করা হয়েছে', 'success');
                    } catch (error) {
                        this.showToast('ডিলিট ব্যর্থ: ' + error.message, 'error');
                    } finally {
                        this.hideLoading();
                    }
                });
            }

            async deleteAdmin(id) {
                this.showDeleteModal('এই অ্যাডমিন ডিলিট করবেন?', async () => {
                    this.showLoading();
                    try {
                        await db.collection("admins").doc(id).delete();
                        await this.loadAdmins();
                        this.showToast('অ্যাডমিন সফলভাবে ডিলিট করা হয়েছে', 'success');
                    } catch (error) {
                        this.showToast('ডিলিট ব্যর্থ: ' + error.message, 'error');
                    } finally {
                        this.hideLoading();
                    }
                });
            }

            // ===============================
            // UTILITY METHODS
            // ===============================
            async checkStudentUniqueness(roll, academicGroup, excludeId = null) {
                const query = db.collection("students")
                    .where("roll", "==", roll)
                    .where("academicGroup", "==", academicGroup);
                const snap = await query.get();
                return !snap.empty && snap.docs.some(doc => doc.id !== excludeId);
            }

            // ===============================
            // SEARCH AND FILTER HANDLERS
            // ===============================
            handleStudentSearch(value) {
                this.filters.membersSearchTerm = value.toLowerCase();
                this.renderStudentsList();
            }

            handleAllStudentsSearch(value) {
                this.filters.cardsSearchTerm = value.toLowerCase();
                this.renderStudentCards();
            }

            handleMembersFilter(value) {
                this.filters.membersFilterGroupId = value;
                this.renderStudentsList();
            }

            handleCardsFilter(value) {
                this.filters.cardsFilterGroupId = value;
                this.renderStudentCards();
            }

            handleGroupMembersFilter(value) {
                this.filters.groupMembersFilterGroupId = value;
                this.renderGroupMembers();
            }

            handleAdminSearch(value) {
                this.filters.adminSearchTerm = value.toLowerCase();
                this.renderAdminManagement();
            }

            handleAdminTypeChange(e) {
                const isSuperAdmin = e.target.value === 'super-admin';
                if (this.dom.permissionsSection) {
                    this.dom.permissionsSection.classList.toggle('hidden', !isSuperAdmin);
                }
            }

            // ===============================
            // DASHBOARD METHODS
            // ===============================
            async loadDashboard() {
                await this.loadEvaluations();
                this.renderStatsSummary();
                this.renderAcademicGroupStats();
                this.renderTaskStats();
                this.renderEvaluationStats();
                this.renderTopGroups();
                this.renderGroupsRanking();
            }

            renderStatsSummary() {
                const statsEl = document.getElementById("statsSummary");
                if (!statsEl) return;

                const totalGroups = this.state.groups.length;
                const totalStudents = this.state.students.length;
                const withoutRole = this.state.students.filter(s => !s.role).length;
                const academicGroups = new Set(this.state.students.map(s => s.academicGroup)).size;

                // Gender counts
                const genderCount = { 'ছেলে': 0, 'মেয়ে': 0 };
                this.state.students.forEach(s => {
                    if (s.gender === 'ছেলে') genderCount['ছেলে']++;
                    else if (s.gender === 'মেয়ে') genderCount['মেয়ে']++;
                });

                // Task stats
                const totalTasks = this.state.tasks.length;
                const evaluatedTasks = new Set(this.state.evaluations.map(e => e.taskId)).size;
                const pendingTasks = totalTasks - evaluatedTasks;

                const card = (title, value, icon, color) => `
                    <div class="glass-card rounded-xl p-4 shadow-md flex items-center gap-3 card-hover">
                        <div class="p-3 rounded-lg ${color} text-white"><i class="${icon}"></i></div>
                        <div>
                            <div class="text-xs text-gray-500 dark:text-gray-300">${title}</div>
                            <div class="text-2xl font-bold">${value}</div>
                        </div>
                    </div>
                `;

                statsEl.innerHTML = [
                    card("মোট গ্রুপ", totalGroups, "fas fa-layer-group", "bg-blue-500"),
                    card("মোট শিক্ষার্থী", totalStudents, "fas fa-user-graduate", "bg-green-500"),
                    card("একাডেমিক গ্রুপ", academicGroups, "fas fa-book", "bg-purple-500"),
                    card("দায়িত্ব বাকি", withoutRole, "fas fa-hourglass-half", "bg-amber-500"),
                    card("ছেলে", genderCount['ছেলে'], "fas fa-male", "bg-blue-400"),
                    card("মেয়ে", genderCount['মেয়ে'], "fas fa-female", "bg-pink-400"),
                    card("মোট টাস্ক", totalTasks, "fas fa-tasks", "bg-indigo-500"),
                    card("বাকি মূল্যায়ন", pendingTasks, "fas fa-clipboard-list", "bg-red-500")
                ].join("");
            }

            renderTaskStats() {
                const container = document.getElementById("taskStats");
                if (!container) return;

                const totalTasks = this.state.tasks.length;
                const evaluatedTasks = new Set(this.state.evaluations.map(e => e.taskId)).size;
                const pendingTasks = totalTasks - evaluatedTasks;

                container.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>মোট টাস্ক:</span>
                        <span class="font-semibold">${totalTasks}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>মূল্যায়ন completed:</span>
                        <span class="font-semibold text-green-600">${evaluatedTasks}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>বাকি মূল্যায়ন:</span>
                        <span class="font-semibold text-red-600">${pendingTasks}</span>
                    </div>
                    <div class="progress-bar mt-2">
                        <div class="progress-fill bg-green-500" style="width:${totalTasks ? (evaluatedTasks / totalTasks) * 100 : 0}%"></div>
                    </div>
                `;
            }

            renderEvaluationStats() {
                const container = document.getElementById("evaluationStats");
                if (!container) return;

                const totalEvaluations = this.state.evaluations.length;
                const totalScore = this.state.evaluations.reduce((sum, evalItem) => {
                    if (!evalItem.scores) return sum;
                    return sum + Object.values(evalItem.scores).reduce((scoreSum, score) => {
                        return scoreSum + (score.taskScore || 0) + (score.teamworkScore || 0);
                    }, 0);
                }, 0);

                const avgScore = totalEvaluations > 0 ? (totalScore / totalEvaluations).toFixed(2) : 0;

                container.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>মোট মূল্যায়ন:</span>
                        <span class="font-semibold">${totalEvaluations}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>গড় স্কোর:</span>
                        <span class="font-semibold text-blue-600">${avgScore}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>শেষ আপডেট:</span>
                        <span class="text-sm text-gray-500">${new Date().toLocaleDateString('bn-BD')}</span>
                    </div>
                `;
            }

            renderAcademicGroupStats() {
                const container = document.getElementById("academicGroupStatsList");
                if (!container) return;

                const academicCounts = {};
                this.state.students.forEach(s => {
                    const ag = s.academicGroup || 'অজানা';
                    academicCounts[ag] = (academicCounts[ag] || 0) + 1;
                });

                const total = this.state.students.length;
                container.innerHTML = Object.entries(academicCounts).map(([group, count]) => {
                    const percent = total > 0 ? Math.round((count / total) * 100) : 0;
                    return `
                        <div class="glass-card rounded-lg p-4 card-hover">
                            <div class="flex justify-between mb-1">
                                <div class="font-medium">${group}</div>
                                <div class="text-sm text-gray-500">${count} (${percent}%)</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill bg-purple-500" style="width:${percent}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderTopGroups() {
                const container = document.getElementById("topGroupsContainer");
                if (!container) return;

                const scores = this.calculateGroupScores();
                const sortedGroups = [...this.state.groups]
                    .map(g => ({ ...g, score: scores[g.id] || 0 }))
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 3);

                container.innerHTML = sortedGroups.map((group, index) => {
                    const members = this.getStudentsInGroup(group.id);
                    const bgClass = `rank-${index + 1}-card`;
                    const titleClass = `rank-${index + 1}-title`;
                    
                    return `
                        <div class="${bgClass} rounded-xl p-4 shadow-md card-hover">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="rank-badge ${index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : 'rank-3'}">${index + 1}</div>
                                <h3 class="${titleClass}">${group.name}</h3>
                            </div>
                            <div class="space-y-1 text-sm">
                                <p>স্কোর: <span class="font-semibold">${group.score}</span></p>
                                <p>সদস্য: <span class="font-semibold">${members.length}</span></p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderGroupsRanking() {
                const container = document.getElementById("groupsRankingList");
                if (!container) return;

                const scores = this.calculateGroupScores();
                const sortedGroups = [...this.state.groups]
                    .map(g => ({ ...g, score: scores[g.id] || 0 }))
                    .sort((a, b) => b.score - a.score);

                container.innerHTML = sortedGroups.map((group, index) => {
                    const members = this.getStudentsInGroup(group.id);
                    const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-other';
                    
                    return `
                        <div class="flex items-center justify-between p-3 border border-gray-200 dark:border-gray-700 rounded-lg card-hover">
                            <div class="flex items-center gap-4">
                                <div class="rank-badge ${rankClass}">${index + 1}</div>
                                <div>
                                    <div class="font-medium">${group.name}</div>
                                    <div class="text-sm text-gray-500">সদস্য: ${members.length} | স্কোর: ${group.score}</div>
                                </div>
                            </div>
                            <button onclick="smartEvaluator.showGroupDetailsModal('${group.id}')" class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-lg text-sm">বিস্তারিত</button>
                        </div>
                    `;
                }).join('');
            }

            // ===============================
            // GROUP DETAILS MODAL - NEW IMPLEMENTATION
            // ===============================
            renderGroupDetails(groupId) {
                const group = this.state.groups.find(g => g.id === groupId);
                if (!group) return;

                const students = this.getStudentsInGroup(groupId);
                const evaluations = this.state.evaluations.filter(e => e.groupId === groupId);
                
                // Calculate group average
                const groupScores = this.calculateGroupScores();
                const groupAverage = groupScores[groupId] || 0;
                
                // Calculate evaluation averages
                const evaluationAverages = {};
                evaluations.forEach(evaluation => {
                    if (evaluation.scores) {
                        const scores = Object.values(evaluation.scores);
                        if (scores.length > 0) {
                            const total = scores.reduce((sum, score) => {
                                return sum + (score.taskScore || 0) + (score.teamworkScore || 0);
                            }, 0);
                            evaluationAverages[evaluation.taskId] = (total / scores.length).toFixed(2);
                        }
                    }
                });

                // Create content for modal
                let content = `
                    <div class="mb-6">
                        <h4 class="text-lg font-bold mb-2">সারাংশ</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                <div class="text-sm text-blue-600 dark:text-blue-300">গ্রুপ গড়</div>
                                <div class="text-2xl font-bold text-blue-700 dark:text-blue-200">${groupAverage}</div>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                <div class="text-sm text-green-600 dark:text-green-300">সদস্য সংখ্যা</div>
                                <div class="text-2xl font-bold text-green-700 dark:text-green-200">${students.length}</div>
                            </div>
                            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                                <div class="text-sm text-purple-600 dark:text-purple-300">মূল্যায়ন সংখ্যা</div>
                                <div class="text-2xl font-bold text-purple-700 dark:text-purple-200">${evaluations.length}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="text-lg font-bold mb-2">মূল্যায়ন গড়</h4>
                        <div class="overflow-x-auto">
                            <table class="evaluation-table">
                                <thead>
                                    <tr>
                                        <th>টাস্ক</th>
                                        <th>গড় স্কোর</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                // Add evaluation averages
                evaluations.forEach(evaluation => {
                    const task = this.state.tasks.find(t => t.id === evaluation.taskId);
                    if (task) {
                        const avgScore = evaluationAverages[evaluation.taskId] || '0.00';
                        content += `
                            <tr>
                                <td>${task.name}</td>
                                <td>${avgScore}</td>
                            </tr>
                        `;
                    }
                });

                content += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="text-lg font-bold mb-2">সদস্যবৃন্দ</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;

                // Add student details
                students.forEach((student, index) => {
                    const studentEvaluations = evaluations.filter(e => e.scores && e.scores[student.id]);
                    const studentTotalScore = this.calculateStudentTotalScore(student.id);
                    
                    content += `
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h5 class="font-semibold">${student.name}</h5>
                                    <p class="text-sm text-gray-500">রোল: ${student.roll} | ${student.gender}</p>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-md bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">স্কোর: ${studentTotalScore}</span>
                            </div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                ${student.role ? `<p>দায়িত্ব: ${this.roleNames[student.role] || student.role}</p>` : ''}
                                <p>একাডেমিক: ${student.academicGroup || 'না'}</p>
                                <p>মূল্যায়ন: ${studentEvaluations.length}</p>
                            </div>
                        </div>
                    `;
                });

                content += `
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-bold mb-2">বিস্তারিত মূল্যায়ন</h4>
                        <div class="overflow-x-auto">
                            <table class="evaluation-table">
                                <thead>
                                    <tr>
                                        <th>টাস্ক</th>
                                        <th>শিক্ষার্থী</th>
                                        <th>টাস্ক স্কোর</th>
                                        <th>টিমওয়ার্ক</th>
                                        <th>মোট স্কোর</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                // Add detailed evaluation scores
                evaluations.forEach(evaluation => {
                    const task = this.state.tasks.find(t => t.id === evaluation.taskId);
                    if (task && evaluation.scores) {
                        Object.entries(evaluation.scores).forEach(([studentId, score]) => {
                            const student = students.find(s => s.id === studentId);
                            if (student) {
                                const taskScore = score.taskScore || 0;
                                const teamworkScore = score.teamworkScore || 0;
                                const totalScore = taskScore + teamworkScore;
                                
                                content += `
                                    <tr>
                                        <td>${task.name}</td>
                                        <td>${student.name}</td>
                                        <td>${taskScore}</td>
                                        <td>${teamworkScore}</td>
                                        <td>${totalScore}</td>
                                    </tr>
                                `;
                            }
                        });
                    }
                });

                content += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                this.dom.groupDetailsContent.innerHTML = content;
            }

            // ===============================
            // REMAINING METHODS
            // ===============================
            renderGroupMembers() {
                if (!this.dom.groupMembersList) return;

                let students = this.state.students;
                if (this.filters.groupMembersFilterGroupId) {
                    students = students.filter(s => s.groupId === this.filters.groupMembersFilterGroupId);
                }

                const grouped = {};
                students.forEach(student => {
                    const groupId = student.groupId;
                    if (!groupId) return;
                    if (!grouped[groupId]) grouped[groupId] = [];
                    grouped[groupId].push(student);
                });

                let html = '';
                Object.entries(grouped).forEach(([groupId, members]) => {
                    const group = this.state.groups.find(g => g.id === groupId);
                    if (!group) return;

                    html += `
                        <div class="mb-6">
                            <h4 class="text-lg font-bold mb-3">${group.name}</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${members.map(student => {
                                    const roleBadge = student.role ? 
                                        `<span class="member-role-badge ${student.role}">${this.roleNames[student.role] || student.role}</span>` : '';
                                    
                                    return `
                                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <h5 class="font-semibold">${student.name}</h5>
                                                    <p class="text-sm text-gray-500">রোল: ${student.roll} | ${student.gender}</p>
                                                </div>
                                                ${roleBadge}
                                            </div>
                                            <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                                <p>একাডেমিক: ${student.academicGroup || 'না'}</p>
                                                <p>সেশন: ${student.session || 'না'}</p>
                                                ${student.contact ? `<p>যোগাযোগ: ${student.contact}</p>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });

                if (!html) {
                    html = '<p class="text-center text-gray-500 py-4">কোন সদস্য পাওয়া যায়নি</p>';
                }

                this.dom.groupMembersList.innerHTML = html;
            }

            renderStudentRanking() {
                if (!this.dom.studentRankingList) return;

                const studentsWithScores = this.state.students.map(student => {
                    const totalScore = this.calculateStudentTotalScore(student.id);
                    const group = this.state.groups.find(g => g.id === student.groupId);
                    return { ...student, totalScore, groupName: group?.name || 'Unknown' };
                }).sort((a, b) => b.totalScore - a.totalScore);

                this.dom.studentRankingList.innerHTML = studentsWithScores.map((student, index) => {
                    const rankClass = index < 3 ? `rank-${index + 1}` : 'rank-other';
                    const cardClass = index < 3 ? `rank-${index + 1}-card` : 'bg-white dark:bg-gray-800';
                    
                    return `
                        <div class="${cardClass} rounded-xl p-4 shadow-md flex items-center justify-between card-hover">
                            <div class="flex items-center gap-4">
                                <div class="rank-badge ${rankClass}">${index + 1}</div>
                                <div>
                                    <div class="font-medium">${student.name}</div>
                                    <div class="text-sm text-gray-500">গ্রুপ: ${student.groupName} | রোল: ${student.roll}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold">${student.totalScore}</div>
                                <div class="text-sm text-gray-500">মোট স্কোর</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderGroupAnalysis() {
                if (!this.dom.groupAnalysisDetails) return;

                const scores = this.calculateGroupScores();
                const selectedGroups = this.filters.analysisFilterGroupIds.length > 0 ? 
                    this.state.groups.filter(g => this.filters.analysisFilterGroupIds.includes(g.id)) :
                    this.state.groups;

                this.dom.groupAnalysisDetails.innerHTML = selectedGroups.map(group => {
                    const score = scores[group.id] || 0;
                    const members = this.getStudentsInGroup(group.id);
                    const evaluations = this.state.evaluations.filter(e => e.groupId === group.id);
                    
                    return `
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <h3 class="font-bold text-lg mb-2">${group.name}</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>স্কোর:</span>
                                    <span class="font-semibold">${score}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>সদস্য:</span>
                                    <span class="font-semibold">${members.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>মূল্যায়ন:</span>
                                    <span class="font-semibold">${evaluations.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>গড় স্কোর:</span>
                                    <span class="font-semibold">${members.length > 0 ? (score / members.length).toFixed(2) : 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                this.updateGroupAnalysisChart();
            }

            updateGroupAnalysisChart() {
                const ctx = this.dom.groupAnalysisChart?.getContext('2d');
                if (!ctx) return;

                // Destroy existing chart
                if (this.currentChart) {
                    this.currentChart.destroy();
                }

                const scores = this.calculateGroupScores();
                const selectedGroups = this.filters.analysisFilterGroupIds.length > 0 ? 
                    this.state.groups.filter(g => this.filters.analysisFilterGroupIds.includes(g.id)) :
                    this.state.groups;

                const labels = selectedGroups.map(g => g.name);
                const data = selectedGroups.map(g => scores[g.id] || 0);

                this.currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'গ্রুপ স্কোর',
                            data,
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(139, 92, 246, 0.8)',
                                'rgba(236, 72, 153, 0.8)',
                                'rgba(6, 182, 212, 0.8)'
                            ],
                            borderColor: [
                                'rgb(59, 130, 246)',
                                'rgb(16, 185, 129)',
                                'rgb(245, 158, 11)',
                                'rgb(139, 92, 246)',
                                'rgb(236, 72, 153)',
                                'rgb(6, 182, 212)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'স্কোর'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'গ্রুপ'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'গ্রুপ স্কোর তুলনা'
                            }
                        }
                    }
                });
            }

            updateGroupAnalysis() {
                const select = this.dom.analysisGroupSelect;
                if (!select) return;

                const selectedOptions = Array.from(select.selectedOptions).map(option => option.value);
                this.filters.analysisFilterGroupIds = selectedOptions;
                this.renderGroupAnalysis();
            }

            calculateGroupScores() {
                const scores = {};
                
                this.state.groups.forEach(group => {
                    scores[group.id] = 0;
                });

                this.state.evaluations.forEach(evaluation => {
                    if (!evaluation.scores || !evaluation.groupId) return;
                    
                    Object.values(evaluation.scores).forEach(score => {
                        const taskScore = score.taskScore || 0;
                        const teamworkScore = score.teamworkScore || 0;
                        scores[evaluation.groupId] += taskScore + teamworkScore;
                    });
                });

                return scores;
            }

            refreshRanking() {
                this.cache.clear('evaluations_data');
                this.loadEvaluations().then(() => {
                    this.renderStudentRanking();
                    this.showToast('র‌্যাঙ্কিং রিফ্রেশ করা হয়েছে', 'success');
                });
            }

            // ===============================
            // EVALUATION METHODS
            // ===============================
            startEvaluation() {
                const taskId = this.dom.evaluationTaskSelect?.value;
                const groupId = this.dom.evaluationGroupSelect?.value;

                if (!taskId) {
                    this.showToast('টাস্ক নির্বাচন করুন', 'error');
                    return;
                }

                const task = this.state.tasks.find(t => t.id === taskId);
                if (!task) {
                    this.showToast('টাস্ক পাওয়া যায়নি', 'error');
                    return;
                }

                let students = this.state.students;
                if (groupId) {
                    students = students.filter(s => s.groupId === groupId);
                }

                if (students.length === 0) {
                    this.showToast('কোন শিক্ষার্থী পাওয়া যায়নি', 'error');
                    return;
                }

                this.currentEvaluation = {
                    taskId,
                    groupId,
                    scores: {}
                };

                this.renderEvaluationForm(students, task);
            }

            renderEvaluationForm(students, task) {
                if (!this.dom.evaluationForm) return;

                let html = `
                    <h3 class="text-lg font-bold mb-4">${task.name} - মূল্যায়ন</h3>
                    <div class="mb-4">
                        <p class="text-gray-600 dark:text-gray-300">${task.description || 'কোন বিবরণ নেই'}</p>
                        <p class="text-sm text-gray-500 mt-1">সর্বোচ্চ স্কোর: ${task.maxScore}</p>
                    </div>
                    <div class="space-y-6">
                `;

                students.forEach(student => {
                    const existingScore = this.currentEvaluation.scores[student.id] || {
                        taskScore: 0,
                        teamworkScore: 0,
                        optionMarks: {}
                    };

                    html += `
                        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h4 class="font-semibold">${student.name}</h4>
                                    <p class="text-sm text-gray-500">রোল: ${student.roll} | গ্রুপ: ${this.state.groups.find(g => g.id === student.groupId)?.name || 'Unknown'}</p>
                                </div>
                                ${student.role ? `<span class="member-role-badge ${student.role}">${this.roleNames[student.role] || student.role}</span>` : ''}
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">টাস্ক স্কোর (0-${task.maxScore})</label>
                                    <input 
                                        type="number" 
                                        min="0" 
                                        max="${task.maxScore}"
                                        value="${existingScore.taskScore}"
                                        onchange="smartEvaluator.updateStudentScore('${student.id}', 'taskScore', this.value)"
                                        class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">টিমওয়ার্ক স্কোর (0-10)</label>
                                    <input 
                                        type="number" 
                                        min="0" 
                                        max="10"
                                        value="${existingScore.teamworkScore}"
                                        onchange="smartEvaluator.updateStudentScore('${student.id}', 'teamworkScore', this.value)"
                                        class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700"
                                    >
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">অতিরিক্ত মার্কস</label>
                                <div class="grid grid-cols-1 gap-2">
                                    ${this.evaluationOptions.map(option => {
                                        const isSelected = existingScore.optionMarks[option.id]?.selected || false;
                                        return `
                                            <label class="flex items-center space-x-2 cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    ${isSelected ? 'checked' : ''}
                                                    onchange="smartEvaluator.updateOptionMark('${student.id}', '${option.id}', this.checked)"
                                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                                >
                                                <span class="text-sm">${option.text} (${option.marks > 0 ? '+' : ''}${option.marks})</span>
                                            </label>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        <div class="flex gap-3">
                            <button onclick="smartEvaluator.saveEvaluation()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                মূল্যায়ন সংরক্ষণ
                            </button>
                            <button onclick="smartEvaluator.cancelEvaluation()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                                বাতিল
                            </button>
                        </div>
                    </div>
                `;

                this.dom.evaluationForm.innerHTML = html;
            }

            updateStudentScore(studentId, field, value) {
                if (!this.currentEvaluation) return;

                if (!this.currentEvaluation.scores[studentId]) {
                    this.currentEvaluation.scores[studentId] = {
                        taskScore: 0,
                        teamworkScore: 0,
                        optionMarks: {}
                    };
                }

                this.currentEvaluation.scores[studentId][field] = parseInt(value) || 0;
            }

            updateOptionMark(studentId, optionId, isSelected) {
                if (!this.currentEvaluation) return;

                if (!this.currentEvaluation.scores[studentId]) {
                    this.currentEvaluation.scores[studentId] = {
                        taskScore: 0,
                        teamworkScore: 0,
                        optionMarks: {}
                    };
                }

                if (!this.currentEvaluation.scores[studentId].optionMarks[optionId]) {
                    this.currentEvaluation.scores[studentId].optionMarks[optionId] = {
                        optionId,
                        selected: false
                    };
                }

                this.currentEvaluation.scores[studentId].optionMarks[optionId].selected = isSelected;
            }

            async saveEvaluation() {
                if (!this.currentEvaluation) {
                    this.showToast('কোন মূল্যায়ন ডেটা নেই', 'error');
                    return;
                }

                const hasScores = Object.keys(this.currentEvaluation.scores).length > 0;
                if (!hasScores) {
                    this.showToast('কোন স্কোর ইনপুট করা হয়নি', 'error');
                    return;
                }

                this.showLoading();
                try {
                    // Check if evaluation already exists
                    const existingEval = this.state.evaluations.find(e => 
                        e.taskId === this.currentEvaluation.taskId && 
                        e.groupId === this.currentEvaluation.groupId
                    );

                    if (existingEval) {
                        // Update existing evaluation
                        await db.collection('evaluations').doc(existingEval.id).update({
                            scores: this.currentEvaluation.scores,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        this.showToast('মূল্যায়ন আপডেট করা হয়েছে', 'success');
                    } else {
                        // Create new evaluation
                        await db.collection('evaluations').add({
                            ...this.currentEvaluation,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        this.showToast('মূল্যায়ন সংরক্ষণ করা হয়েছে', 'success');
                    }

                    // Clear cache and reload data
                    this.cache.clear('evaluations_data');
                    await this.loadEvaluations();
                    this.cancelEvaluation();
                } catch (error) {
                    this.showToast('মূল্যায়ন সংরক্ষণ ব্যর্থ: ' + error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            }

            cancelEvaluation() {
                this.currentEvaluation = null;
                if (this.dom.evaluationForm) {
                    this.dom.evaluationForm.innerHTML = '';
                }
            }

            // ===============================
            // CSV IMPORT/EXPORT METHODS
            // ===============================
            importCSV() {
                if (this.dom.csvFileInput) {
                    this.dom.csvFileInput.click();
                }
            }

            handleCSVFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.name.toLowerCase().endsWith('.csv')) {
                    this.showToast('শুধুমাত্র CSV ফাইল নির্বাচন করুন', 'error');
                    return;
                }

                if (this.dom.csvFileName) {
                    this.dom.csvFileName.textContent = file.name;
                }
                if (this.dom.processImportBtn) {
                    this.dom.processImportBtn.classList.remove('hidden');
                }

                Papa.parse(file, {
                    header: true,
                    complete: (results) => {
                        this.csvImportData = results.data;
                        this.showToast(`${results.data.length} সারি লোড হয়েছে`, 'success');
                    },
                    error: (error) => {
                        this.showToast('CSV পার্সিং ব্যর্থ: ' + error.message, 'error');
                    }
                });
            }

            async processCSVImport() {
                if (!this.csvImportData || this.csvImportData.length === 0) {
                    this.showToast('প্রথমে CSV ফাইল নির্বাচন করুন', 'error');
                    return;
                }

                this.showLoading('ডেটা ইম্পোর্ট হচ্ছে...');
                try {
                    let successCount = 0;
                    let errorCount = 0;

                    for (const row of this.csvImportData) {
                        try {
                            // Validate required fields
                            if (!row.name || !row.roll || !row.gender || !row.academicGroup || !row.session) {
                                errorCount++;
                                continue;
                            }

                            // Find group by name
                            let groupId = null;
                            if (row.group) {
                                const group = this.state.groups.find(g => g.name === row.group);
                                if (group) {
                                    groupId = group.id;
                                } else {
                                    // Create new group if it doesn't exist
                                    const newGroupRef = await db.collection('groups').add({
                                        name: row.group,
                                        memberCount: 0,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    });
                                    groupId = newGroupRef.id;
                                    // Update local state
                                    this.state.groups.push({ id: groupId, name: row.group, memberCount: 0 });
                                }
                            }

                            // Prepare student data
                            const studentData = {
                                name: row.name,
                                roll: row.roll,
                                gender: row.gender,
                                groupId: groupId,
                                contact: row.contact || '',
                                academicGroup: row.academicGroup,
                                session: row.session,
                                role: row.role || ''
                            };

                            // Check for duplicates
                            const isDuplicate = await this.checkStudentUniqueness(studentData.roll, studentData.academicGroup);
                            if (!isDuplicate) {
                                await db.collection('students').add({
                                    ...studentData,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                });
                                successCount++;
                            } else {
                                errorCount++;
                            }
                        } catch (error) {
                            errorCount++;
                        }
                    }

                    // Clear cache and reload data
                    this.cache.clear('students_data');
                    this.cache.clear('groups_data');
                    await this.loadStudents();
                    await this.loadGroups();
                    this.populateSelects();

                    // Reset form
                    if (this.dom.csvFileName) this.dom.csvFileName.textContent = 'কোন ফাইল নির্বাচন করা হয়নি';
                    if (this.dom.processImportBtn) this.dom.processImportBtn.classList.add('hidden');
                    if (this.dom.csvFileInput) this.dom.csvFileInput.value = '';
                    this.csvImportData = null;

                    this.showToast(`${successCount} শিক্ষার্থী সফলভাবে ইম্পোর্ট হয়েছে, ${errorCount} ব্যর্থ`, 'success');
                } catch (error) {
                    this.showToast('ইম্পোর্ট ব্যর্থ: ' + error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            }

            downloadCSVTemplate() {
                const headers = ['name', 'roll', 'gender', 'group', 'contact', 'academicGroup', 'session', 'role'];
                const sampleData = ['নাম', 'রোল নং', 'ছেলে/মেয়ে', 'গ্রুপ নাম', 'যোগাযোগ', 'বিজ্ঞান/মানবিক/বাণিজ্য', '২০২৩-২৪', 'team-leader'];
                
                const csvContent = [headers, sampleData].map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'student_template.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            exportStudentsCSV() {
                const headers = ['নাম', 'রোল', 'লিঙ্গ', 'গ্রুপ', 'যোগাযোগ', 'একাডেমিক গ্রুপ', 'সেশন', 'দায়িত্ব'];
                const rows = this.state.students.map(student => {
                    const group = this.state.groups.find(g => g.id === student.groupId);
                    return [
                        student.name,
                        student.roll,
                        student.gender,
                        group?.name || '',
                        student.contact || '',
                        student.academicGroup || '',
                        student.session || '',
                        this.roleNames[student.role] || student.role || ''
                    ];
                });

                const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
                this.downloadCSV(csvContent, 'students.csv');
            }

            exportGroupsCSV() {
                const memberCountMap = this.computeMemberCountMap();
                const headers = ['গ্রুপ নাম', 'সদস্য সংখ্যা'];
                const rows = this.state.groups.map(group => [
                    group.name,
                    memberCountMap[group.id] || 0
                ]);

                const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
                this.downloadCSV(csvContent, 'groups.csv');
            }

            exportEvaluationsCSV() {
                const headers = ['টাস্ক', 'গ্রুপ', 'শিক্ষার্থী', 'টাস্ক স্কোর', 'টিমওয়ার্ক স্কোর', 'মোট স্কোর'];
                const rows = [];

                this.state.evaluations.forEach(evaluation => {
                    const task = this.state.tasks.find(t => t.id === evaluation.taskId);
                    const group = this.state.groups.find(g => g.id === evaluation.groupId);
                    
                    if (evaluation.scores) {
                        Object.entries(evaluation.scores).forEach(([studentId, score]) => {
                            const student = this.state.students.find(s => s.id === studentId);
                            if (student) {
                                const taskScore = score.taskScore || 0;
                                const teamworkScore = score.teamworkScore || 0;
                                const totalScore = taskScore + teamworkScore;
                                
                                rows.push([
                                    task?.name || 'Unknown',
                                    group?.name || 'Unknown',
                                    student.name,
                                    taskScore,
                                    teamworkScore,
                                    totalScore
                                ]);
                            }
                        });
                    }
                });

                const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
                this.downloadCSV(csvContent, 'evaluations.csv');
            }

            downloadCSV(content, filename) {
                const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            async exportAllData() {
                this.showLoading('ডেটা এক্সপোর্ট হচ্ছে...');
                try {
                    const zip = new JSZip();
                    
                    // Add students CSV
                    const studentsCSV = this.getStudentsCSV();
                    zip.file("students.csv", studentsCSV);
                    
                    // Add groups CSV
                    const groupsCSV = this.getGroupsCSV();
                    zip.file("groups.csv", groupsCSV);
                    
                    // Add evaluations CSV
                    const evaluationsCSV = this.getEvaluationsCSV();
                    zip.file("evaluations.csv", evaluationsCSV);
                    
                    // Add tasks CSV
                    const tasksCSV = this.getTasksCSV();
                    zip.file("tasks.csv", tasksCSV);
                    
                    // Generate and download ZIP
                    const content = await zip.generateAsync({type: "blob"});
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(content);
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', `smart_evaluator_data_${new Date().toISOString().split('T')[0]}.zip`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showToast('সমস্ত ডেটা সফলভাবে এক্সপোর্ট হয়েছে', 'success');
                } catch (error) {
                    this.showToast('এক্সপোর্ট ব্যর্থ: ' + error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            }

            getStudentsCSV() {
                const headers = ['নাম', 'রোল', 'লিঙ্গ', 'গ্রুপ', 'যোগাযোগ', 'একাডেমিক গ্রুপ', 'সেশন', 'দায়িত্ব'];
                const rows = this.state.students.map(student => {
                    const group = this.state.groups.find(g => g.id === student.groupId);
                    return [
                        student.name,
                        student.roll,
                        student.gender,
                        group?.name || '',
                        student.contact || '',
                        student.academicGroup || '',
                        student.session || '',
                        this.roleNames[student.role] || student.role || ''
                    ];
                });
                return [headers, ...rows].map(row => row.join(',')).join('\n');
            }

            getGroupsCSV() {
                const memberCountMap = this.computeMemberCountMap();
                const headers = ['গ্রুপ নাম', 'সদস্য সংখ্যা'];
                const rows = this.state.groups.map(group => [
                    group.name,
                    memberCountMap[group.id] || 0
                ]);
                return [headers, ...rows].map(row => row.join(',')).join('\n');
            }

            getEvaluationsCSV() {
                const headers = ['টাস্ক', 'গ্রুপ', 'শিক্ষার্থী', 'টাস্ক স্কোর', 'টিমওয়ার্ক স্কোর', 'মোট স্কোর'];
                const rows = [];

                this.state.evaluations.forEach(evaluation => {
                    const task = this.state.tasks.find(t => t.id === evaluation.taskId);
                    const group = this.state.groups.find(g => g.id === evaluation.groupId);
                    
                    if (evaluation.scores) {
                        Object.entries(evaluation.scores).forEach(([studentId, score]) => {
                            const student = this.state.students.find(s => s.id === studentId);
                            if (student) {
                                const taskScore = score.taskScore || 0;
                                const teamworkScore = score.teamworkScore || 0;
                                const totalScore = taskScore + teamworkScore;
                                
                                rows.push([
                                    task?.name || 'Unknown',
                                    group?.name || 'Unknown',
                                    student.name,
                                    taskScore,
                                    teamworkScore,
                                    totalScore
                                ]);
                            }
                        });
                    }
                });

                return [headers, ...rows].map(row => row.join(',')).join('\n');
            }

            getTasksCSV() {
                const headers = ['টাস্ক নাম', 'বিবরণ', 'সর্বোচ্চ স্কোর', 'তারিখ'];
                const rows = this.state.tasks.map(task => {
                    const dateStr = task.date?.seconds ? 
                        new Date(task.date.seconds * 1000).toLocaleDateString("bn-BD") : 
                        'তারিখ নেই';
                    return [
                        task.name,
                        task.description || '',
                        task.maxScore,
                        dateStr
                    ];
                });
                return [headers, ...rows].map(row => row.join(',')).join('\n');
            }

            // ===============================
            // ADMIN MANAGEMENT METHODS
            // ===============================
            async saveAdmin() {
                const email = this.dom.adminEmail.value.trim();
                const password = this.dom.adminPassword.value;
                const type = this.dom.adminTypeSelect.value;
                const permissions = {
                    read: this.dom.permissionRead.checked,
                    write: this.dom.permissionWrite.checked,
                    delete: this.dom.permissionDelete.checked
                };

                if (!email || !this.validateEmail(email)) {
                    this.showToast('সঠিক ইমেইল লিখুন', 'error');
                    return;
                }

                if (!this.currentEditingAdmin && !password) {
                    this.showToast('নতুন অ্যাডমিনের জন্য পাসওয়ার্ড প্রয়োজন', 'error');
                    return;
                }

                this.showLoading();
                try {
                    if (this.currentEditingAdmin) {
                        // Update existing admin
                        await db.collection('admins').doc(this.currentEditingAdmin.id).update({
                            email,
                            type,
                            permissions
                        });
                        this.showToast('অ্যাডমিন সফলভাবে আপডেট করা হয়েছে', 'success');
                    } else {
                        // Create new admin user
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        
                        await db.collection('admins').doc(user.uid).set({
                            email,
                            type,
                            permissions,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        });
                        this.showToast('অ্যাডমিন সফলভাবে তৈরি করা হয়েছে', 'success');
                    }
                    
                    await this.loadAdmins();
                    this.hideAdminModal();
                } catch (error) {
                    this.showToast('অ্যাডমিন সংরক্ষণ ব্যর্থ: ' + error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            }
        }

        // Initialize the application
        const smartEvaluator = new SmartGroupEvaluator();
    </script>
</body>
</html>