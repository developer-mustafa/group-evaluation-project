<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Group Evaluator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* সকল CSS স্টাইল এখানে রাখুন (update10.html থেকে পুরো style section কপি করুন) */
        /* সম্পূর্ণ CSS content এখানে পেস্ট করুন */
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

        * {
            font-family: "Inter", sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            flex-shrink: 0;
            height: 100%;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .page-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* ... সমস্ত CSS স্টাইল ... */

        /* নতুন ট্যাব স্টাইল যোগ করা */
        .tab-container {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* স্কোর কার্ড স্টাইল */
        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .score-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .calculation-steps {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .calculation-step {
            margin: 5px 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-darkBg text-gray-800 dark:text-gray-200 transition-colors duration-300">
    
    <!-- Authentication Modal -->
    <div id="authModal" class="modal">
        <!-- Authentication modal content from update10.html -->
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <!-- Delete modal content from update10.html -->
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <!-- Edit modal content from update10.html -->
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal" style="display: none">
        <!-- Loading overlay content from update10.html -->
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="appContainer" class="app-container hidden">
        <!-- Sidebar -->
        <aside class="sidebar bg-white dark:bg-darkCard border-r border-gray-200 dark:border-gray-700">
            <!-- Sidebar content from update10.html -->
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="bg-white dark:bg-darkCard border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center">
                <h2 id="pageTitle" class="text-xl font-bold">ড্যাশবোর্ড</h2>
                <button id="mobileMenuBtn" class="mobile-menu-btn p-2 rounded-lg bg-gray-100 dark:bg-gray-800 lg:hidden">
                    <i class="fas fa-bars"></i>
                </button>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                
                <!-- Dashboard Page -->
                <section id="page-dashboard" class="page fade-in">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-2">ড্যাশবোর্ড</h2>
                        <p class="text-gray-600 dark:text-gray-400">গ্রুপ মূল্যায়ন সিস্টেমের সংক্ষিপ্ত তথ্য</p>

                        <!-- স্কোর ক্যালকুলেশন তথ্য -->
                        <div class="score-calculation-info mt-4">
                            <p class="text-sm flex items-center">
                                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                                <strong>স্কোর ক্যালকুলেশন পদ্ধতি:</strong> 
                                মোট স্কোর = (টাস্ক স্কোর + টিমওয়ার্ক স্কোর) × ৫
                            </p>
                        </div>
                    </div>

                    <!-- Top 3 Groups -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold mb-4">শীর্ষ গ্রুপসমূহ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="topGroupsContainer">
                            <!-- Top groups will be dynamically added here -->
                        </div>
                    </div>

                    <!-- All Groups Ranking List -->
                    <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5 mb-6">
                        <h3 class="text-lg font-semibold mb-4">গ্রুপ র‌্যাঙ্কিং</h3>
                        <div id="groupsRankingList" class="space-y-3">
                            <!-- Groups ranking will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Detailed Results Section -->
                    <div id="detailedResults" class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
                        <h3 class="text-lg font-semibold mb-4">বিস্তারিত ফলাফল</h3>
                        <div id="detailedResultsContent">
                            <!-- Detailed results will be dynamically added here -->
                        </div>
                    </div>
                </section>

                <!-- Groups Page (Unchanged) -->
                <section id="page-groups" class="page hidden">
                    <!-- Groups page content from update10.html -->
                </section>

                <!-- Members Page (Unchanged) -->
                <section id="page-members" class="page hidden">
                    <!-- Members page content from update10.html -->
                </section>

                <!-- Group Members Page with Tabs -->
                <section id="page-group-members" class="page hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-2">গ্রুপ সদস্য ব্যবস্থাপনা</h2>
                        <p class="text-gray-600 dark:text-gray-400">গ্রুপে সদস্য যোগ, সম্পাদনা এবং ব্যবস্থাপনা করুন</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Group Selection -->
                        <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
                            <h3 class="text-lg font-semibold mb-4">গ্রুপ নির্বাচন করুন</h3>
                            <div class="search-container mb-4">
                                <div class="search-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <input id="groupMemberSearchInput" type="text" placeholder="গ্রুপ খুঁজুন..." class="search-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 pl-10 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                            </div>
                            <div id="groupSelectionList" class="space-y-2 max-h-80 overflow-y-auto">
                                <!-- Groups will be dynamically added here -->
                            </div>
                        </div>

                        <!-- Group Members Content with Tabs -->
                        <div class="lg:col-span-2 bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
                            <h3 id="selectedGroupTitle" class="text-lg font-semibold mb-4">গ্রুপ সদস্য</h3>
                            
                            <!-- Tab Container -->
                            <div class="tab-container">
                                <div class="tab active" data-tab="members-list">সদস্য তালিকা</div>
                                <div class="tab" data-tab="role-assignment">দায়িত্ব বণ্টন</div>
                            </div>

                            <!-- Tab Contents -->
                            <div class="tab-content active" id="members-list-tab">
                                <div class="search-container mb-4">
                                    <div class="search-icon">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <input id="memberSearchInput" type="text" placeholder="সদস্য খুঁজুন..." class="search-input w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 pl-10 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                                </div>
                                <div id="groupMembersList" class="space-y-3">
                                    <p class="text-center text-gray-500 py-8">একটি গ্রুপ নির্বাচন করুন</p>
                                </div>
                            </div>

                            <div class="tab-content" id="role-assignment-tab">
                                <div id="roleAssignmentContent">
                                    <p class="text-center text-gray-500 py-8">একটি গ্রুপ নির্বাচন করুন</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- All Students Cards Page (Unchanged) -->
                <section id="page-all-students" class="page hidden">
                    <!-- All students cards page content from update10.html -->
                </section>

                <!-- Tasks Page (Unchanged) -->
                <section id="page-tasks" class="page hidden">
                    <!-- Tasks page content from update10.html -->
                </section>

                <!-- Evaluation Page with Tabs -->
                <section id="page-evaluation" class="page hidden">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-2">মূল্যায়ন</h2>
                        <p class="text-gray-600 dark:text-gray-400">গ্রুপ এবং সদস্যদের মূল্যায়ন করুন</p>
                    </div>

                    <!-- Tab Container -->
                    <div class="tab-container mb-6">
                        <div class="tab active" data-tab="group-evaluation">গ্রুপ মূল্যায়ন</div>
                        <div class="tab" data-tab="member-evaluation">সদস্য মূল্যায়ন</div>
                    </div>

                    <!-- Group Evaluation Tab -->
                    <div class="tab-content active" id="group-evaluation-tab">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Task and Group Selection -->
                            <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
                                <h3 class="text-lg font-semibold mb-4">মূল্যায়ন সেটআপ</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">টাস্ক নির্বাচন করুন</label>
                                        <select id="evaluationTaskSelect" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="">একটি টাস্ক নির্বাচন করুন</option>
                                            <!-- Tasks will be dynamically added here -->
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">গ্রুপ নির্বাচন করুন</label>
                                        <select id="evaluationGroupSelect" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="">একটি গ্রুপ নির্বাচন করুন</option>
                                            <!-- Groups will be dynamically added here -->
                                        </select>
                                    </div>
                                    <button id="startEvaluationBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">মূল্যায়ন শুরু করুন</button>
                                </div>
                            </div>

                            <!-- Evaluation Form -->
                            <div class="lg:col-span-2 bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
                                <h3 id="evaluationTitle" class="text-lg font-semibold mb-4">মূল্যায়ন ফর্ম</h3>
                                <div id="evaluationForm" class="space-y-4">
                                    <p class="text-center text-gray-500 py-8">একটি টাস্ক এবং গ্রুপ নির্বাচন করুন</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Member Evaluation Tab -->
                    <div class="tab-content" id="member-evaluation-tab">
                        <div class="bg-white dark:bg-darkCard rounded-xl shadow-md p-5">
                            <h3 class="text-lg font-semibold mb-4">সদস্য মূল্যায়ন</h3>
                            <p class="text-gray-600 dark:text-gray-400">এই ফিচারটি শীঘ্রই আসছে...</p>
                        </div>
                    </div>
                </section>

                <!-- Group Policy Page (Unchanged) -->
                <section id="page-group-policy" class="page hidden">
                    <!-- Group policy page content from update10.html -->
                </section>

                <!-- Export Page (Unchanged) -->
                <section id="page-export" class="page hidden">
                    <!-- Export page content from update10.html -->
                </section>

                <!-- Admin Management Page (Unchanged) -->
                <section id="page-admin-management" class="page hidden">
                    <!-- Admin management page content from update10.html -->
                </section>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAkw1kL7AU73Y9FWrPZ-ERv5xFvXGGILBA",
            authDomain: "claritybudget-6lnmd.firebaseapp.com",
            projectId: "claritybudget-6lnmd",
            storageBucket: "claritybudget-6lnmd.firebasestorage.app",
            messagingSenderId: "40318182466",
            appId: "1:40318182466:web:c2ce0637f8f23afa95b9db",
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
    </script>

    <!-- Application Script -->
    <script>
        // DOM Elements
        const authModal = document.getElementById("authModal");
        const appContainer = document.getElementById("appContainer");
        const loginForm = document.getElementById("loginForm");
        const registerForm = document.getElementById("registerForm");
        const showRegister = document.getElementById("showRegister");
        const showLogin = document.getElementById("showLogin");
        const loginBtn = document.getElementById("loginBtn");
        const registerBtn = document.getElementById("registerBtn");
        const googleSignInBtn = document.getElementById("googleSignInBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const themeToggle = document.getElementById("themeToggle");
        const mobileMenuBtn = document.getElementById("mobileMenuBtn");
        const sidebar = document.querySelector(".sidebar");
        const pageTitle = document.getElementById("pageTitle");
        const userInfo = document.getElementById("userInfo");
        const adminManagementSection = document.getElementById("adminManagementSection");

        // Page Elements
        const pages = document.querySelectorAll(".page");
        const navBtns = document.querySelectorAll(".nav-btn");

        // Data Management
        let groups = [];
        let students = [];
        let tasks = [];
        let evaluations = [];
        let admins = [];

        // Firebase Auth State Listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                authModal.style.display = "none";
                appContainer.classList.remove("hidden");

                db.collection("admins").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        userInfo.innerHTML = `
                            <div class="font-medium">${userData.email}</div>
                            <div class="text-xs ${userData.type === "super-admin" ? "text-accent" : "text-gray-500"}">
                                ${userData.type === "super-admin" ? "সুপার অ্যাডমিন" : "অ্যাডমিন"}
                            </div>
                        `;

                        if (userData.type === "super-admin") {
                            adminManagementSection.classList.remove("hidden");
                        }
                    }
                });

                loadGroups();
                loadStudents();
                loadTasks();
                loadAdmins();
            } else {
                authModal.style.display = "flex";
                appContainer.classList.add("hidden");
            }
        });

        // Tab Functionality
        function initializeTabs() {
            // Group Members Page Tabs
            document.querySelectorAll('#page-group-members .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    document.querySelectorAll('#page-group-members .tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Hide all tab contents
                    document.querySelectorAll('#page-group-members .tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Show selected tab content
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // Load tab specific content
                    if (tabId === 'role-assignment') {
                        loadRoleAssignmentTab();
                    }
                });
            });

            // Evaluation Page Tabs
            document.querySelectorAll('#page-evaluation .tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    document.querySelectorAll('#page-evaluation .tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    tab.classList.add('active');
                    
                    document.querySelectorAll('#page-evaluation .tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }

        // Enhanced Validation Functions
        function validateStudentGroupAssignment(studentId, groupId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return false;

            // Check if student is already in another group
            if (student.groupId && student.groupId !== groupId) {
                alert(`এই শিক্ষার্থী ইতিমধ্যেই অন্য গ্রুপে রয়েছে: ${student.name}`);
                return false;
            }

            return true;
        }

        function validateStudentRoleAssignment(studentId, role) {
            if (!role) return true; // No role is always valid

            const student = students.find(s => s.id === studentId);
            if (!student) return false;

            // Check if any other student has the same role in the same group
            const studentsInSameGroup = students.filter(s => 
                s.groupId === student.groupId && s.id !== studentId
            );

            const roleTaken = studentsInSameGroup.some(s => s.role === role);
            if (roleTaken) {
                const roleNames = {
                    'team-leader': 'টিম লিডার',
                    'time-keeper': 'টাইম কিপার', 
                    'reporter': 'রিপোর্টার',
                    'resource-manager': 'রিসোর্স ম্যানেজার',
                    'peace-maker': 'পিস মেকার'
                };
                alert(`এই দায়িত্বটি ইতিমধ্যেই গ্রুপের অন্য সদস্যের কাছে আছে: ${roleNames[role]}`);
                return false;
            }

            return true;
        }

        // Enhanced Dashboard Calculation (index.html style)
        function calculateGroupScores() {
            const groupScores = {};

            // Initialize group scores
            groups.forEach(group => {
                groupScores[group.id] = {
                    groupId: group.id,
                    groupName: group.name,
                    totalScore: 0,
                    taskCount: 0,
                    averageScore: 0,
                    taskScores: [],
                    teamworkScores: []
                };
            });

            // Calculate scores from evaluations
            evaluations.forEach(evaluation => {
                const groupId = evaluation.groupId;
                const task = tasks.find(t => t.id === evaluation.taskId);

                if (!task || !groupScores[groupId]) return;

                let totalTaskScore = 0;
                let totalTeamworkScore = 0;
                let studentCount = 0;

                if (evaluation.scores) {
                    Object.values(evaluation.scores).forEach(score => {
                        totalTaskScore += score.taskScore;
                        totalTeamworkScore += score.teamworkScore;
                        studentCount++;
                    });

                    if (studentCount > 0) {
                        const avgTaskScore = totalTaskScore / studentCount;
                        const avgTeamworkScore = totalTeamworkScore / studentCount;

                        // index.html style calculation: (task + teamwork) × 5
                        const totalScore = (avgTaskScore + avgTeamworkScore) * 5;

                        groupScores[groupId].totalScore += totalScore;
                        groupScores[groupId].taskCount++;
                        groupScores[groupId].taskScores.push(avgTaskScore);
                        groupScores[groupId].teamworkScores.push(avgTeamworkScore);
                    }
                }
            });

            // Calculate average scores
            Object.keys(groupScores).forEach(groupId => {
                if (groupScores[groupId].taskCount > 0) {
                    groupScores[groupId].averageScore = 
                        groupScores[groupId].totalScore / groupScores[groupId].taskCount;
                }
            });

            return groupScores;
        }

        // Enhanced Dashboard Rendering
        function renderDetailedResults(groupScores) {
            const detailedResultsContent = document.getElementById('detailedResultsContent');
            detailedResultsContent.innerHTML = '';

            const sortedGroups = Object.values(groupScores)
                .filter(score => score.taskCount > 0)
                .sort((a, b) => b.averageScore - a.averageScore);

            if (sortedGroups.length === 0) {
                detailedResultsContent.innerHTML = `
                    <p class="text-center text-gray-500 py-4">কোন মূল্যায়ন তথ্য পাওয়া যায়নি</p>
                `;
                return;
            }

            sortedGroups.forEach((group, index) => {
                const groupElement = document.createElement('div');
                groupElement.className = 'mb-6 p-4 border border-gray-200 dark:border-gray-700 rounded-lg';
                
                groupElement.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-lg">${index + 1}. ${group.groupName}</h4>
                        <span class="score-card px-3 py-1 rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 font-bold">
                            গড় স্কোর: ${Math.round(group.averageScore)}
                        </span>
                    </div>
                    
                    <div class="calculation-steps bg-gray-50 dark:bg-gray-800 rounded-lg p-3">
                        <h5 class="font-medium mb-2">স্কোর ক্যালকুলেশন:</h5>
                        ${group.taskScores.map((taskScore, i) => `
                            <div class="calculation-step">
                                টাস্ক ${i + 1}: (${taskScore.toFixed(1)} + ${group.teamworkScores[i].toFixed(1)}) × 5 = 
                                ${((taskScore + group.teamworkScores[i]) * 5).toFixed(1)}
                            </div>
                        `).join('')}
                        <div class="calculation-step font-semibold mt-2">
                            মোট স্কোর: ${group.totalScore.toFixed(1)} ÷ ${group.taskCount} = ${group.averageScore.toFixed(1)}
                        </div>
                    </div>
                `;
                
                detailedResultsContent.appendChild(groupElement);
            });
        }

        // Role Assignment Tab
        function loadRoleAssignmentTab() {
            const activeGroup = document.querySelector('.group-bar.active');
            if (!activeGroup) {
                document.getElementById('roleAssignmentContent').innerHTML = `
                    <p class="text-center text-gray-500 py-8">একটি গ্রুপ নির্বাচন করুন</p>
                `;
                return;
            }

            const groupId = activeGroup.getAttribute('data-id');
            const groupStudents = students.filter(student => student.groupId === groupId);

            if (groupStudents.length === 0) {
                document.getElementById('roleAssignmentContent').innerHTML = `
                    <p class="text-center text-gray-500 py-8">এই গ্রুপে কোন সদস্য নেই</p>
                `;
                return;
            }

            let roleAssignmentHTML = `
                <div class="mb-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        প্রতিটি দায়িত্ব শুধুমাত্র একজন সদস্য পেতে পারেন
                    </p>
                </div>
                <div class="space-y-4">
            `;

            const availableRoles = [
                { value: 'team-leader', label: 'টিম লিডার', color: 'team-leader' },
                { value: 'time-keeper', label: 'টাইম কিপার', color: 'time-keeper' },
                { value: 'reporter', label: 'রিপোর্টার', color: 'reporter' },
                { value: 'resource-manager', label: 'রিসোর্স ম্যানেজার', color: 'resource-manager' },
                { value: 'peace-maker', label: 'পিস মেকার', color: 'peace-maker' }
            ];

            availableRoles.forEach(role => {
                const studentWithRole = groupStudents.find(s => s.role === role.value);
                
                roleAssignmentHTML += `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <span class="member-role-badge ${role.color}">${role.label}</span>
                            <span class="text-sm text-gray-500">
                                ${studentWithRole ? 'দায়িত্বপ্রাপ্ত' : 'অবস্থান খালি'}
                            </span>
                        </div>
                        <select class="role-select w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 dark:bg-gray-700" data-role="${role.value}">
                            <option value="">কোন সদস্য নির্বাচন করুন</option>
                            ${groupStudents.map(student => `
                                <option value="${student.id}" ${student.role === role.value ? 'selected' : ''}>
                                    ${student.name} (${student.roll})
                                </option>
                            `).join('')}
                        </select>
                        ${studentWithRole ? `
                            <div class="mt-2 text-sm text-green-600 dark:text-green-400">
                                বর্তমান: ${studentWithRole.name} (${studentWithRole.roll})
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            roleAssignmentHTML += `
                </div>
                <div class="mt-4">
                    <button id="saveRolesBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        দায়িত্ব সংরক্ষণ করুন
                    </button>
                </div>
            `;

            document.getElementById('roleAssignmentContent').innerHTML = roleAssignmentHTML;

            // Add event listener for save button
            document.getElementById('saveRolesBtn').addEventListener('click', () => {
                saveRoleAssignments(groupId);
            });
        }

        // Save Role Assignments
        function saveRoleAssignments(groupId) {
            const roleSelects = document.querySelectorAll('.role-select');
            const updates = [];
            const assignedRoles = new Set();

            showLoading();

            roleSelects.forEach(select => {
                const role = select.getAttribute('data-role');
                const studentId = select.value;

                if (studentId) {
                    // Validate role assignment
                    if (assignedRoles.has(studentId)) {
                        alert('একজন সদস্য একাধিক দায়িত্ব পেতে পারেন না');
                        hideLoading();
                        return;
                    }

                    if (!validateStudentRoleAssignment(studentId, role)) {
                        hideLoading();
                        return;
                    }

                    assignedRoles.add(studentId);
                    updates.push(
                        db.collection('students').doc(studentId).update({
                            role: role
                        })
                    );
                }
            });

            Promise.all(updates)
                .then(() => {
                    hideLoading();
                    alert('দায়িত্ব বণ্টন সফলভাবে সংরক্ষণ করা হয়েছে');
                    loadStudents();
                    loadGroupMembers(groupId);
                    loadRoleAssignmentTab();
                })
                .catch(error => {
                    hideLoading();
                    alert('দায়িত্ব বণ্টন সংরক্ষণ করতে সমস্যা হয়েছে: ' + error.message);
                });
        }

        // Modified loadGroupMembers function with validation
        function loadGroupMembers(groupId) {
            const groupMembersList = document.getElementById('groupMembersList');
            const selectedGroupTitle = document.getElementById('selectedGroupTitle');

            const group = groups.find(g => g.id === groupId);
            if (!group) return;

            selectedGroupTitle.textContent = `${group.name} - গ্রুপ সদস্য`;

            const groupStudents = students.filter(student => student.groupId === groupId);
            groupMembersList.innerHTML = '';

            if (groupStudents.length === 0) {
                groupMembersList.innerHTML = '<p class="text-center text-gray-500 py-8">এই গ্রুপে কোন সদস্য নেই</p>';
                return;
            }

            groupStudents.forEach(student => {
                const memberElement = document.createElement('div');
                memberElement.className = 'flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
                
                let roleBadge = '';
                if (student.role) {
                    const roleNames = {
                        'team-leader': 'টিম লিডার',
                        'time-keeper': 'টাইম কিপার',
                        'reporter': 'রিপোর্টার',
                        'resource-manager': 'রিসোর্স ম্যানেজার',
                        'peace-maker': 'পিস মেকার'
                    };
                    roleBadge = `<span class="member-role-badge ${student.role} ml-2">${roleNames[student.role]}</span>`;
                }

                memberElement.innerHTML = `
                    <div>
                        <div class="font-medium">${student.name} ${roleBadge}</div>
                        <div class="text-sm text-gray-500">রোল: ${student.roll} | লিঙ্গ: ${student.gender} | সেশন: ${student.session}</div>
                        <div class="text-sm text-gray-500">যোগাযোগ: ${student.contact}</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="assign-role-btn px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg text-sm" data-id="${student.id}">দায়িত্ব নির্ধারণ</button>
                        <button class="remove-from-group-btn px-3 py-1 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg text-sm" data-id="${student.id}">গ্রুপ থেকে সরান</button>
                    </div>
                `;
                groupMembersList.appendChild(memberElement);
            });

            // Add event listeners with validation
            document.querySelectorAll('.assign-role-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const studentId = btn.getAttribute('data-id');
                    assignRole(studentId, groupId);
                });
            });

            document.querySelectorAll('.remove-from-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const studentId = btn.getAttribute('data-id');
                    removeFromGroup(studentId, groupId);
                });
            });
        }

        // Modified removeFromGroup function
        function removeFromGroup(studentId, groupId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            document.getElementById('deleteModalText').textContent = 
                `আপনি কি নিশ্চিত যে আপনি "${student.name}" কে এই গ্রুপ থেকে সরাতে চান?`;
            document.getElementById('deleteModal').style.display = 'flex';

            document.getElementById('confirmDelete').onclick = () => {
                showLoading();
                db.collection('students').doc(studentId).update({
                    groupId: '',
                    role: '' // Remove role when removing from group
                })
                .then(() => {
                    hideLoading();
                    document.getElementById('deleteModal').style.display = 'none';
                    loadStudents();
                    loadGroupMembers(groupId);
                    loadAllStudentsCards();
                    loadRoleAssignmentTab();
                })
                .catch(error => {
                    hideLoading();
                    alert('শিক্ষার্থীকে গ্রুপ থেকে সরাতে সমস্যা হয়েছে: ' + error.message);
                });
            };
        }

        // Modified addStudent function with validation
        document.getElementById('addStudentBtn').addEventListener('click', () => {
            const name = document.getElementById('studentNameInput').value.trim();
            const roll = document.getElementById('studentRollInput').value.trim();
            const gender = document.getElementById('studentGenderInput').value;
            const groupId = document.getElementById('studentGroupInput').value;
            const academicGroup = document.getElementById('studentAcademicGroupInput').value;
            const contact = document.getElementById('studentContactInput').value.trim();
            const session = document.getElementById('studentSessionInput').value.trim();

            if (name && roll && gender && groupId && contact && session) {
                // Validate if student already exists in any group with same roll
                const existingStudent = students.find(s => s.roll === roll && s.groupId);
                if (existingStudent) {
                    alert(`এই রোল নম্বরের শিক্ষার্থী ইতিমধ্যেই অন্য গ্রুপে রয়েছে: ${existingStudent.name}`);
                    return;
                }

                if (!validateStudentGroupAssignment('new', groupId)) {
                    return;
                }

                showLoading();
                db.collection('students').add({
                    name: name,
                    roll: roll,
                    gender: gender,
                    groupId: groupId,
                    academicGroup: academicGroup,
                    contact: contact,
                    session: session,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                })
                .then(() => {
                    hideLoading();
                    // Clear form
                    document.getElementById('studentNameInput').value = '';
                    document.getElementById('studentRollInput').value = '';
                    document.getElementById('studentGenderInput').value = '';
                    document.getElementById('studentGroupInput').value = '';
                    document.getElementById('studentContactInput').value = '';
                    document.getElementById('studentSessionInput').value = '';

                    loadStudents();
                    loadAllStudentsCards();
                })
                .catch(error => {
                    hideLoading();
                    alert('শিক্ষার্থী যোগ করতে সমস্যা হয়েছে: ' + error.message);
                });
            } else {
                alert('সমস্ত তথ্য পূরণ করুন');
            }
        });

        // Enhanced Dashboard Loading
        function loadDashboard() {
            db.collection('evaluations').get().then(querySnapshot => {
                evaluations = [];
                querySnapshot.forEach(doc => {
                    evaluations.push({ id: doc.id, ...doc.data() });
                });

                const groupScores = calculateGroupScores();
                renderTopGroups(groupScores);
                renderGroupsRanking(groupScores);
                renderDetailedResults(groupScores);
            }).catch(error => {
                console.error('Error loading evaluations: ', error);
            });
        }

        // Initialize the application
        function initApp() {
            // Existing initialization code...
            initializeTabs();
        }

        // Start the application
        initApp();

        // Rest of the existing JavaScript code from update10.html...
        // (All the existing functions like loadGroups, loadStudents, etc. should be included here)

    </script>

    <!-- JSZip for exporting all data as zip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>